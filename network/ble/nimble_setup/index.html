<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://mynewt.apache.org/network/ble/nimble_setup/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">

	<title>Set up application - Apache Mynewt</title>

        <link href="../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <link href="../../../css/base.css" rel="stylesheet">
        <link href="../../../css/custom.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900,300,100' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'mynewt.incubator.apache.org');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Set up application">


        <div id="navbar" class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="logo-container">
        <img src="/img/logo.svg">
    </div>
    <div class="container-fluid">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li class="dropdown">
                    <a href="/documentation/" class="dropdown-toggle" data-toggle="dropdown">Docs <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        
                        
                        
                        
                        <li >
                            <a href="../../../documentation/">
                                Overview
                            </a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="active">
                            <a href="../../../os/get_started/introduction/">
                                Mynewt OS Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../newt/newt_intro/">
                                Newt Tool Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../newtmgr/overview/">
                                Newt Manager Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../os/tutorials/how_to_edit_docs/">
                                Appendix
                            </a>
                        </li>
                        
                        
                    </ul>
                </li>
                <li>
                    <a href="/download/">Download</a>
                </li>
                <li>
                    <a href="/community/">Community</a>
                </li>
                <li>
                    <a href="/events/">Events</a>
                </li>
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
    </div>
</div>

        

        <div class="container-fluid">
            
                <div class="row sm-extra-padding">
                    <div id="docSidebar" class="col-md-3 bg-grey sidebar-container"><div class="bs-sidebar hidden-print" role="complementary">
    <div class="sidebar-top">
        <img class="hidden-xs hidden-sm logo-small" src="/img/logo.svg" alt="MyNewt" title="MyNewt">
        <div class="small" role="search">
            <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" placeholder="Search documentation" />
                    <button class="search-button" type="submit"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>
    <ul class="nav bs-sidenav">
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  
    <li><a href="
  ../../../os/get_started/introduction/
">Mynewt OS Manual</a>
  
    
      <ul class="current-toc">
          
              
                
  
    <li>
      <a href="../../../os/get_started/introduction/">Introduction</a>
    </li>
  

              
          
              
                
  
  
    <li ><a href="../../../os/get_started/get_started/">Quick Start</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../os/get_started/vocabulary/">Concepts</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../os/tutorials/tutorials/">Tutorials</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../os/os_user_guide/">OS User Guide</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../ble_intro/

">Networking User Guide</a>
  
    
      <ul class="current-toc">
          
              
                
  
  
    <li ><a href="../ble_intro/">NimBLE - Mynewt BLE Stack</a></li>
  
    
      <ul class="current-toc">
          
              
          
              
                
  
    <li class="active">
      Set up application
    </li>
  

              
          
              
                
  
  
    <li ><a href="../ini_stack/ble_ini_intro/">Initialize stack</a></li>
  
    
  </li>

              
          
      </ul>
    
  </li>

              
          
      </ul>
    
  </li>

              
          
      </ul>
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../newt/newt_intro/
">Newt Tool Manual</a>
  
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../newtmgr/overview/
">Newt Manager Manual</a>
  
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../os/tutorials/how_to_edit_docs/
">Appendix</a>
  
    
  </li>

        
      
    </ul>
</div></div>

                    <div class="show-sidebar-container">
                        <button class="show-sidebar">Docs Menu</button>
                    </div>

                    <div class="col-md-offset-3 col-md-9 documentation-viewer" role="main">
                        <div class="row doc-header">
                            <div class="col-sm-6">
                                
<ul class="nav nav-pills">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="active" role="presentation"><a href="../../../os/get_started/introduction/">Mynewt OS</a></li>
    
    
    
    <li  role="presentation"><a href="../../../newt/newt_intro/">Newt Tool</a></li>
    
    
    
    <li  role="presentation"><a href="../../../newtmgr/overview/">Newt Mgr</a></li>
    
    
    
    
</ul>
                            </div>
                            <div class="col-sm-6">
                                <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="/documentation/">Docs</a></li>
    
    
        
          <li>&raquo; Networking User Guide</li>
        
      
        
          <li>&raquo; <a href="../ble_intro/">NimBLE - Mynewt BLE Stack</a></li>
        
      
      
        <li>&raquo; Set up application</li>
      
    
    
  </ul>
</div>
                            </div>
                        </div>
                        
                            <h2 id="set-up-a-nimble-application">Set up a NimBLE application<a class="headerlink" href="#set-up-a-nimble-application" title="Permanent link">&para;</a></h2>
<p>This tutorial explains how to setup an application using the Nimble stack. The end result will be a framework that you can use to create your own BLE application using the nimble stack.</p>
<p>This tutorial assumes that you have already installed a source tree and are familiar with the newt tools and concepts.</p>
<h3 id="create-the-application-directory">Create the application directory<a class="headerlink" href="#create-the-application-directory" title="Permanent link">&para;</a></h3>
<p><This needs to be added. This should talk about how you create the pkg.yml file in the apps directory that the user will create. Also, discuss other application dir stuff></p>
<h3 id="create-the-target">Create the target<a class="headerlink" href="#create-the-target" title="Permanent link">&para;</a></h3>
<p>The first step will be to create the target that you will use to build your application. We will call this target "ble_tgt". Type the <code>newt target create ble_tgt</code> command. You should get this:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">$ newt target create ble_tgt
Target targets/ble_tgt successfully created
</pre></div>


<p>What this command just did was to create a directory called <code>ble_tgt</code> in the targets directory of your project. Two files are created in that directory: pkg.yml and target.yml.</p>
<p>The target is not yet complete though! We need to set some target variables for this project. Currently, the nimble stack has been ported to the Nordic nrf5x chipsets; specifically the nrf51 and nrf52. This application will use the nrf52 but we will also show the setup for the nrf51 in case your project uses that chip.</p>
<p>Here is the command you will need to setup your target for the nrf52:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">$ newt target set ble_tgt app=apps/ble_app          \
                          bsp=hw/bsp/nrf52pdk       \
                          build_profile=optimized
Target targets/ble_tgt successfully set target.app to apps/ble_app
Target targets/ble_tgt successfully set target.bsp to hw/bsp/nrf52pdk
Target targets/ble_tgt successfully set target.build_profile to optimized
</pre></div>


<p>Here is the command you will need to setup your target for the nrf51:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">$ newt target set ble_tgt app=apps/ble_app          \
                          bsp=hw/bsp/nrf51dk        \
                          build_profile=optimized
Target targets/ble_tgt successfully set target.app to apps/ble_app
Target targets/ble_tgt successfully set target.bsp to hw/bsp/nrf51dk
Target targets/ble_tgt successfully set target.build_profile to optimized
</pre></div>


<p><br></p>
<h3 id="nimble-stack-initialization">Nimble stack initialization<a class="headerlink" href="#nimble-stack-initialization" title="Permanent link">&para;</a></h3>
<p>We are now going to explain how to setup your application to initialize the nimble stack and to get the basic stack, and its required modules, initialized and up and running. Note that the code shown here is an example of what is required for nimble stack operation; it is not intended to dictate to the developer exactly how to organize/setup your code. For example, the code sample shows modification of main.c in the application /src folder. The developer has the flexibility to organize the code as they see fit so this code does not need to reside in /src/main.c nor in the main() function itself. The only possible issue is the order of some of the initializations. Where this order is important it is indicated in the tutorial.</p>
<p>A note about the code samples: the main() function in each code sample builds upon the previous example. However, code outside of main() shows only what we add for each step. The last code sample shows the entire main.c that we created.</p>
<p>Let's start with a very basic main() function (shown below). In this main all we are doing is initializing the Mynewt OS and starting it.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">#include &quot;os/os.h&quot;</span>

<span style="color: #A90D91">int</span>
<span style="color: #000000">main</span>(<span style="color: #A90D91">void</span>)
{
    <span style="color: #177500">/* Initialize OS */</span>
    <span style="color: #000000">os_init</span>();

    <span style="color: #177500">/* Start the OS */</span>
    <span style="color: #000000">os_start</span>();

    <span style="color: #177500">/* os start should never return. If it does, this should be an error */</span>
    <span style="color: #000000">assert</span>(<span style="color: #1C01CE">0</span>);
}
</pre></div>


<p>The Nimble stack requires a number of packages/modules to be initialized prior to being initialized. We are going to add these one by one to the application and describe each.</p>
<p><br></p>
<h4 id="add-cputime">Add cputime<a class="headerlink" href="#add-cputime" title="Permanent link">&para;</a></h4>
<p>The Nimble stack requires "cputime". This is provided by the Mynewt HAL of the
same name. The cputime HAL provides a high resolution timer that is used by the
nimble stack (as the BLE specification requires a fairly high resolution timer
and has fairly tight timing requirements). The cputime HAL allows the user to
specify the timer resolution as different applications may require a different
resolution. While the Nimble stack does not require a specific timer resolution
per se, a resolution that is too large may affect performance and power
efficiency. A suggested clock rate for HAL cputime for the nimble stack is 1
MHz, or 1 microsecond per cputime tick. This provides enough resolution for
most needs while providing the Nimble stack enough resolution to implement the
BLE specification.</p>
<p>Add the initialization of cputime to your application:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="background-color: #ffffcc"><span style="color: #633820">#include &quot;hal/hal_cputime.h&quot;</span>
</span>
<span style="color: #A90D91">int</span>
<span style="color: #000000">main</span>(<span style="color: #A90D91">void</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;

    <span style="color: #177500">/* Initialize OS */</span>
    <span style="color: #000000">os_init</span>();

<span style="background-color: #ffffcc">    <span style="color: #177500">/* Set cputime to count at 1 usec increments */</span>
</span><span style="background-color: #ffffcc">    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">cputime_init</span>(<span style="color: #1C01CE">1000000</span>);
</span><span style="background-color: #ffffcc">    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);
</span>
    <span style="color: #177500">/* Start the OS */</span>
    <span style="color: #000000">os_start</span>();

    <span style="color: #177500">/* os start should never return. If it does, this should be an error */</span>
    <span style="color: #000000">assert</span>(<span style="color: #1C01CE">0</span>);
}
</pre></div>


<p><br></p>
<h4 id="create-the-system-memory-buffer-pool">Create the system memory buffer pool<a class="headerlink" href="#create-the-system-memory-buffer-pool" title="Permanent link">&para;</a></h4>
<p>The Nimble stack allocates packet buffers (called mbufs) from the system memory buffer pool (msys). The system memory buffer pool and mbufs are described in the OS manual; we suggest reading that section in order to become familiar with mbufs if you are not already familiar with them. Note that the application itself (the unique application code that you are writing) does not need to use mbufs and none of the BLE host API exposed to the application developer uses them. However, the Nimble stack does require the existence of the system memory pool.</p>
<p>Creating the memory pool and registering it with the system memory buffer pool can be a bit tricky the first time. However, using the template provided below it should be much easier. The header file /net/nimble/include/nimble/ble.h, which should be included in main.c, contains some MBUF macros that you will need to create the memory pool used by msys. The macro <code>BLE_MBUF_PAYLOAD_SIZE</code> defines the maximum amount of user payload, plus overhead, that a link layer BLE PDU can contain. The macro <code>BLE_MBUF_MEMBLOCK_OVERHEAD</code> is the amount of overhead required by the Nimble stack in each memory block used by the mbuf pool. The macro <code>MBUF_NUM_MBUFS</code> defines the number of mbufs in the mbuf pool and is defined locally. The user must determine, based on application requirements and platform memory size, how many mbufs are required. For example, if your application expects to have many simultaneous connections you may want to increase the size of the mbuf pool. In the example below, we assume you are only using a small number of active connections (2 to 3).</p>
<p>A note about the size of the mbufs and <code>BLE_MBUF_PAYLOAD_SIZE</code>. Msys allows for multiple mbuf pools of various size. Currently, the Nimble stack requires that msys has an mbuf pool registered that can accommodate the maximum size BLE LL PDU. Thus, we only show the creation of one mbuf pool of maximum size mbufs which gets registered to the system mbuf memory pool. We plan on modifying the Nimble stack so that smaller mbufs can be used (to conserve memory) but at this point in time you cannot modify <code>BLE_MBUF_PAYLOAD_SIZE</code>. Furthermore, you cannot add a mbuf pool of smaller size elements to the msys pool as the msys code might then allocate a mbuf that is too small for the nimble stack.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="background-color: #ffffcc"><span style="color: #177500">/* Create a mbuf pool of BLE mbufs */</span>
</span><span style="background-color: #ffffcc"><span style="color: #633820">#define MBUF_NUM_MBUFS      (8)</span>
</span><span style="background-color: #ffffcc"><span style="color: #633820">#define MBUF_BUF_SIZE       OS_ALIGN(BLE_MBUF_PAYLOAD_SIZE, 4)</span>
</span><span style="background-color: #ffffcc"><span style="color: #633820">#define MBUF_MEMBLOCK_SIZE  (MBUF_BUF_SIZE + BLE_MBUF_MEMBLOCK_OVERHEAD)</span>
</span><span style="background-color: #ffffcc"><span style="color: #633820">#define MBUF_MEMPOOL_SIZE   OS_MEMPOOL_SIZE(MBUF_NUM_MBUFS, MBUF_MEMBLOCK_SIZE)</span>
</span><span style="background-color: #ffffcc">
</span><span style="background-color: #ffffcc"><span style="color: #A90D91">struct</span> <span style="color: #000000">os_mbuf_pool</span> <span style="color: #000000">g_mbuf_pool</span>;
</span><span style="background-color: #ffffcc"><span style="color: #A90D91">struct</span> <span style="color: #000000">os_mempool</span> <span style="color: #000000">g_mbuf_mempool</span>;
</span><span style="background-color: #ffffcc"><span style="color: #A90D91">os_membuf_t</span> <span style="color: #000000">g_mbuf_buffer</span>[<span style="color: #000000">MBUF_MEMPOOL_SIZE</span>];
</span>
<span style="color: #A90D91">int</span>
<span style="color: #000000">main</span>(<span style="color: #A90D91">void</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;

    <span style="color: #177500">/* Initialize OS */</span>
    <span style="color: #000000">os_init</span>();

    <span style="color: #177500">/* Set cputime to count at 1 usec increments */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">cputime_init</span>(<span style="color: #1C01CE">1000000</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

<span style="background-color: #ffffcc">    <span style="color: #177500">/* Create memory pool for Nimble packets and register with Msys */</span>
</span><span style="background-color: #ffffcc">    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mempool_init</span>(<span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_NUM_MBUFS</span>,
</span><span style="background-color: #ffffcc">            <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>, <span style="color: #000000">&amp;g_mbuf_buffer</span>[<span style="color: #1C01CE">0</span>], <span style="color: #C41A16">&quot;mbuf_pool&quot;</span>);
</span><span style="background-color: #ffffcc">    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);
</span><span style="background-color: #ffffcc">
</span><span style="background-color: #ffffcc">    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mbuf_pool_init</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>, <span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>,
</span><span style="background-color: #ffffcc">                           <span style="color: #000000">MBUF_NUM_MBUFS</span>);
</span><span style="background-color: #ffffcc">    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);
</span><span style="background-color: #ffffcc">
</span><span style="background-color: #ffffcc">    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_msys_register</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>);
</span><span style="background-color: #ffffcc">    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);
</span>
    <span style="color: #177500">/* Start the OS */</span>
    <span style="color: #000000">os_start</span>();

    <span style="color: #177500">/* os start should never return. If it does, this should be an error */</span>
    <span style="color: #000000">assert</span>(<span style="color: #1C01CE">0</span>);
}
</pre></div>


<p><br></p>
<h4 id="initializing-the-device-address">Initializing the device address<a class="headerlink" href="#initializing-the-device-address" title="Permanent link">&para;</a></h4>
<p>The BLE specification requires that devices have an address (called a device address). This address can be either a public device address or a random device address. The current Nimble stack implementation requires that these addresses be defined somewhere in the application; they are not defined within the Nimble stack itself. This was done so that the entire application could have access to these addresses. We expect that we will move these addresses into the Nimble stack in a future release.</p>
<p>The two variables that must be defined are named <code>g_dev_addr</code> (public device address) and <code>g_random_addr</code> (static random address). The device address must be initialized prior to initializing the Nimble stack. The random address does not have to be initialized ahead of time as it is possible to set the random address in the Nimble controller when it is running. In this example, we only initialize the device address. The company OUI in this example is 0a:bb:cc; the unique portion is 11:22:33 for a device address equal to 0a:bb:cc:11:22:33. Note that we store the address in little endian order as BLE expects the OUI to be in the most significant bytes.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="background-color: #ffffcc"><span style="color: #177500">/* Our global device address (public) */</span>
</span><span style="background-color: #ffffcc"><span style="color: #A90D91">uint8_t</span> <span style="color: #000000">g_dev_addr</span>[<span style="color: #000000">BLE_DEV_ADDR_LEN</span>];
</span><span style="background-color: #ffffcc">
</span><span style="background-color: #ffffcc"><span style="color: #177500">/* Our random address (static) */</span>
</span><span style="background-color: #ffffcc"><span style="color: #A90D91">uint8_t</span> <span style="color: #000000">g_random_addr</span>[<span style="color: #000000">BLE_DEV_ADDR_LEN</span>];
</span>
<span style="color: #A90D91">int</span>
<span style="color: #000000">main</span>(<span style="color: #A90D91">void</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;

    <span style="color: #177500">/* Initialize OS */</span>
    <span style="color: #000000">os_init</span>();

    <span style="color: #177500">/* Set cputime to count at 1 usec increments */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">cputime_init</span>(<span style="color: #1C01CE">1000000</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #177500">/* Create memory pool for Nimble packets and register with Msys */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mempool_init</span>(<span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_NUM_MBUFS</span>,
            <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>, <span style="color: #000000">&amp;g_mbuf_buffer</span>[<span style="color: #1C01CE">0</span>], <span style="color: #C41A16">&quot;mbuf_pool&quot;</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mbuf_pool_init</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>, <span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>,
                           <span style="color: #000000">MBUF_NUM_MBUFS</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_msys_register</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

<span style="background-color: #ffffcc">    <span style="color: #177500">/* Initialize our device address */</span>
</span><span style="background-color: #ffffcc">    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">0</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x33</span>;
</span><span style="background-color: #ffffcc">    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">1</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x22</span>;
</span><span style="background-color: #ffffcc">    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">2</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x11</span>;
</span><span style="background-color: #ffffcc">    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">3</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0xcc</span>;
</span><span style="background-color: #ffffcc">    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">4</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0xbb</span>;
</span><span style="background-color: #ffffcc">    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">5</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x0a</span>;
</span>
    <span style="color: #177500">/* Start the OS */</span>
    <span style="color: #000000">os_start</span>();

    <span style="color: #177500">/* os start should never return. If it does, this should be an error */</span>
    <span style="color: #000000">assert</span>(<span style="color: #1C01CE">0</span>);
}
</pre></div>


<p><br></p>
<h4 id="initializing-the-statistics-package">Initializing the statistics package<a class="headerlink" href="#initializing-the-statistics-package" title="Permanent link">&para;</a></h4>
<p>The Nimble stack uses the statistics package and this must be initialized prior to initializing the Nimble stack. Initializing the statistics package is quite simple; all you need to do is call the initialization function <code>stats_module_init()</code>.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="background-color: #ffffcc"><span style="color: #633820">#include &quot;stats/stats.h&quot;</span>
</span>
<span style="color: #A90D91">int</span>
<span style="color: #000000">main</span>(<span style="color: #A90D91">void</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;

    <span style="color: #177500">/* Initialize OS */</span>
    <span style="color: #000000">os_init</span>();

    <span style="color: #177500">/* Set cputime to count at 1 usec increments */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">cputime_init</span>(<span style="color: #1C01CE">1000000</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #177500">/* Create memory pool for Nimble packets and register with Msys */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mempool_init</span>(<span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_NUM_MBUFS</span>,
            <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>, <span style="color: #000000">&amp;g_mbuf_buffer</span>[<span style="color: #1C01CE">0</span>], <span style="color: #C41A16">&quot;mbuf_pool&quot;</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mbuf_pool_init</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>, <span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>,
                           <span style="color: #000000">MBUF_NUM_MBUFS</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_msys_register</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #177500">/* Initialize our device address */</span>
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">0</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x33</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">1</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x22</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">2</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x11</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">3</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0xcc</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">4</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0xbb</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">5</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x0a</span>;

<span style="background-color: #ffffcc">    <span style="color: #177500">/* Initialize the statistics package */</span>
</span><span style="background-color: #ffffcc">    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">stats_module_init</span>();
</span><span style="background-color: #ffffcc">    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);
</span>
    <span style="color: #177500">/* Start the OS */</span>
    <span style="color: #000000">os_start</span>();

    <span style="color: #177500">/* os start should never return. If it does, this should be an error */</span>
    <span style="color: #000000">assert</span>(<span style="color: #1C01CE">0</span>);
}
</pre></div>


<p><br></p>
<h4 id="initializing-the-console-package">Initializing the console package<a class="headerlink" href="#initializing-the-console-package" title="Permanent link">&para;</a></h4>
<p>The console is also required by the Nimble stack. The console is currently used for log output so it needs to be initialized. For this example, we are not going to use a console receive callback. All this means is that input from the console will not be accepted by default; the developer will have to install their own handler or use one provided by another package (the shell, for example). Just like statistics, the console is initialized by calling the console initialization function <code>console_init()</code>.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="background-color: #ffffcc"><span style="color: #633820">#include &quot;console/console.h&quot;</span>
</span>
<span style="color: #A90D91">int</span>
<span style="color: #000000">main</span>(<span style="color: #A90D91">void</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;

    <span style="color: #177500">/* Initialize OS */</span>
    <span style="color: #000000">os_init</span>();

    <span style="color: #177500">/* Set cputime to count at 1 usec increments */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">cputime_init</span>(<span style="color: #1C01CE">1000000</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #177500">/* Create memory pool for Nimble packets and register with Msys */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mempool_init</span>(<span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_NUM_MBUFS</span>,
            <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>, <span style="color: #000000">&amp;g_mbuf_buffer</span>[<span style="color: #1C01CE">0</span>], <span style="color: #C41A16">&quot;mbuf_pool&quot;</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mbuf_pool_init</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>, <span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>,
                           <span style="color: #000000">MBUF_NUM_MBUFS</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_msys_register</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #177500">/* Initialize our device address */</span>
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">0</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x33</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">1</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x22</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">2</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x11</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">3</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0xcc</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">4</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0xbb</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">5</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x0a</span>;

    <span style="color: #177500">/* Initialize the statistics package */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">stats_module_init</span>();
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

<span style="background-color: #ffffcc">    <span style="color: #177500">/* Init the console */</span>
</span><span style="background-color: #ffffcc">    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">console_init</span>(<span style="color: #A90D91">NULL</span>);
</span><span style="background-color: #ffffcc">    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);
</span>
    <span style="color: #177500">/* Start the OS */</span>
    <span style="color: #000000">os_start</span>();

    <span style="color: #177500">/* os start should never return. If it does, this should be an error */</span>
    <span style="color: #000000">assert</span>(<span style="color: #1C01CE">0</span>);
}
</pre></div>


<p><br></p>
<h4 id="initializing-the-nimble-controller">Initializing the Nimble controller<a class="headerlink" href="#initializing-the-nimble-controller" title="Permanent link">&para;</a></h4>
<p>The Nimble controller is initialized via a call to <code>ble_ll_init()</code>.  This function is declared as follows:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">int</span> <span style="color: #000000">ble_ll_init</span>(<span style="color: #A90D91">uint8_t</span> <span style="color: #000000">ll_task_prio</span>, <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">num_acl_pkts</span>, <span style="color: #A90D91">uint16_t</span> <span style="color: #000000">acl_pkt_size</span>)
</pre></div>


<p>This function's parameters are documented below.</p>
<table>
<thead>
<tr>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><em>prio</em></td>
<td>The priority of the Nimble controller task.  A lower number corresponds to higher priority.</td>
</tr>
<tr>
<td><em>num_acl_pkts</em></td>
<td>The maximum number of outstanding data packets that the controller will accept from the host.</td>
</tr>
<tr>
<td><em>acl_pkt_size</em></td>
<td>The maximum data packet size that the controller will accept from the host.</td>
</tr>
</tbody>
</table>
<p><strong>prio</strong>:</p>
<p>If you are not familiar with multitasking, preemptive operating systems we
highly encourage you to read the Core OS section of Mynewt OS manual. It is up
to the application developer to decide the priority of tasks in the system.
Note that the lower the priority number the higher the priority in the OS. For
example, if a task is running at priority 5 and a task at priority 3 wants to
run, the task at priority 5 gets preempted as the other task is a higher
proiority.</p>
<p>In the example shown below, the LL task is configured to have the highest
priority (priority 0). We recommend making the BLE LL task the highest priority
task in your application as it has fairly rigorous timing requirements and
allowing other tasks to preempt the LL task could cause undesirable behavior.
Note that we do not force this to be the case as an application may require a
task to be even higher priority than the LL task.  Just be warned: a task
higher in priority than the LL task should not perform actions that take too
long; even a few milliseconds could cause undesirable behavior.</p>
<p><strong>num_acl_pkts</strong> and <strong>acl_pkt_size</strong>:</p>
<p>These two parameters are used to limit the amount of data the host tries to send through the controller.  Nimble uses the msys facility for allocating data packets, so the product of these arguments must not be larger than the total amount of memory allocated for msys.  The below example uses some values that are reasonable for most uses.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="background-color: #ffffcc"><span style="color: #633820">#include &quot;controller/ble_ll.h&quot;</span>
</span>
<span style="color: #A90D91">int</span>
<span style="color: #000000">main</span>(<span style="color: #A90D91">void</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;
    <span style="color: #A90D91">struct</span> <span style="color: #000000">ble_hs_cfg</span> <span style="color: #000000">cfg</span>;

    <span style="color: #177500">/* Initialize OS */</span>
    <span style="color: #000000">os_init</span>();

    <span style="color: #177500">/* Set cputime to count at 1 usec increments */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">cputime_init</span>(<span style="color: #1C01CE">1000000</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #177500">/* Create memory pool for Nimble packets and register with Msys */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mempool_init</span>(<span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_NUM_MBUFS</span>,
            <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>, <span style="color: #000000">&amp;g_mbuf_buffer</span>[<span style="color: #1C01CE">0</span>], <span style="color: #C41A16">&quot;mbuf_pool&quot;</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mbuf_pool_init</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>, <span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>,
                           <span style="color: #000000">MBUF_NUM_MBUFS</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_msys_register</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #177500">/* Initialize our device address */</span>
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">0</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x33</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">1</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x22</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">2</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x11</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">3</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0xcc</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">4</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0xbb</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">5</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x0a</span>;

    <span style="color: #177500">/* Initialize the statistics package */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">stats_module_init</span>();
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

<span style="background-color: #ffffcc">    <span style="color: #177500">/* Initialize the BLE LL */</span>
</span><span style="background-color: #ffffcc">    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">ble_ll_init</span>(<span style="color: #1C01CE">0</span>, <span style="color: #1C01CE">7</span>, <span style="color: #1C01CE">260</span>);
</span><span style="background-color: #ffffcc">    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);
</span>
    <span style="color: #177500">/* Start the OS */</span>
    <span style="color: #000000">os_start</span>();

    <span style="color: #177500">/* os start should never return. If it does, this should be an error */</span>
    <span style="color: #000000">assert</span>(<span style="color: #1C01CE">0</span>);
}
</pre></div>


<p><br></p>
<h5 id="initializing-the-nimble-host">Initializing the Nimble host<a class="headerlink" href="#initializing-the-nimble-host" title="Permanent link">&para;</a></h5>
<p>The Nimble host is initialized via a call to <code>ble_hs_init()</code>.  This function is declared as follows:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">int</span> <span style="color: #000000">ble_hs_init</span>(<span style="color: #A90D91">uint8_t</span> <span style="color: #000000">prio</span>, <span style="color: #A90D91">struct</span> <span style="color: #000000">ble_hs_cfg</span> <span style="color: #000000">*cfg</span>)
</pre></div>


<p>The parameters are documented below.</p>
<table>
<thead>
<tr>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><em>prio</em></td>
<td>The priority of the Nimble host task.  A lower number corresponds to higher priority.</td>
</tr>
<tr>
<td><em>cfg</em></td>
<td>A pointer to the desired host configuration, or <em>NULL</em> if you want to use the default settings.</td>
</tr>
</tbody>
</table>
<p><strong>prio</strong>:</p>
<p>Unlike the controller, the host does not have any strict timing requirements.
This number should be greater than the priority of any time-critical tasks in
your application (remember, bigger number = lower priority!).  There are no
restrictions with regards to the host task's priority relative to its client
tasks.  In the below example, the host is assigned a priority of 1.</p>
<p><strong>cfg</strong>:</p>
<p>As mentioned above, passing a <em>cfg</em> value of <em>NULL</em> will initialize the Nimble
host with the default configuration.  This is convenient while familiarizing
yourself with the Nimble stack, but ultimately you will probably want to use a
custom configuration.  For more information on configuring the host, see the
Nimble Configuration Guide (TBD).</p>
<p>Continuing with our running example, we now add Nimble host initialization to the <em>main()</em> function.  This application uses the default host configuration, so it specifies <em>NULL</em> as the second argument to <code>ble_hs_init()</code>.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="background-color: #ffffcc"><span style="color: #633820">#include &quot;host/ble_hs.h&quot;</span>
</span>
<span style="color: #A90D91">int</span>
<span style="color: #000000">main</span>(<span style="color: #A90D91">void</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;
    <span style="color: #A90D91">struct</span> <span style="color: #000000">ble_hs_cfg</span> <span style="color: #000000">cfg</span>;

    <span style="color: #177500">/* Initialize OS */</span>
    <span style="color: #000000">os_init</span>();

    <span style="color: #177500">/* Set cputime to count at 1 usec increments */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">cputime_init</span>(<span style="color: #1C01CE">1000000</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #177500">/* Create memory pool for Nimble packets and register with Msys */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mempool_init</span>(<span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_NUM_MBUFS</span>,
            <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>, <span style="color: #000000">&amp;g_mbuf_buffer</span>[<span style="color: #1C01CE">0</span>], <span style="color: #C41A16">&quot;mbuf_pool&quot;</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_mbuf_pool_init</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>, <span style="color: #000000">&amp;g_mbuf_mempool</span>, <span style="color: #000000">MBUF_MEMBLOCK_SIZE</span>,
                           <span style="color: #000000">MBUF_NUM_MBUFS</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_msys_register</span>(<span style="color: #000000">&amp;g_mbuf_pool</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #177500">/* Initialize our device address */</span>
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">0</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x33</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">1</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x22</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">2</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x11</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">3</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0xcc</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">4</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0xbb</span>;
    <span style="color: #000000">g_dev_addr</span>[<span style="color: #1C01CE">5</span>] <span style="color: #000000">=</span> <span style="color: #1C01CE">0x0a</span>;

    <span style="color: #177500">/* Initialize the statistics package */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">stats_module_init</span>();
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

    <span style="color: #177500">/* Initialize the BLE LL */</span>
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">ble_ll_init</span>(<span style="color: #1C01CE">0</span>, <span style="color: #1C01CE">7</span>, <span style="color: #1C01CE">260</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);

<span style="background-color: #ffffcc">    <span style="color: #177500">/* Initialize the BLE host. */</span>
</span><span style="background-color: #ffffcc">    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">ble_hs_init</span>(<span style="color: #000000">BLE_HS_TASK_PRI</span>, <span style="color: #A90D91">NULL</span>);
</span><span style="background-color: #ffffcc">    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);
</span>
    <span style="color: #177500">/* Start the OS */</span>
    <span style="color: #000000">os_start</span>();

    <span style="color: #177500">/* os start should never return. If it does, this should be an error */</span>
    <span style="color: #000000">assert</span>(<span style="color: #1C01CE">0</span>);
}
</pre></div>


<p><br></p>
<h3 id="building-the-application">Building the application<a class="headerlink" href="#building-the-application" title="Permanent link">&para;</a></h3>
<p>Now that we have created the application and the target we can build it and test it out. The command you need to run is the newt build command with the target we created (ble_tgt). The output will show the files being compiled and linked. You should see this when all is done (except for the ... of course):</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">wes@~/dev/larva$ newt build ble_tgt
...
Archiving os.a
Compiling cons_fmt.c
Compiling cons_tty.c
Archiving full.a
Linking ble_app.elf
App successfully built: /Users/wes/dev/larva/bin/ble_tgt/apps/ble_app/ble_app.elf
</pre></div>


<h3 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h3>
<p>You now have a fully functional BLE app (never mind the fact that it doesn't
actually do anything yet!).  With all the necessary infrastructure in place,
you can now start turning this into a real applicaiton.  Additional tutorials
with focus on adding application-layer functionality to your Nimble application
will be coming soon.  In the meantime, you might get some inspiration from
apache-mynewt-core's example Nimble apps.  These apps can be found at the below locations, relative to your project's base directory:</p>
<ul>
<li><em>repos/apache-mynewt-core/apps/bleprph</em></li>
<li><em>repos/apache-mynewt-core/apps/bletiny</em></li>
</ul>
                        
                        <div class="row">
                            



<ul class="nav nav-pills" style="margin-bottom: 10px">
    <li>
    
    <a href=../ble_intro/>
        <span class="fa fa-arrow-left"></span>
        Previous: NimBLE - Mynewt BLE Stack
    </a>
    
    </li>
    <li class="pull-right">
    
    <a href=../ini_stack/ble_ini_intro/>
        Next: Initialize stack
        <span class="fa fa-arrow-right"></span>
    </a>
    
    </li>
</ul>
                        </div>
                        <div class="row">
                            <footer>
    <div class="row">
        <div class="col-md-12">
            
                <p class="copyright">Copyright &copy; 2015 The Apache Software Foundation, Licensed under the Apache License, Version 2.0 Apache and the Apache feather logo are trademarks of The Apache Software Foundation.<br>The Apache Software Foundation Apache Incubator</p>
            
        </div>
    </div>
    <div class="copyright-logos">
        <div class="row">
            <div class="col-xs-6 text-right">
                <img src="/img/apache-feather.png" alt="Apache" title="Apache">
            </div>
            <div class="col-xs-6 text-left">
                <img src="/img/apache-logo.png" alt="Apache Incubator" title="Apache Incubator">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
        </div>
    </div>
</footer>
                        </div>
                    </div>
                </div>
            
            
        </div>

        <script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script>
        <script src="../../../js/base.js"></script>
        <script src="../../../js/custom.js"></script>

    </body>
</html>