<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <!-- This is broken by doc revisioning.
        <link rel="canonical" href="http://mynewt.apache.org/os/tutorials/air_quality_sensor/"> -->
        <link rel="shortcut icon" href="../../../img/favicon.ico">

	    <title>Basic Air Quality Sensor - Apache Mynewt</title>

        <link href="../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <link href="../../../css/base.css" rel="stylesheet">
        <link href="../../../css/custom.css" rel="stylesheet">
        <link href="../../../css/v2.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'auto');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Basic Air Quality Sensor">


        <div class="container">
    <div class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
                <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.0.0</a> released (March 22, 2017)
            </div>
        </div>
    </div>
</div>

        






<nav id="navbar" class="navbar navbar-inverse affix-top" data-spy="affix" data-offset-top="150" role="navigation">
    <div class="container">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li 
  class=""
>
                    <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                </li>
                <li 
  class="important"
>
                    <a href="/quick-start/">Quick Start</a>
                </li>
                <li 
  class=""
>
                    <a href="/about/">About</a>
                </li>
                <li 
  class=""
>
                    <a href="/talks/">Talks</a>
                </li>
                <li 
  class="active"
>
                    <a href="/latest/os/introduction">Documentation</a>
                </li>
                <li 
  class=""
>
                    <a href="/download/">Download</a>
                </li>
                <li 
  class=""
>
                    <a href="/community/">Community</a>
                </li>
                <li 
  class=""
>
                    <a href="/events/">Events</a>
                </li>
            </ul>

        </div>
    </div>
</nav>

        

        <div class="container">
            
                <div class="row">
                    <div class="col-md-3 v2-sidebar sidebar-container"><div id="docSidebar" class="hidden-print" role="complementary">
    <div class="top">
        <div role="search">
            <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" class="form-control" placeholder="Search documentation" />
                </div>
            </form>
        </div>
    </div>
    <ul class="toc-nav">
      <li class="doc-version">
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
    
    <option
      value="/develop/os/introduction"
      
    >
      Version: develop (latest)
    </option>
    
    <option
      value="/v0_9_0/os/introduction"
      
    >
      Version: 0.9.0
    </option>
    
    <option
      value="/v1_0_0/os/introduction"
      selected="selected"
    >
      Version: 1.0.0
    </option>
    
</select>
</li>
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  
    <li ><a href="../../introduction/">Mynewt Documentation</a>
  
  
    <ul>
          
              
          
              
                
  
  
    <li ><a href="../../get_started/get_started/">Basic Setup</a>
  
  
    </li>

              
          
              
                
    <li >
      <a href="../../get_started/vocabulary/">Concepts</a>
    </li>

              
          
              
                
  
  
    <li ><a href="../tutorials/">Tutorials</a>
  
  
    <ul>
          
              
          
              
                
  
  
    <li ><a href="../blinky/">Project Blinky</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../repo/add_repos/">Work with repositories</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../project-slinky/">Project Slinky for Remote Comms</a>
  
  
    </li>

              
          
              
                
    <li >
      <a href="../ibeacon/">BLE iBeacon</a>
    </li>

              
          
              
                
    <li >
      <a href="../eddystone/">BLE Eddystone</a>
    </li>

              
          
              
                
    <li >
      <a href="../add_newtmgr/">Enable Newt Manager in any app</a>
    </li>

              
          
              
                
    <li >
      <a href="../add_shell/">Enable the OS Shell and Console</a>
    </li>

              
          
              
                
    <li >
      <a href="../tasks_lesson/">Tasks and Priority Management</a>
    </li>

              
          
              
                
    <li >
      <a href="../wi-fi_on_arduino/">Enable Wi-Fi on Arduino MKR1000</a>
    </li>

              
          
              
                
    <li >
      <a href="../unit_test/">Write a Test Suite for a Package</a>
    </li>

              
          
              
                
    <li >
      <a href="../event_queue/">Events and Event Queues</a>
    </li>

              
          
              
                
    <li >
      <a href="../bletiny_project/">BLE app to check stats via console</a>
    </li>

              
          
              
                
  
  
    <li ><a href="../bleprph/bleprph-intro/">BLE peripheral project</a>
  
  
    </li>

              
          
              
                
    <li >
      <a href="../blehci_project/">BLE HCI interface</a>
    </li>

              
          
              
                
  
  
    <li><a href="
  ./
">Air-quality Sensor project</a>
  
  
    <ul>
          
              
                
    <li class="active">
      <a href="./">Basic Air Quality Sensor</a>
    </li>

              
          
              
                
    <li >
      <a href="../air_quality_ble/">BLE-enabled Air Quality Sensor</a>
    </li>

              
          
    </ul>
  
    </li>

              
          
              
                
    <li >
      <a href="../nrf52_adc/">Add an Analog Sensor</a>
    </li>

              
          
    </ul>
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../os_user_guide/">OS User Guide</a>
  
  
    </li>

              
          
              
                
  
  
    <li><a href="
  ../../../network/ble/ble_intro/
">BLE User Guide</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../newt/newt_intro/">Newt Tool Guide</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../newtmgr/overview/">Newt Manager Guide</a>
  
  
    </li>

              
          
    </ul>
  
    </li>

        
      
        
          
  
  
    <li><a href="
  ../../../faq/go_env/
">Appendix</a>
  
  
    </li>

        
      
    </ul>
</div></div>

                    <div class="col-md-9" role="main">
                        <div class="doc-header">
                            <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="/v1_0_0/os/introduction">Docs</a></li>
    
    
        
          <li>&raquo; <a href="../tutorials/">Tutorials</a></li>
        
      
        
          <li>&raquo; Air-quality Sensor project</li>
        
      
      
        <li>&raquo; Basic Air Quality Sensor</li>
      
    
    
  </ul>
</div>
                        </div>
                        
                            <h2 id="air-quality-sensor-project">Air quality sensor project</h2>
<h3 id="setting-up-source-tree-for-stuff-you-need">Setting up source tree for stuff you need</h3>
<p>To start with, you need to create a new project under which you will do this development. So you type in:</p>
<pre class="codehilite"><code class="language-no-highlight">    $ mkdir $HOME/src
    $ cd $HOME/src
    $ newt new air_quality</code></pre>


<p>Let's say you are using Arduino Primo -- which is based on the Nordic Semi NRF52 chip -- as the platform. 
You know you need the board support package for that hardware. You can look up its location, add it your 
project, and fetch that along with the core OS components. Luckily, the Arduino Primo is supported in the 
Mynewt Core, so there's nothing much to do here. </p>
<p>Your project.yml file should look like this:</p>
<pre class="codehilite"><code class="language-no-highlight">    [user@IsMyLaptop:~/src/air_quality]$ emacs project.yml &amp;
    [user@IsMyLaptop:~/src/air_quality]$ cat project.yml
    project.name: &quot;air_quality&quot;

    project.repositories:
        - apache-mynewt-core

    # Use github's distribution mechanism for core ASF libraries.
    # This provides mirroring automatically for us.
    #
    repository.apache-mynewt-core:
        type: github
        vers: 0-latest
        user: apache
        repo: incubator-mynewt-core

    [user@IsMyLaptop:~/src/air_quality]$ newt install
    apache-mynewt-core
    [user@IsMyLaptop:~/src/air_quality]$ ls repos/
    apache-mynewt-core</code></pre>


<p>Good. You want to make sure you have all the needed bits for supporting your board; 
so you decide to build the blinky project for the platform first.</p>
<p>Now create a target for it and build it. Easiest way to proceed is to copy the existing target for blinky, and modify it to build for Arduino Primo board.</p>
<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ newt target copy my_blinky_sim blink_primo
Target successfully copied; targets/my_blinky_sim --&gt; targets/blink_primo
[user@IsMyLaptop:~/src/air_quality]$ newt target set blink_primo bsp=@apache-mynewt-core/hw/bsp/arduino_primo_nrf52
Target targets/blink_nrf successfully set target.bsp to @apache-mynewt-core/hw/bsp/arduino_primo_nrf52
[user@IsMyLaptop:~/src/air_quality]$ newt build blink_primo
Compiling hal_bsp.c
...
Linking blinky.elf
App successfully built: /Users/user/src/air_quality/bin/blink_primo/apps/blinky/blinky.elf</code></pre>


<p>Good.</p>
<p>You know that this platform uses bootloader, which means you have to create a target for that too.</p>
<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ newt target create boot_primo
Target targets/boot_nrf successfully created
[user@IsMyLaptop:~/src/air_quality]$ newt target show
@apache-mynewt-core/targets/unittest
    bsp=hw/bsp/native
    build_profile=debug
    compiler=compiler/sim
targets/blink_primo
    app=apps/blinky
    bsp=@apache-mynewt-core/hw/bsp/arduino_primo_nrf52
    build_profile=debug
targets/boot_primo
targets/my_blinky_sim
    app=apps/blinky
    bsp=@apache-mynewt-core/hw/bsp/native
    build_profile=debug
[user@IsMyLaptop:~/src/air_quality]$ newt target set boot_nrf bsp=@apache-mynewt-core/hw/bsp/arduino_primo_nrf52
Target targets/boot_nrf successfully set target.bsp to @apache-mynewt-core/hw/bsp/arduino_primo_nrf52
[user@IsMyLaptop:~/src/air_quality]$ newt target set boot_nrf app=@apache-mynewt-core/apps/boot
Target targets/boot_nrf successfully set target.app to @apache-mynewt-core/apps/boot
[user@IsMyLaptop:~/src/air_quality]$ newt target set boot_nrf build_profile=optimized
Target targets/boot_nrf successfully set target.build_profile to optimized</code></pre>


<p>And then build it, and load it onto the board.</p>
<pre class="codehilite"><code class="language-no-highlight">newt build boot_primo
....
Linking boot.elf
App successfully built: /Users/user/src/air_quality/bin/boot_primo/apps/boot/boot.elf
[user@IsMyLaptop:~/src/air_quality]
$ newt load boot_primo</code></pre>


<p>At this point, you may (or may not) see a bunch of error messages about not being able to connect to
your board, not being able to load the image, etc. If that's the case, and you haven't already, you
should most definitely go worth through the <a href="../blinky_primo/">blinky_primo</a> tutorial so that you
can properly communicate with your board.</p>
<p>Next you must download the targets to board, and see that the LED actually blinks. You plug in the 
Arduino Primo board to your laptop, and say:</p>
<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ newt load blink_primo
Loading app image into slot 1
Error: couldn't open /Users/user/src/air_quality/bin/blink_primo/apps/blinky/blinky.img

Error: exit status 1

load - Load app image to target for &lt;target-name&gt;.

Usage:
  newt load [flags]

Examples:
  newt load &lt;target-name&gt;


Global Flags:
  -l, --loglevel string   Log level, defaults to WARN. (default &quot;WARN&quot;)
  -o, --outfile string    Filename to tee log output to
  -q, --quiet             Be quiet; only display error output.
  -s, --silent            Be silent; don't output anything.
  -v, --verbose           Enable verbose output when executing commands.
exit status 1</code></pre>


<p>Ah. Forgot to create an image out of the blinky binary. Note that every time you want to build and 
load a new firmware image to a target board, you need to run 'create-image' on it.</p>
<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ newt create-image blink_primo 0.0.1
App image successfully generated: /Users/user/src/air_quality/bin/blink_primo/apps/blinky/blinky.img
Build manifest: /Users/user/src/air_quality/bin/blink_nrf/apps/blinky/manifest.json
[user@IsMyLaptop:~/src/air_quality]$ newt load blink_primo</code></pre>


<p>And it's blinking.</p>
<p>Shortcut for doing build/create-image/load/debug steps all in one is 'newt run' command. Check 
out the usage from command line help.</p>
<h3 id="create-test-project">Create test project</h3>
<p>Now that you have your system setup, you can start creating your own stuff.
First you want to create a project for yourself - you could start by using blinky as a project 
template, but since we're going to want to be able to access the data via Bluetooth, let's 
use the <code>bleprph</code> Bluetooth Peripheral project instead.</p>
<pre class="codehilite"><code class="language-no-highlight">    [user@IsMyLaptop:~/src/air_quality]$ mkdir apps/air_quality
    [user@IsMyLaptop:~/src/air_quality]$ cp repos/apache-mynewt-core/apps/bleprph/pkg.yml apps/air_quality/
    [user@IsMyLaptop:~/src/air_quality]$ cp -Rp repos/apache-mynewt-core/apps/bleprph/src apps/air_quality/</code></pre>


<p>Then you modify the apps/air_quality/pkg.yml for air_quality in order to change the <em>pkg.name</em> to be <em>apps/air_quality</em>.
You'll need to add the <code>@apache-mynewt-core/</code> path to all the package dependencies, since the app no longer
resides within the apache-mynewt-core repository.</p>
<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ cat apps/air_quality/pkg.yml
pkg.name: apps/air_quality
pkg.type: app
pkg.description: BLE Air Quality application.
pkg.author: &quot;Apache Mynewt &lt;dev@mynewt.incubator.apache.org&gt;&quot;
pkg.homepage: &quot;http://mynewt.apache.org/&quot;
pkg.keywords:

pkg.deps: 
    - &quot;@apache-mynewt-core/kernel/os&quot;
    - &quot;@apache-mynewt-core/sys/shell&quot;
    - &quot;@apache-mynewt-core/sys/stats/full&quot;
    - &quot;@apache-mynewt-core/sys/log/full&quot;
    - &quot;@apache-mynewt-core/mgmt/newtmgr&quot;
    - &quot;@apache-mynewt-core/mgmt/newtmgr/transport/ble&quot;
    - &quot;@apache-mynewt-core/net/nimble/controller&quot;
    - &quot;@apache-mynewt-core/net/nimble/host&quot;
    - &quot;@apache-mynewt-core/net/nimble/host/services/ans&quot;
    - &quot;@apache-mynewt-core/net/nimble/host/services/gap&quot;
    - &quot;@apache-mynewt-core/net/nimble/host/services/gatt&quot;
    - &quot;@apache-mynewt-core/net/nimble/host/store/ram&quot;
    - &quot;@apache-mynewt-core/net/nimble/transport/ram&quot;
    - &quot;@apache-mynewt-core/sys/console/full&quot;
    - &quot;@apache-mynewt-core/sys/sysinit&quot;
    - &quot;@apache-mynewt-core/sys/id&quot;</code></pre>


<p>And create a target for it:</p>
<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ newt target create air_q
Target targets/air_q successfully created
[user@IsMyLaptop:~/src/air_quality]$ newt target set air_q bsp=@apache-mynewt-core/hw/bsp/arduino_primo_nrf52
Target targets/air_q successfully set target.bsp to @apache-mynewt-core/hw/bsp/arduino_primo_nrf52
[user@IsMyLaptop:~/src/air_quality]$ newt target set air_q app=apps/air_quality 
Target targets/air_q successfully set target.app to apps/air_quality
[user@IsMyLaptop:~/src/air_quality]$ newt target set air_q build_profile=debug
Target targets/air_q successfully set target.build_profile to debug
[user@IsMyLaptop:~/src/air_quality]$ newt build air_q
 ....
Linking /Users/dsimmons/dev/myproj/bin/targets/air_q/app/apps/air_quality/air_quality.elf
Target successfully built: targets/air_q</code></pre>


<h3 id="create-packages-for-drivers">Create packages for drivers</h3>
<p>One of the sensors you want to enable is SenseAir K30, which will connect to the board over a serial port.
To start development of the driver, you first need to create a package description for it, and add stubs for sources.</p>
<p>The first thing to do is to create the directory structure for your driver:</p>
<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ mkdir -p libs/my_drivers/senseair/include/senseair
[user@IsMyLaptop:~/src/air_quality]$ mkdir -p libs/my_drivers/senseair/src</code></pre>


<p>Now you can add the files you need. You'll need a pkg.yml to describe the driver, and then header stub followed by source stub.</p>
<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ cat libs/my_drivers/senseair/pkg.yml</code></pre>


<pre class="codehilite"><code class="language-c">#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# &quot;License&quot;); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
# 
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
pkg.name: libs/my_drivers/senseair
pkg.description: Host side of the nimble Bluetooth Smart stack.
pkg.author: &quot;Apache Mynewt &lt;dev@mynewt.incubator.apache.org&gt;&quot;
pkg.homepage: &quot;http://mynewt.apache.org/&quot;
pkg.keywords:
    - ble
    - bluetooth

pkg.deps:
    - &quot;@apache-mynewt-core/kernel/os&quot;</code></pre>


<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ cat libs/my_drivers/senseair/include/senseair/senseair.h</code></pre>


<pre class="codehilite"><code class="language-c">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
*/
#ifndef _SENSEAIR_H_
#define _SENSEAIR_H_

void senseair_init(void);

#endif /* _SENSEAIR_H_ */</code></pre>


<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ cat libs/my_drivers/senseair/src/senseair.c</code></pre>


<pre class="codehilite"><code class="language-c">/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

void
senseair_init(void)
{
}</code></pre>


<p>And add dependency to this package in your project yml file.</p>
<p>Here's the listing from apps/air_quality/pkg.yml</p>
<pre class="codehilite"><code class="language-no-highlight">pkg.name: apps/air_quality
pkg.type: app
pkg.description: Air quality sensor test
pkg.keywords:

pkg.deps:
    - &quot;@apache-mynewt-core/libs/console/full&quot;
    - &quot;@apache-mynewt-core/libs/newtmgr&quot;
    - &quot;@apache-mynewt-core/libs/os&quot;
    - &quot;@apache-mynewt-core/libs/shell&quot;
    - &quot;@apache-mynewt-core/sys/config&quot;
    - &quot;@apache-mynewt-core/sys/log/full&quot;
    - &quot;@apache-mynewt-core/sys/stats/full&quot;
    - libs/my_drivers/senseair</code></pre>


<p>And add a call to your main() to initialize this driver.</p>
<pre class="codehilite"><code class="language-no-highlight">    [user@IsMyLaptop:~/src/air_quality]$ diff project/blinky/src/main.c project/air_quality/src/main.c
    28a29
    &gt; #include &lt;senseair/senseair.h&gt;
    190a192
    &gt; senseair_init();
    [user@IsMyLaptop:~/src/air_quality</code></pre>


<p>The ble_prph app runs everything in one task handler. For this project, we're going to add a second
task handler to respond to the shell, and then handle communicating with the senseair sensor for us.</p>
<pre class="codehilite"><code class="language-c">/** shell task settings. */
#define SHELL_TASK_PRIO           2
#define SHELL_STACK_SIZE          (OS_STACK_ALIGN(336))

struct os_eventq shell_evq;
struct os_task shell_task;
bssnz_t os_stack_t shell_stack[SHELL_STACK_SIZE];</code></pre>


<p>That defines the task, now we need to initialize it, add a task handler, and we're going to 
use this task as our default task handler.</p>
<pre class="codehilite"><code class="language-c">/**
 * Event loop for the main shell task.
 */
static void
shell_task_handler(void *unused)
{
    while (1) {
        os_eventq_run(&amp;shell_evq);
    }
}</code></pre>


<p>And in your <code>main()</code> add:</p>
<pre class="codehilite"><code class="language-c">    /* Initialize shell eventq */
    os_eventq_init(&amp;shell_evq);

    /* Create the shell task.  
     * All shell operations are performed in this task.
     */
    os_task_init(&amp;shell_task, &quot;shell&quot;, shell_task_handler,
                              NULL, SHELL_TASK_PRIO, OS_WAIT_FOREVER,
                              shell_stack, SHELL_STACK_SIZE);</code></pre>


<p>Don't forget to change your default task handler!</p>
<pre class="codehilite"><code class="language-c">    os_eventq_dflt_set(&amp;shell_evq);</code></pre>


<p>And then build it to make sure all goes well.</p>
<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ newt build air_q
Compiling senseair.c
Archiving senseair.a
Linking air_quality.elf
App successfully built: /Users/user/src/air_quality/bin/air_q/apps/air_quality/air_quality.elf</code></pre>


<p>All looks good.</p>
<h3 id="add-cli-commands-for-testing-drivers">Add CLI commands for testing drivers</h3>
<p>While developing the driver, you want to issue operations from console asking it to do stuff. We'll assume that you've already worked through the tutorial 
on how to <a href="../add_shell/">enable the CLI</a>, so all we'll need to do is add the propper values to the project's <code>syscfg.yml</code> file:</p>
<pre class="codehilite"><code class="language-no-highlight">[user@IsMyLaptop:~/src/air_quality]$ cat targets/air_q/syscfg.yml
syscfg.vals:
    # Set as per blinky_primo
    OPENOCD_DEBUG: 1
    # Enable the shell task.
    SHELL_TASK: 1
    STATS_CLI: 1
    CONSOLE_TICKS: 1
    CONSOLE_PROMPT: 1</code></pre>


<p>Then register your senseair command with the shell by adding the following to <code>libs/my_drivers/senseair/src/senseair.c</code></p>
<pre class="codehilite"><code class="language-c">#include &lt;shell/shell.h&gt;
#include &lt;console/console.h&gt;
#include &lt;assert.h&gt;


static int senseair_shell_func(int argc, char **argv);
static struct shell_cmd senseair_cmd = {
    .sc_cmd = &quot;senseair&quot;,
    .sc_cmd_func = senseair_shell_func,
};

void
senseair_init(void)
{
    int rc;

    rc = shell_cmd_register(&amp;senseair_cmd);
    assert(rc == 0);
}

static int
senseair_shell_func(int argc, char **argv)
{
    console_printf(&quot;Yay! Somebody called!\n&quot;);
    return 0;

}</code></pre>


<p>Now you can you build this, download to target, and start minicom on your console port. If you haven't already, familiarize yourself with
the tutorial on how to connect a serial port to your board <a href="../../get_started/serial_access/">here</a>.</p>
<p>You'll need to wire up your Board to a Serial converter first. On the Arduino Primo Board pin 1 is TX and pin 0 is RX so wire 1 to RX on your serial board, and 0 to TX on your serial board.</p>
<pre class="codehilite"><code class="language-no-highlight">    [user@IsMyLaptop:~]$ minicom -D /dev/tty.usbserial-AH02MIE2


    Welcome to minicom 2.7

    OPTIONS: 
    Compiled on Oct 12 2015, 07:48:30.
    Port /dev/tty.usbserial-AH02MIE2, 13:44:40

    Press CTRL-X Z for help on special keys

    ?
    419: &gt; ?
    Commands:
    641:     stat      echo         ?    prompt     ticks     tasks
    643: mempools      date  senseair
    644: &gt; senseair
    Yay! Somebody called!
    1125: &gt;
    53611: &gt; tasks
    Tasks:
    54047:    task pri tid  runtime      csw    stksz   stkuse   lcheck   ncheck flg
    54057:    idle 255   0    54048    66890       64       30        0        0   0
    54068:  ble_ll   0   1        9    64986       80       58        0        0   0
    54079: bleprph   1   2        0        1      336       32        0        0   0
    54090:   shell   2   3        0     2077      336      262        0        0   0
    54101: &gt;</code></pre>


<p>That's great. Your shell task is running, and is responding appropriately!
You can connect the hardware to your board and start developing code for the driver itself.</p>
<h3 id="use-of-hal-for-drivers">Use of HAL for drivers</h3>
<p>The sensor has a serial port connection, and that's how you are going to connect to it. Your original BSP, hw/bsp/arduino_primo_nrf52, has two UARTs set up.
We're using one for our shell/console. It also has a second UART set up as a 'bit-bang' UART but since the SenseAir only needs to
communicate at 9600 baud, this bit-banged uart is plenty fast enough.</p>
<p>You'll have to make a small change to the <code>syscfg.yml</code> file in your project's target directory to change  the pin definitions 
for this second UART. Those changes are as follows:</p>
<pre class="codehilite"><code class="language-no-highlight">    UART_0_PIN_TX: 23
    UART_0_PIN_RX: 24</code></pre>


<p>With this in place, you can refer to serial port where your SenseAir sensor by a logical number. This makes the code more platform independent - you could connect this sensor to another board, like Olimex. You will also use the HAL UART abstraction to do the UART port setup and data transfer. That way you don't need to have any platform dependent pieces within your little driver.</p>
<p>You will now see what the driver code ends up looking like. Here's the header file, filled in from the stub you created earlier.</p>
<pre class="codehilite"><code class="language-c">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
*/
#ifndef _SENSEAIR_H_
#define _SENSEAIR_H_

enum senseair_read_type {
        SENSEAIR_CO2,
};

int senseair_init(int uartno);

int senseair_read(enum senseair_read_type);

#endif /* _SENSEAIR_H_ */</code></pre>


<p>As you can see, logical UART number has been added to the init routine. A 'read' function has been added, 
which is a blocking read. If you were making a commercial product, you would probably have a callback for reporting the results.</p>
<p>And here is the source for the driver.</p>
<pre class="codehilite"><code class="language-c">/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
#include &lt;string.h&gt;

#include &lt;shell/shell.h&gt;
#include &lt;console/console.h&gt;
#include &lt;os/os.h&gt;

#include &lt;hal/hal_uart.h&gt;

#include &quot;senseair/senseair.h&quot;

static const uint8_t cmd_read_co2[] = {
    0xFE, 0X44, 0X00, 0X08, 0X02, 0X9F, 0X25
};

static int senseair_shell_func(int argc, char **argv);
static struct shell_cmd senseair_cmd = {
    .sc_cmd = &quot;senseair&quot;,
    .sc_cmd_func = senseair_shell_func,
};

struct senseair { 
    int uart;
    struct os_sem sema;
    const uint8_t *tx_data;
    int tx_off;
    int tx_len;
    uint8_t rx_data[32]; 
    int rx_off;
    int value;
} senseair;

static int
senseair_tx_char(void *arg)
{
    struct senseair *s = &amp;senseair;
    int rc;

    if (s-&gt;tx_off &gt;= s-&gt;tx_len) {
    /*
         * Command tx finished.
         */
        s-&gt;tx_data = NULL;
        return -1;
    }

    rc = s-&gt;tx_data[s-&gt;tx_off];
    s-&gt;tx_off++;
    return rc;
}

/*
 * CRC for modbus over serial port.
 */
static const uint16_t mb_crc_tbl[] = {
    0x0000, 0xcc01, 0xd801, 0x1400, 0xf001, 0x3c00, 0x2800, 0xe401,
    0xa001, 0x6c00, 0x7800, 0xb401, 0x5000, 0x9c01, 0x8801, 0x4400
};

static uint16_t
mb_crc(const uint8_t *data, int len, uint16_t crc)
{
    while (len-- &gt; 0) {
        crc ^= *data++;
        crc = (crc &gt;&gt; 4) ^ mb_crc_tbl[crc &amp; 0xf];
        crc = (crc &gt;&gt; 4) ^ mb_crc_tbl[crc &amp; 0xf];
    }
    return crc;
}

static int
mb_crc_check(const void *pkt, int len)
{
    uint16_t crc, cmp;
    uint8_t *bp = (uint8_t *)pkt;

    if (len &lt; sizeof(crc) + 1) {
        return -1;
    }
    crc = mb_crc(pkt, len - 2, 0xffff);
    cmp = bp[len - 2] | (bp[len - 1] &lt;&lt; 8);
    if (crc != cmp) {
        return -1;
    } else {
        return 0;
    }
}

static int
senseair_rx_char(void *arg, uint8_t data)
{
    struct senseair *s = (struct senseair *)arg;
    int rc;

    if (s-&gt;rx_off &gt;= sizeof(s-&gt;rx_data)) {
        s-&gt;rx_off = 0;
    }
    s-&gt;rx_data[s-&gt;rx_off] = data;
    s-&gt;rx_off++;

    if (s-&gt;rx_off == 7) {
        rc = mb_crc_check(s-&gt;rx_data, s-&gt;rx_off);
        if (rc == 0) {
            s-&gt;value = s-&gt;rx_data[3] * 256 + s-&gt;rx_data[4];
            os_sem_release(&amp;s-&gt;sema);
        }
    }
    return 0;
}

void
senseair_tx(struct senseair *s, const uint8_t *tx_data, int data_len)
{
    s-&gt;tx_data = tx_data;
    s-&gt;tx_len = data_len;
    s-&gt;tx_off = 0;
    s-&gt;rx_off = 0;

    hal_uart_start_tx(s-&gt;uart);
}

int
senseair_read(enum senseair_read_type type)
{
    struct senseair *s = &amp;senseair;
    const uint8_t *cmd;
    int cmd_len;
    int rc;

    if (s-&gt;tx_data) {
        /*
         * busy
         */
        return -1;
    }
    switch (type) {
    case SENSEAIR_CO2:
        cmd = cmd_read_co2;
        cmd_len = sizeof(cmd_read_co2);
        break;
    default:
        return -1;
    }
    senseair_tx(s, cmd, cmd_len);
    rc = os_sem_pend(&amp;s-&gt;sema, OS_TICKS_PER_SEC / 2);
    if (rc == OS_TIMEOUT) {
        /*
         * timeout
         */
        return -2;
    }
    return s-&gt;value;
}

static int
senseair_shell_func(int argc, char **argv)
{
    int value;
    enum senseair_read_type type;

    if (argc &lt; 2) {
usage:
        console_printf(&quot;%s co2\n&quot;, argv[0]);
        return 0;
    }
    if (!strcmp(argv[1], &quot;co2&quot;)) {
        type = SENSEAIR_CO2;
    } else {
        goto usage;
    }
    value = senseair_read(type);
    if (value &gt;= 0) {
        console_printf(&quot;Got %d\n&quot;, value);
    } else {
        console_printf(&quot;Error while reading: %d\n&quot;, value);
    }
    return 0;
}

int
senseair_init(int uartno)
{
    int rc;
    struct senseair *s = &amp;senseair;

    rc = shell_cmd_register(&amp;senseair_cmd);
    if (rc) {
        return rc;
    }

    rc = os_sem_init(&amp;s-&gt;sema, 1);
    if (rc) {
        return rc;
    }
    rc = hal_uart_init_cbs(uartno, senseair_tx_char, NULL,
      senseair_rx_char, &amp;senseair);
    if (rc) {
        return rc;
    }
    rc = hal_uart_config(uartno, 9600, 8, 1, HAL_UART_PARITY_NONE,
      HAL_UART_FLOW_CTL_NONE);
    if (rc) {
        return rc;
    }
    s-&gt;uart = uartno;

    return 0;
}</code></pre>


<p>And your modified main() for senseair driver init.</p>
<pre class="codehilite"><code class="language-c">int
main(int argc, char **argv)
{
    ....
    senseair_init(0);
    ....
    }</code></pre>


<p>You can see from the code that you are using the HAL interface to open a UART port, and using OS 
semaphore as a way of blocking the task when waiting for read response to come back from the sensor.</p>
<p>Now comes the fun part: Hooking up the sensor! It's fun because a) hooking up a sensor is always 
fun and b) the SenseAir sensor's PCB is entirely unlabeled, so you'll have to trust us on how to hook it up. </p>
<p>So here we go. </p>
<p>You'll have to do a little soldering. I soldered some header pins to the SenseAir K30 board to
make connecting wires easier using standard jumper wires, but you can also just solder wires
straight to the board if you prefer.</p>
<p>Here's what your SenseAir board should look like once it's wired up:</p>
<p><img alt="SenseAir Wiring" src="../pics/Senseair1.png" /></p>
<p>Now that you have that wired up, let's get the Arduino Primo wired up. A couple of things to note:</p>
<ul>
<li>The Arduino Primo's 'console' UART is actually UART1. </li>
<li>The secondary (bit-banged) UART is UART0, so that's where we'll have to hook up the SenseAir.</li>
</ul>
<p>Here's what your Arduino Primo should now look like with everything wired in:</p>
<p><img alt="SenseAir and Arduino Primo Wiring" src="../pics/Senseair2.png" /></p>
<p>Everything is wired and you're ready to go! Build and load your new app:</p>
<pre class="codehilite"><code class="language-no-highlight">$ newt build air_q
Building target targets/air_q
Compiling apps/air_quality/src/main.c
Archiving apps_air_quality.a
Linking myproj/bin/targets/air_q/app/apps/air_quality/air_quality.elf
Target successfully built: targets/air_q
$ newt create-image air_q 1.0.0
App image succesfully generated: myproj/bin/targets/air_q/app/apps/air_quality/air_quality.img
$ newt load air_q
Loading app image into slot 1</code></pre>


<p>Now, you should be able to connect to your serial port and read values:</p>
<pre class="codehilite"><code>user@IsMyLaptop:~]$ minicom -D /dev/tty.usbserial-AH02MIE2


    Welcome to minicom 2.7

    OPTIONS: 
    Compiled on Oct 12 2015, 07:48:30.
    Port /dev/tty.usbserial-AH02MIE2, 13:44:40

    Press CTRL-X Z for help on special keys

    1185: &gt; ?
    Commands:
    1382:     stat      echo         ?    prompt     ticks     tasks
    1390: mempools      date  senseair
    1395: &gt; senseair
    senseair co2
    2143: &gt; senseair co2
    Got 973</code></pre>


<p>And you're getting valid readings! Congratulations!</p>
<p>Next we'll hook this all up via Bluetooth so that you can read those values remotely. </p>
                        
                        <div class="row">
                            



<ul class="nav nav-pills" style="margin-bottom: 10px">
    <li>
    
    <a href=../blehci_project/>
        <span class="fa fa-arrow-left"></span>
        Previous: BLE HCI interface
    </a>
    
    </li>
    <li class="pull-right">
    
    <a href=../air_quality_ble/>
        Next: BLE-enabled Air Quality Sensor
        <span class="fa fa-arrow-right"></span>
    </a>
    
    </li>
</ul>
                        </div>
                        <footer class="row">
    <div class="col-xs-12">
        
            <p class="copyright">Apache Mynewt (incubating) is available under Apache License, version 2.0.</p>
        
    </div>
    <div class="col-xs-12">
        <div class="logos">
            <img src="/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
            <img src="/img/egg-logo2.png" alt="Apache Incubator" title="Apache Incubator"><br/>
             <a href="https://join.slack.com/mynewt/shared_invite/MTkwMTg1ODM1NTg5LTE0OTYxNzQ4NzQtZTU1YmNhYjhkMg"><img src="https://www.countit.com/images/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" /></a>
        </div>
    </div>
</footer>
                    </div>
                </div>
            
            
        </div>

        <script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script>
        <script src="../../../js/base.js"></script>
        <script src="../../../js/custom.js"></script>

    </body>
</html>