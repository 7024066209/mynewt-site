

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    <title>Statistics Module &mdash; Apache Mynewt latest documentation</title>
    

    
    
      <link rel="shortcut icon" href="../../../_static/mynewt-logo-only-newt32x32.png"/>
    

    

    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

    
      <link rel="stylesheet" href="../../../_static/css/sphinx_theme.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/bootstrap-3.0.3.min.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/v2.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/restructuredtext.css" type="text/css" />
    

    

    <link rel="stylesheet" href="../../../_static/css/overrides.css" type="text/css" />
          <link rel="index" title="Index"
                href="../../../genindex.html"/>
          <link rel="search" title="Search" href="../../../search.html"/>
      <link rel="top" title="Apache Mynewt latest documentation" href="../../../index.html"/> 

    
    <script src="../../../_static/js/modernizr.min.js"></script>

    
    <script>
    (function(i, s, o, g, r, a, m) {
	i["GoogleAnalyticsObject"] = r;
	(i[r] =
		i[r] ||
		function() {
			(i[r].q = i[r].q || []).push(arguments);
		}),
		(i[r].l = 1 * new Date());
	(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
	a.async = 1;
	a.src = g;
	m.parentNode.insertBefore(a, m);
})(window, document, "script", "//www.google-analytics.com/analytics.js", "ga");

ga("create", "UA-72162311-1", "auto");
ga("send", "pageview");
</script>
    

  </head>

  <body class="not-front page-documentation" role="document" >
    <div id="wrapper">
      <div class="container">
    <div id="banner" class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="../../../_static/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
              <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.5.0 </a> released (Nov 5, 2018)
            </div>
        </div>
    </div>
</div>
      
<header>
    <nav id="navbar" class="navbar navbar-inverse" role="navigation">
        <div class="container">
            <!-- Collapsed navigation -->
            <div class="navbar-header">
                <!-- Expander button -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <!-- Expanded navigation -->
            <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                    </li>
                    <li class="important">
                        <a href="/quick-start/">Quick Start</a>
                    </li>
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    <li>
                        <a href="/talks/">Talks</a>
                    </li>
                    <li class="active">
                        <a href="/documentation/">Documentation</a>
                    </li>
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    <li>
                        <a href="/community/">Community</a>
                    </li>
                    <li>
                        <a href="/events/">Events</a>
                    </li>
                </ul>

                <!-- Search, Navigation and Repo links -->
                <ul class="nav navbar-nav navbar-right">
                    
                </ul>
            </div>
        </div>
    </nav>
</header>
      <!-- STARTS MAIN CONTENT -->
      <div id="main-content">
        





<div id="breadcrumb">
  <div class="container">
    <a href="/documentation/">Docs</a> /
    
    Statistics Module
    
  <div class="sourcelink">
    <a href="https://github.com/apache/mynewt-core/edit/master/docs/os/modules/stats/stats.rst" class="icon icon-github"
           rel="nofollow"> Edit on GitHub</a>
</div>
  </div>
</div>
        <!-- STARTS CONTAINER -->
        <div class="container">
          <!-- STARTS .content -->
          <div id="content" class="row">
            
            <!-- STARTS .container-sidebar -->
<div class="container-sidebar col-xs-12 col-sm-3">
  <div id="docSidebar" class="sticky-container">
    <div role="search" class="sphinx-search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" class="search-documentation" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    <!-- Note: only works when deployed -->
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
  <option value="/latest" selected>
    Version: latest
  </option>
  <option value="/v1_4_0">
    Version: 1.4.0
  </option>
  <option value="/v1_3_0/os/introduction">
    Version: 1.3.0
  </option>
  <option value="/v1_2_0/os/introduction">
    Version: 1.2.0
  </option>
  <option value="/v1_1_0/os/introduction">
    Version: 1.1.0
  </option>
  <option value="/v1_0_0/os/introduction">
    Version: 1.0.0
  </option>
  <option value="/v0_9_0/os/introduction">
    Version: 0_9_0
  </option>
</select>
    <div class="region region-sidebar">
      <div class="docs-menu">
      
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/index.html">Setup &amp; Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../os_user_guide.html">OS User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/docs/index.html">BLE User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newt/index.html">Newt Tool Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newtmgr/index.html">Newt Manager Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mynewt_faq/index.html">Mynewt FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/index.html">Appendix</a></li>
</ul>

        
      
      </div>
    </div>
  </div>
  <!-- ENDS STICKY CONTAINER -->
</div>
<!-- ENDS .container-sidebar -->

            <div class="col-xs-12 col-sm-9">
              
              <div class="">
                <div class="rst-content">
                  <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                   <div itemprop="articleBody">
                    
  <div class="section" id="statistics-module">
<h1>Statistics Module<a class="headerlink" href="#statistics-module" title="Permalink to this headline">¶</a></h1>
<p>The statistics module allows application, libraries, or drivers to
record statistics that can be shown via the Newtmgr tool and console.</p>
<p>This allows easy integration of statistics for troubleshooting,
maintenance, and usage monitoring.</p>
<p>By creating and registering your statistics, they are automatically
included in the Newtmgr shell and console APIs.</p>
<div class="section" id="implementation-details">
<h2>Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<p>A statistic is an unsigned integer that can be set by the code. When
building stats, the implementer chooses the size of the statistic
depending on the frequency of the statistic and the resolution required
before the counter wraps.</p>
<p>Typically the stats are incremented upon code events; however, they are
not limted to that purpose.</p>
<p>Stats are organized into sections. Each section of stats has its own
name and can be queried separately through the API. Each section of
stats also has its own statistic size, allowing the user to separate
large (64-bit) statistics from small (16 bit statistics). NOTE: It is
not currently possible to group different size stats into the same
section. Please ensure all stats in a section have the same size.</p>
<p>Stats sections are currently stored in a single global stats group.</p>
<p>Statistics are stored in a simple structure which contains a small stats
header followed by a list of stats. The stats header contains:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">struct stats_hdr {</span>
<span class="go">     char *s_name;</span>
<span class="go">     uint8_t s_size;</span>
<span class="go">     uint8_t s_cnt;</span>
<span class="go">     uint16_t s_pad1;</span>
<span class="gp">#</span><span class="k">if</span> MYNEWT_VAL<span class="o">(</span>STATS_NAMES<span class="o">)</span>
<span class="go">     const struct stats_name_map *s_map;</span>
<span class="go">     int s_map_cnt;</span>
<span class="gp">#</span>endif
<span class="go">     STAILQ_ENTRY(stats_hdr) s_next;</span>
<span class="go"> };</span>
</pre></div>
</div>
<p>The fields define with in the <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">MYNEWT_VAL(STATS_NAME)</span></code> directive
are only inincluded when the <code class="docutils literal notranslate"><span class="pre">STATS_NAMES</span></code> syscfg setting is set to 1
and enables use statistic names.</p>
<div class="section" id="enabling-statistic-names">
<h3>Enabling Statistic Names<a class="headerlink" href="#enabling-statistic-names" title="Permalink to this headline">¶</a></h3>
<p>By default, statistics are queried by number. You can use the
<code class="docutils literal notranslate"><span class="pre">STATS_NAMES</span></code> syscfg setting to enable statistic names and view the
results by name. Enabling statistic names provides better descriptions
in the reported statistics, but takes code space to store the strings
within the image.</p>
<p>To enable statistic names, set the <code class="docutils literal notranslate"><span class="pre">STATS_NAMES</span></code> value to 1 in the
application <code class="docutils literal notranslate"><span class="pre">syscfg.yml</span></code> file or use the <code class="docutils literal notranslate"><span class="pre">newt</span> <span class="pre">target</span> <span class="pre">set</span></code> command
to set the syscfg setting value. Here are examples for each method:</p>
<p>Method 1 - Set the value in the application <code class="docutils literal notranslate"><span class="pre">syscfg.yml</span></code> files:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> Package: apps/myapp

<span class="go">syscfg.vals:</span>
<span class="go">    STATS_NAMES: 1</span>
</pre></div>
</div>
<p>Method 2 - Set the target <code class="docutils literal notranslate"><span class="pre">syscfg</span></code> variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">newt target set myapp syscfg=STATS_NAMES=1</span>
</pre></div>
</div>
<p><strong>Note:</strong> This <code class="docutils literal notranslate"><span class="pre">newt</span> <span class="pre">target</span> <span class="pre">set</span></code> command only sets the syscfg variable
for the <code class="docutils literal notranslate"><span class="pre">STATS_NAMES</span></code> setting as an example. For your target, you
should set the syscfg variable with the other settings that you want to
override.</p>
</div>
</div>
<div class="section" id="adding-stats-to-your-code">
<h2>Adding Stats to your code.<a class="headerlink" href="#adding-stats-to-your-code" title="Permalink to this headline">¶</a></h2>
<p>Creating new stats table requires the following steps.</p>
<ul class="simple">
<li>Include the stats header file</li>
<li>Define a stats section</li>
<li>Declare an instance of the section</li>
<li>Define the stat sections names table</li>
<li>Implement stat in your code</li>
<li>Initialize the stats</li>
<li>Register the stats</li>
</ul>
<div class="section" id="include-the-stats-header-file">
<h3>Include the stats header file<a class="headerlink" href="#include-the-stats-header-file" title="Permalink to this headline">¶</a></h3>
<p>Add the stats library to your pkg.yml file for your package or app by
adding this line to your package dependencies.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pkg.deps:
    - &quot;@apache-mynewt-core/sys/stats&quot;
</pre></div>
</div>
<p>Add this include directive to code files using the stats library.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;stats/stats.h&gt;
</pre></div>
</div>
</div>
<div class="section" id="define-a-stats-section">
<h3>Define a stats section<a class="headerlink" href="#define-a-stats-section" title="Permalink to this headline">¶</a></h3>
<p>You must use the <code class="docutils literal notranslate"><span class="pre">stats.h</span></code> macros to define your stats table. A stats
section definition looks like this.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>STATS_SECT_START(my_stat_section)
    STATS_SECT_ENTRY(attempt_stat)
    STATS_SECT_ENTRY(error_stat)
STATS_SECT_END
</pre></div>
</div>
<p>In this case we chose to make the stats 32-bits each. <code class="docutils literal notranslate"><span class="pre">stats.h</span></code>
supports three different stats sizes through the following macros:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">STATS_SIZE_16</span></code> – stats are 16 bits (wraps at 65536)</li>
<li><code class="docutils literal notranslate"><span class="pre">STATS_SIZE_32</span></code> – stats are 32 bits (wraps at 4294967296)</li>
<li><code class="docutils literal notranslate"><span class="pre">STATS_SIZE_64</span></code> – stats are 64-bits</li>
</ul>
<p>When this compiles/pre-processes, it produces a structure definition
like this</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct stats_my_stat_section {
    struct stats_hdr s_hdr;
    uint32_t sattempt_stat;
    uint32_t serror_stat;
};
</pre></div>
</div>
<p>You can see that the defined structure has a small stats structure
header and the two stats we have defined.</p>
<p>Depending on whether these stats are used in multiple modules, you may
need to include this definition in a header file.</p>
</div>
<div class="section" id="declaring-a-variable-to-hold-the-stats">
<h3>Declaring a variable to hold the stats<a class="headerlink" href="#declaring-a-variable-to-hold-the-stats" title="Permalink to this headline">¶</a></h3>
<p>Declare the global variable to hold your statistics. Since it is
possible to have multiple copies of the same section (for example a stat
section for each of 5 identical peripherals), the variable name of the
stats section must be unique.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>STATS_SECT_DECL(my_stat_section) g_mystat;
</pre></div>
</div>
<p>Again, if your stats section is used in multiple C files you will need
to include the above definition in one of the C files and ‘extern’ this
declaration in your header file.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>extern STATS_SECT_DECL(my_stat_section) g_mystat;
</pre></div>
</div>
</div>
<div class="section" id="define-the-stats-section-name-table">
<h3>Define the stats section name table<a class="headerlink" href="#define-the-stats-section-name-table" title="Permalink to this headline">¶</a></h3>
<p>Whether or not you have <code class="docutils literal notranslate"><span class="pre">STATS_NAMES</span></code> enabled, you must define a stats
name table. If <code class="docutils literal notranslate"><span class="pre">STATS_NAMES</span></code> is not enabled, this will not take any
code space or image size.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/* define a few stats for querying */
STATS_NAME_START(my_stat_section)
    STATS_NAME(my_stat_section, attempt_stat)
    STATS_NAME(my_stat_section, error_stat)
STATS_NAME_END(my_stat_section)
</pre></div>
</div>
<p>When compiled by the preprocessor, it creates a structure that looks
like this.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct stats_name_map g_stats_map_my_stat_section[] = {
    { __builtin_offsetof (struct stats_my_stat_section, sattempt_stat), &quot;attempt_stat&quot; },
    { __builtin_offsetof (struct stats_my_stat_section, serror_stat), &quot;error_stat&quot; },
};
</pre></div>
</div>
<p>This table will allow the UI components to find a nice string name for
the stat.</p>
</div>
<div class="section" id="implement-stats-in-your-code">
<h3>Implement stats in your code.<a class="headerlink" href="#implement-stats-in-your-code" title="Permalink to this headline">¶</a></h3>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">STATS_INC</span></code> or <code class="docutils literal notranslate"><span class="pre">STATS_INCN</span></code> macros to increment your
statistics within your C-code. For example, your code may do this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>STATS_INC(g_mystat, attempt_stat);
rc = do_task();
if(rc == ERR) {
    STATS_INC(g_mystat, error_stat);
}
</pre></div>
</div>
</div>
<div class="section" id="initialize-the-statistics">
<h3>Initialize the statistics<a class="headerlink" href="#initialize-the-statistics" title="Permalink to this headline">¶</a></h3>
<p>You must initialize the stats so they can be operated on by the stats
library. As per our example above, it would look like the following.</p>
<p>This tells the system how large each statistic is and the number of
statistics in the section. It also initialize the name information for
the statistics if enabled as shown above.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rc = stats_init(
    STATS_HDR(g_mystat),
    STATS_SIZE_INIT_PARMS(g_mystat, STATS_SIZE_32),
    STATS_NAME_INIT_PARMS(my_stat_section));
assert(rc == 0);
</pre></div>
</div>
</div>
<div class="section" id="register-the-statistic-section">
<h3>Register the statistic section<a class="headerlink" href="#register-the-statistic-section" title="Permalink to this headline">¶</a></h3>
<p>If you want the system to know about your stats, you must register them.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rc = stats_register(&quot;my_stats&quot;, STATS_HDR(g_mystat));
assert(rc == 0);
</pre></div>
</div>
<p>There is also a method that does initialization and registration at the
same time, called <code class="docutils literal notranslate"><span class="pre">stats_init_and_reg</span></code>.</p>
</div>
</div>
<div class="section" id="retrieving-stats-through-console-or-newtmgr">
<h2>Retrieving stats through console or Newtmgr<a class="headerlink" href="#retrieving-stats-through-console-or-newtmgr" title="Permalink to this headline">¶</a></h2>
<p>If you enable console in your project you can see stats through the
serial port defined.</p>
<p>This is the stats as shown from the example above with names enabled.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>stat my_stats
12274:attempt_stat: 3
12275:error_stat: 0
</pre></div>
</div>
<p>This is the stats as shown from the example without names enabled.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>stat my_stats
29149:s0: 3
29150:s1: 0
</pre></div>
</div>
</div>
<div class="section" id="a-note-on-multiple-stats-sections">
<h2>A note on multiple stats sections<a class="headerlink" href="#a-note-on-multiple-stats-sections" title="Permalink to this headline">¶</a></h2>
<p>If you are implementing a device with multiple instances, you may want
multiple stats sections with the exact same format.</p>
<p>For example, suppose I write a driver for an external distance sensor.
My driver supports up to 5 sensors and I want to record the stats of
each device separately.</p>
<p>This works identically to the example above, except you would need to
register each one separately with a unique name. The stats system will
not let two sections be entered with the same name.</p>
</div>
</div>


                   </div>
                  </div>
                  
                </div>
              </div>
            </div>
            <!-- ENDS CONTENT SECTION -->
          </div>
          <!-- ENDS .content -->
        </div>
      </div>
      <footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
          
              <p class="copyright">Apache Mynewt is available under Apache License, version 2.0.</p>
          
      </div>
      <div class="col-xs-12">
          <div class="logos">
              <img src="../../../_static/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
              <small class="footnote">
                Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt project logo are either
                registered trademarks or trademarks of the Apache Software Foundation in the United States and other countries.
              </small>
              <a href="https://join.slack.com/mynewt/shared_invite/MTkwMTg1ODM1NTg5LTE0OTYxNzQ4NzQtZTU1YmNhYjhkMg">
                <img src="../../../_static/img/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" />
              </a>
          </div>
      </div>
    </div>
  </div>
</footer>
    </div>
    <!-- ENDS #wrapper -->

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'latest',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/language_data.js"></script>
      <script type="text/javascript" src="../../../_static/js/bootstrap-3.0.3.min.js"></script>
      <script type="text/javascript" src="../../../_static/js/affix.js"></script>
      <script type="text/javascript" src="../../../_static/js/main.js"></script>

   

  </body>
</html>