

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    <title>Air quality sensor project &mdash; Apache Mynewt 1.3.0 documentation</title>
    

    
    
      <link rel="shortcut icon" href="../_static/mynewt-logo-only-newt32x32.png"/>
    

    

    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

    
      <link rel="stylesheet" href="../_static/css/sphinx_theme.css" type="text/css" />
    
      <link rel="stylesheet" href="../_static/css/bootstrap-3.0.3.min.css" type="text/css" />
    
      <link rel="stylesheet" href="../_static/css/v2.css" type="text/css" />
    
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    
      <link rel="stylesheet" href="../_static/css/restructuredtext.css" type="text/css" />
    

    

    <link rel="stylesheet" href="../_static/css/overrides.css" type="text/css" />
          <link rel="index" title="Index"
                href="../genindex.html"/>
          <link rel="search" title="Search" href="../search.html"/>
      <link rel="top" title="Apache Mynewt 1.3.0 documentation" href="../index.html"/> 

    
    <script src="../_static/js/modernizr.min.js"></script>

    
    <script>
    (function(i, s, o, g, r, a, m) {
	i["GoogleAnalyticsObject"] = r;
	(i[r] =
		i[r] ||
		function() {
			(i[r].q = i[r].q || []).push(arguments);
		}),
		(i[r].l = 1 * new Date());
	(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
	a.async = 1;
	a.src = g;
	m.parentNode.insertBefore(a, m);
})(window, document, "script", "//www.google-analytics.com/analytics.js", "ga");

ga("create", "UA-72162311-1", "auto");
ga("send", "pageview");
</script>
    

  </head>

  <body class="not-front page-documentation" role="document" >
    <div id="wrapper">
      <div class="container">
    <div id="banner" class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="../_static/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
              <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.3.0</a> released (December 13, 2017)
            </div>
        </div>
    </div>
</div>
      
<header>
    <nav id="navbar" class="navbar navbar-inverse" role="navigation">
        <div class="container">
            <!-- Collapsed navigation -->
            <div class="navbar-header">
                <!-- Expander button -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <!-- Expanded navigation -->
            <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                    </li>
                    <li class="important">
                        <a href="/get_started/quick_start.html">Quick Start</a>
                    </li>
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    <li>
                        <a href="/talks/">Talks</a>
                    </li>
                    <li class="active">
                        <a href="/documentation/">Documentation</a>
                    </li>
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    <li>
                        <a href="/community/">Community</a>
                    </li>
                    <li>
                        <a href="/events/">Events</a>
                    </li>
                </ul>

                <!-- Search, Navigation and Repo links -->
                <ul class="nav navbar-nav navbar-right">
                    
                </ul>
            </div>
        </div>
    </nav>
</header>
      <!-- STARTS MAIN CONTENT -->
      <div id="main-content">
        





<div id="breadcrumb">
  <div class="container">
    <a href="/documentation/">Docs</a> /
    
    Air quality sensor project
    
  <div class="sourcelink">
    <a href="https://github.com/apache/mynewt-documentation/edit/master/docs/tutorials/air_quality_sensor.rst" class="icon icon-github"
           rel="nofollow"> Edit on GitHub</a>
</div>
  </div>
</div>
        <!-- STARTS CONTAINER -->
        <div class="container">
          <!-- STARTS .content -->
          <div id="content" class="row">
            
            <!-- STARTS .container-sidebar -->
<div class="container-sidebar col-xs-12 col-sm-3">
  <div id="docSidebar" class="sticky-container">
    <div role="search" class="sphinx-search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" class="search-documentation" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    
<!-- Note: only works when deployed -->
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
    <option
      value="/develop"
      selected
      >
      Version: develop (latest - mynewt-documentation)
    </option>
    <option
      value="/latest/os/introduction"
      >
      Version: master (latest - mynewt-site)
    </option>
    <option
      value="/v1_2_0/os/introduction"
      >
      Version: 1.2.0
    </option>
    <option
      value="/v1_1_0/os/introduction">
      Version: 1.1.0
    </option>
    <option
      value="/v1_0_0/os/introduction">
      Version: 1.0.0
    </option>
    <option
      value="/v0_9_0/os/introduction">
      Version: 0_9_0
    </option>
</select>
    <div class="region region-sidebar">
      <div class="docs-menu">
      
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/index.html">Setup &amp; Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../os/os_user_guide.html">OS User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/ble/ble_intro.html">BLE User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../newt/index.html">Newt Tool Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../newtmgr/index.html">Newt Manager Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/index.html">Appendix</a></li>
</ul>

        
      
      </div>
    </div>
  </div>
  <!-- ENDS STICKY CONTAINER -->
</div>
<!-- ENDS .container-sidebar -->

            <div class="col-xs-12 col-sm-9">
              <div class="alert alert-info" role="alert">
  <p>
    This is the development version of Apache Mynewt documentation. As such it may not be as complete as the latest
    stable version of the documentation found <a href="/latest/os/introduction/">here</a>.
  </p>
  <p>
    To improve this documentation please visit <a href="https://github.com/apache/mynewt-documentation">https://github.com/apache/mynewt-documentation</a>.
  </p>
</div>
              
              <div class="">
                <div class="rst-content">
                  <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                   <div itemprop="articleBody">
                    
  <div class="section" id="air-quality-sensor-project">
<h1>Air quality sensor project<a class="headerlink" href="#air-quality-sensor-project" title="Permalink to this headline">¶</a></h1>
<div class="section" id="setting-up-source-tree-for-stuff-you-need">
<h2>Setting up source tree for stuff you need<a class="headerlink" href="#setting-up-source-tree-for-stuff-you-need" title="Permalink to this headline">¶</a></h2>
<p>To start with, you need to create a new project under which you will do
this development. So you type in:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir <span class="nv">$HOME</span>/src
<span class="gp">$</span> <span class="nb">cd</span> <span class="nv">$HOME</span>/src
<span class="gp">$</span> newt new air_quality
</pre></div>
</div>
<p>Let’s say you are using Arduino Primo – which is based on the Nordic
Semi NRF52 chip – as the platform. You know you need the board support
package for that hardware. You can look up its location, add it your
project, and fetch that along with the core OS components. Luckily, the
Arduino Primo is supported in the Mynewt Core, so there’s nothing much
to do here.</p>
<p>Your project.yml file should look like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span>[user@IsMyLaptop:~/src/air_quality]$ emacs project.yml &amp;
[user@IsMyLaptop:~/src/air_quality]$ cat project.yml
project.name: &quot;air_quality&quot;

project.repositories:
    - apache-mynewt-core

# Use github&#39;s distribution mechanism for core ASF libraries.
# This provides mirroring automatically for us.
#
repository.apache-mynewt-core:
    type: github
    vers: 0-latest
    user: apache
    repo: mynewt-core

[user@IsMyLaptop:~/src/air_quality]$ newt install
apache-mynewt-core
[user@IsMyLaptop:~/src/air_quality]$ ls repos/
apache-mynewt-core
</pre></div>
</div>
<p>Good. You want to make sure you have all the needed bits for supporting
your board; so you decide to build the blinky project for the platform
first.</p>
<p>Now create a target for it and build it. Easiest way to proceed is to
copy the existing target for blinky, and modify it to build for Arduino
Primo board.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target copy my_blinky_sim blink_primo
<span class="go">Target successfully copied; targets/my_blinky_sim --&gt; targets/blink_primo</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target <span class="nb">set</span> blink_primo <span class="nv">bsp</span><span class="o">=</span>@apache-mynewt-core/hw/bsp/arduino_primo_nrf52
<span class="go">Target targets/blink_nrf successfully set target.bsp to @apache-mynewt-core/hw/bsp/arduino_primo_nrf52</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt build blink_primo
<span class="go">Compiling hal_bsp.c</span>
<span class="go">...</span>
<span class="go">Linking blinky.elf</span>
<span class="go">App successfully built: /Users/user/src/air_quality/bin/blink_primo/apps/blinky/blinky.elf</span>
</pre></div>
</div>
<p>Good.</p>
<p>You know that this platform uses bootloader, which means you have to
create a target for that too.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target create boot_primo
<span class="go">Target targets/boot_nrf successfully created</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target show
<span class="go">@apache-mynewt-core/targets/unittest</span>
<span class="go">    bsp=hw/bsp/native</span>
<span class="go">    build_profile=debug</span>
<span class="go">    compiler=compiler/sim</span>
<span class="go">targets/blink_primo</span>
<span class="go">    app=apps/blinky</span>
<span class="go">    bsp=@apache-mynewt-core/hw/bsp/arduino_primo_nrf52</span>
<span class="go">    build_profile=debug</span>
<span class="go">targets/boot_primo</span>
<span class="go">targets/my_blinky_sim</span>
<span class="go">    app=apps/blinky</span>
<span class="go">    bsp=@apache-mynewt-core/hw/bsp/native</span>
<span class="go">    build_profile=debug</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target <span class="nb">set</span> boot_nrf <span class="nv">bsp</span><span class="o">=</span>@apache-mynewt-core/hw/bsp/arduino_primo_nrf52
<span class="go">Target targets/boot_nrf successfully set target.bsp to @apache-mynewt-core/hw/bsp/arduino_primo_nrf52</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target <span class="nb">set</span> boot_nrf <span class="nv">app</span><span class="o">=</span>@apache-mynewt-core/apps/boot
<span class="go">Target targets/boot_nrf successfully set target.app to @apache-mynewt-core/apps/boot</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target <span class="nb">set</span> boot_nrf <span class="nv">build_profile</span><span class="o">=</span>optimized
<span class="go">Target targets/boot_nrf successfully set target.build_profile to optimized</span>
</pre></div>
</div>
<p>And then build it, and load it onto the board.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">newt build boot_primo</span>
<span class="go">....</span>
<span class="go">Linking boot.elf</span>
<span class="go">App successfully built: /Users/user/src/air_quality/bin/boot_primo/apps/boot/boot.elf</span>
<span class="go">[user@IsMyLaptop:~/src/air_quality]</span>
<span class="gp">$</span> newt load boot_primo
</pre></div>
</div>
<p>At this point, you may (or may not) see a bunch of error messages about
not being able to connect to your board, not being able to load the
image, etc. If that’s the case, and you haven’t already, you should most
definitely go worth through the <a class="reference external" href="blinky_primo.html">blinky_primo</a>
tutorial so that you can properly communicate with your board.</p>
<p>Next you must download the targets to board, and see that the LED
actually blinks. You plug in the Arduino Primo board to your laptop, and
say:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt load blink_primo
<span class="go">Loading app image into slot 1</span>
<span class="go">Error: couldn&#39;t open /Users/user/src/air_quality/bin/blink_primo/apps/blinky/blinky.img</span>

<span class="go">Error: exit status 1</span>

<span class="go">load - Load app image to target for &lt;target-name&gt;.</span>

<span class="go">Usage:</span>
<span class="go">  newt load [flags]</span>

<span class="go">Examples:</span>
<span class="go">  newt load &lt;target-name&gt;</span>


<span class="go">Global Flags:</span>
<span class="go">  -l, --loglevel string   Log level, defaults to WARN. (default &quot;WARN&quot;)</span>
<span class="go">  -o, --outfile string    Filename to tee log output to</span>
<span class="go">  -q, --quiet             Be quiet; only display error output.</span>
<span class="go">  -s, --silent            Be silent; don&#39;t output anything.</span>
<span class="go">  -v, --verbose           Enable verbose output when executing commands.</span>
<span class="go">exit status 1</span>
</pre></div>
</div>
<p>Ah. Forgot to create an image out of the blinky binary. Note that every
time you want to build and load a new firmware image to a target board,
you need to run ‘create-image’ on it.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt create-image blink_primo <span class="m">0</span>.0.1
<span class="go">App image successfully generated: /Users/user/src/air_quality/bin/blink_primo/apps/blinky/blinky.img</span>
<span class="go">Build manifest: /Users/user/src/air_quality/bin/blink_nrf/apps/blinky/manifest.json</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt load blink_primo
</pre></div>
</div>
<p>And it’s blinking.</p>
<p>Shortcut for doing build/create-image/load/debug steps all in one is
‘newt run’ command. Check out the usage from command line help.</p>
</div>
<div class="section" id="create-test-project">
<h2>Create test project<a class="headerlink" href="#create-test-project" title="Permalink to this headline">¶</a></h2>
<p>Now that you have your system setup, you can start creating your own
stuff. First you want to create a project for yourself - you could start
by using blinky as a project template, but since we’re going to want to
be able to access the data via Bluetooth, let’s use the <code class="docutils literal notranslate"><span class="pre">bleprph</span></code>
Bluetooth Peripheral project instead.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> mkdir apps/air_quality
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> cp repos/apache-mynewt-core/apps/bleprph/pkg.yml apps/air_quality/
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> cp -Rp repos/apache-mynewt-core/apps/bleprph/src apps/air_quality/
</pre></div>
</div>
<p>Then you modify the apps/air_quality/pkg.yml for air_quality in order
to change the <em>pkg.name</em> to be <em>apps/air_quality</em>. You’ll need to add
the <code class="docutils literal notranslate"><span class="pre">&#64;apache-mynewt-core/</span></code> path to all the package dependencies, since
the app no longer resides within the apache-mynewt-core repository.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> cat apps/air_quality/pkg.yml
<span class="go">pkg.name: apps/air_quality</span>
<span class="go">pkg.type: app</span>
<span class="go">pkg.description: BLE Air Quality application.</span>
<span class="go">pkg.author: &quot;Apache Mynewt &lt;dev@mynewt.apache.org&gt;&quot;</span>
<span class="go">pkg.homepage: &quot;http://mynewt.apache.org/&quot;</span>
<span class="go">pkg.keywords:</span>

<span class="go">pkg.deps:</span>
<span class="go">    - &quot;@apache-mynewt-core/kernel/os&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/sys/shell&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/sys/stats/full&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/sys/log/full&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/mgmt/newtmgr&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/mgmt/newtmgr/transport/ble&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/net/nimble/controller&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/net/nimble/host&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/net/nimble/host/services/ans&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/net/nimble/host/services/gap&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/net/nimble/host/services/gatt&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/net/nimble/host/store/ram&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/net/nimble/transport/ram&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/sys/console/full&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/sys/sysinit&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/sys/id&quot;</span>
</pre></div>
</div>
<p>And create a target for it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target create air_q
<span class="go">Target targets/air_q successfully created</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target <span class="nb">set</span> air_q <span class="nv">bsp</span><span class="o">=</span>@apache-mynewt-core/hw/bsp/arduino_primo_nrf52
<span class="go">Target targets/air_q successfully set target.bsp to @apache-mynewt-core/hw/bsp/arduino_primo_nrf52</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target <span class="nb">set</span> air_q <span class="nv">app</span><span class="o">=</span>apps/air_quality
<span class="go">Target targets/air_q successfully set target.app to apps/air_quality</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt target <span class="nb">set</span> air_q <span class="nv">build_profile</span><span class="o">=</span>debug
<span class="go">Target targets/air_q successfully set target.build_profile to debug</span>
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt build air_q
<span class="go"> ....</span>
<span class="go">Linking /Users/dsimmons/dev/myproj/bin/targets/air_q/app/apps/air_quality/air_quality.elf</span>
<span class="go">Target successfully built: targets/air_q</span>
</pre></div>
</div>
</div>
<div class="section" id="create-packages-for-drivers">
<h2>Create packages for drivers<a class="headerlink" href="#create-packages-for-drivers" title="Permalink to this headline">¶</a></h2>
<p>One of the sensors you want to enable is SenseAir K30, which will
connect to the board over a serial port. To start development of the
driver, you first need to create a package description for it, and add
stubs for sources.</p>
<p>The first thing to do is to create the directory structure for your
driver:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> mkdir -p libs/my_drivers/senseair/include/senseair
<span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> mkdir -p libs/my_drivers/senseair/src
</pre></div>
</div>
<p>Now you can add the files you need. You’ll need a pkg.yml to describe
the driver, and then header stub followed by source stub.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> cat libs/my_drivers/senseair/pkg.yml
</pre></div>
</div>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# &quot;License&quot;); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
pkg.name: libs/my_drivers/senseair
pkg.description: Host side of the nimble Bluetooth Smart stack.
pkg.author: &quot;Apache Mynewt &lt;dev@mynewt.apache.org&gt;&quot;
pkg.homepage: &quot;http://mynewt.apache.org/&quot;
pkg.keywords:
    - ble
    - bluetooth

pkg.deps:
    - &quot;@apache-mynewt-core/kernel/os&quot;
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> cat libs/my_drivers/senseair/include/senseair/senseair.h
</pre></div>
</div>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
*/
#ifndef _SENSEAIR_H_
#define _SENSEAIR_H_

void senseair_init(void);

#endif /* _SENSEAIR_H_ */
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> cat libs/my_drivers/senseair/src/senseair.c
</pre></div>
</div>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

void
senseair_init(void)
{
}
</pre></div>
</div>
<p>And add dependency to this package in your project yml file.</p>
<p>Here’s the listing from apps/air_quality/pkg.yml</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">pkg.name: apps/air_quality</span>
<span class="go">pkg.type: app</span>
<span class="go">pkg.description: Air quality sensor test</span>
<span class="go">pkg.keywords:</span>

<span class="go">pkg.deps:</span>
<span class="go">    - &quot;@apache-mynewt-core/libs/console/full&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/libs/newtmgr&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/libs/os&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/libs/shell&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/sys/config&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/sys/log/full&quot;</span>
<span class="go">    - &quot;@apache-mynewt-core/sys/stats/full&quot;</span>
<span class="go">    - libs/my_drivers/senseair</span>
</pre></div>
</div>
<p>And add a call to your main() to initialize this driver.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> diff project/blinky/src/main.c project/air_quality/src/main.c
<span class="go">28a29</span>
<span class="gp">&gt;</span> <span class="c1">#include &lt;senseair/senseair.h&gt;</span>
<span class="go">190a192</span>
<span class="gp">&gt;</span> senseair_init<span class="o">()</span><span class="p">;</span>
<span class="go">[user@IsMyLaptop:~/src/air_quality</span>
</pre></div>
</div>
<p>The ble_prph app runs everything in one task handler. For this project,
we’re going to add a second task handler to respond to the shell, and
then handle communicating with the senseair sensor for us.</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>/** shell task settings. */
#define SHELL_TASK_PRIO           2
#define SHELL_STACK_SIZE          (OS_STACK_ALIGN(336))

struct os_eventq shell_evq;
struct os_task shell_task;
bssnz_t os_stack_t shell_stack[SHELL_STACK_SIZE];
</pre></div>
</div>
<p>That defines the task, now we need to initialize it, add a task handler,
and we’re going to use this task as our default task handler.</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>/**
 * Event loop for the main shell task.
 */
static void
shell_task_handler(void *unused)
{
    while (1) {
        os_eventq_run(&amp;shell_evq);
    }
}
</pre></div>
</div>
<p>And in your <code class="docutils literal notranslate"><span class="pre">main()</span></code> add:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>/* Initialize shell eventq */
os_eventq_init(&amp;shell_evq);

/* Create the shell task.
 * All shell operations are performed in this task.
 */
os_task_init(&amp;shell_task, &quot;shell&quot;, shell_task_handler,
                          NULL, SHELL_TASK_PRIO, OS_WAIT_FOREVER,
                          shell_stack, SHELL_STACK_SIZE);
</pre></div>
</div>
<p>Don’t forget to change your default task handler!</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>os_eventq_dflt_set(&amp;shell_evq);
</pre></div>
</div>
<p>And then build it to make sure all goes well.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> newt build air_q
<span class="go">Compiling senseair.c</span>
<span class="go">Archiving senseair.a</span>
<span class="go">Linking air_quality.elf</span>
<span class="go">App successfully built: /Users/user/src/air_quality/bin/air_q/apps/air_quality/air_quality.elf</span>
</pre></div>
</div>
<p>All looks good.</p>
</div>
<div class="section" id="add-cli-commands-for-testing-drivers">
<h2>Add CLI commands for testing drivers<a class="headerlink" href="#add-cli-commands-for-testing-drivers" title="Permalink to this headline">¶</a></h2>
<p>While developing the driver, you want to issue operations from console
asking it to do stuff. We’ll assume that you’ve already worked through
the tutorial on how to <a class="reference external" href="blinky_console.html">enable the CLI</a>, so all
we’ll need to do is add the propper values to the project’s
<code class="docutils literal notranslate"><span class="pre">syscfg.yml</span></code> file:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~/src/air_quality]$</span> cat targets/air_q/syscfg.yml
<span class="go">syscfg.vals:</span>
<span class="gp">    #</span> Set as per blinky_primo
<span class="go">    OPENOCD_DEBUG: 1</span>
<span class="gp">    #</span> Enable the shell task.
<span class="go">    SHELL_TASK: 1</span>
<span class="go">    STATS_CLI: 1</span>
<span class="go">    CONSOLE_TICKS: 1</span>
<span class="go">    CONSOLE_PROMPT: 1</span>
</pre></div>
</div>
<p>Then register your senseair command with the shell by adding the
following to <code class="docutils literal notranslate"><span class="pre">libs/my_drivers/senseair/src/senseair.c</span></code></p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;shell/shell.h&gt;
#include &lt;console/console.h&gt;
#include &lt;assert.h&gt;


static int senseair_shell_func(int argc, char **argv);
static struct shell_cmd senseair_cmd = {
    .sc_cmd = &quot;senseair&quot;,
    .sc_cmd_func = senseair_shell_func,
};

void
senseair_init(void)
{
    int rc;

    rc = shell_cmd_register(&amp;senseair_cmd);
    assert(rc == 0);
}

static int
senseair_shell_func(int argc, char **argv)
{
    console_printf(&quot;Yay! Somebody called!\n&quot;);
    return 0;

}
</pre></div>
</div>
<p>Now you can you build this, download to target, and start minicom on
your console port. If you haven’t already, familiarize yourself with the
tutorial on how to connect a serial port to your board
<a class="reference external" href="../get_started/serial_access.html">here</a>.</p>
<p>You’ll need to wire up your Board to a Serial converter first. On the
Arduino Primo Board pin 1 is TX and pin 0 is RX so wire 1 to RX on your
serial board, and 0 to TX on your serial board.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[user@IsMyLaptop:~]$</span> minicom -D /dev/tty.usbserial-AH02MIE2


<span class="go">Welcome to minicom 2.7</span>

<span class="go">OPTIONS:</span>
<span class="go">Compiled on Oct 12 2015, 07:48:30.</span>
<span class="go">Port /dev/tty.usbserial-AH02MIE2, 13:44:40</span>

<span class="go">Press CTRL-X Z for help on special keys</span>

<span class="go">?</span>
<span class="go">419: &gt; ?</span>
<span class="go">Commands:</span>
<span class="go">641:     stat      echo         ?    prompt     ticks     tasks</span>
<span class="go">643: mempools      date  senseair</span>
<span class="go">644: &gt; senseair</span>
<span class="go">Yay! Somebody called!</span>
<span class="go">1125: &gt;</span>
<span class="go">53611: &gt; tasks</span>
<span class="go">Tasks:</span>
<span class="go">54047:    task pri tid  runtime      csw    stksz   stkuse   lcheck   ncheck flg</span>
<span class="go">54057:    idle 255   0    54048    66890       64       30        0        0   0</span>
<span class="go">54068:  ble_ll   0   1        9    64986       80       58        0        0   0</span>
<span class="go">54079: bleprph   1   2        0        1      336       32        0        0   0</span>
<span class="go">54090:   shell   2   3        0     2077      336      262        0        0   0</span>
<span class="go">54101: &gt;</span>
</pre></div>
</div>
<p>That’s great. Your shell task is running, and is responding
appropriately! You can connect the hardware to your board and start
developing code for the driver itself.</p>
</div>
<div class="section" id="use-of-hal-for-drivers">
<h2>Use of HAL for drivers<a class="headerlink" href="#use-of-hal-for-drivers" title="Permalink to this headline">¶</a></h2>
<p>The sensor has a serial port connection, and that’s how you are going to
connect to it. Your original BSP, hw/bsp/arduino_primo_nrf52, has two
UARTs set up. We’re using one for our shell/console. It also has a
second UART set up as a ‘bit-bang’ UART but since the SenseAir only
needs to communicate at 9600 baud, this bit-banged uart is plenty fast
enough.</p>
<p>You’ll have to make a small change to the <code class="docutils literal notranslate"><span class="pre">syscfg.yml</span></code> file in your
project’s target directory to change the pin definitions for this second
UART. Those changes are as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">UART_0_PIN_TX: 23</span>
<span class="go">UART_0_PIN_RX: 24</span>
</pre></div>
</div>
<p>With this in place, you can refer to serial port where your SenseAir
sensor by a logical number. This makes the code more platform
independent - you could connect this sensor to another board, like
Olimex. You will also use the HAL UART abstraction to do the UART port
setup and data transfer. That way you don’t need to have any platform
dependent pieces within your little driver.</p>
<p>You will now see what the driver code ends up looking like. Here’s the
header file, filled in from the stub you created earlier.</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
*/
#ifndef _SENSEAIR_H_
#define _SENSEAIR_H_

enum senseair_read_type {
        SENSEAIR_CO2,
};

int senseair_init(int uartno);

int senseair_read(enum senseair_read_type);

#endif /* _SENSEAIR_H_ */
</pre></div>
</div>
<p>As you can see, logical UART number has been added to the init routine.
A ‘read’ function has been added, which is a blocking read. If you were
making a commercial product, you would probably have a callback for
reporting the results.</p>
<p>And here is the source for the driver.</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
#include &lt;string.h&gt;

#include &lt;shell/shell.h&gt;
#include &lt;console/console.h&gt;
#include &lt;os/os.h&gt;

#include &lt;hal/hal_uart.h&gt;

#include &quot;senseair/senseair.h&quot;

static const uint8_t cmd_read_co2[] = {
    0xFE, 0X44, 0X00, 0X08, 0X02, 0X9F, 0X25
};

static int senseair_shell_func(int argc, char **argv);
static struct shell_cmd senseair_cmd = {
    .sc_cmd = &quot;senseair&quot;,
    .sc_cmd_func = senseair_shell_func,
};

struct senseair {
    int uart;
    struct os_sem sema;
    const uint8_t *tx_data;
    int tx_off;
    int tx_len;
    uint8_t rx_data[32];
    int rx_off;
    int value;
} senseair;

static int
senseair_tx_char(void *arg)
{
    struct senseair *s = &amp;senseair;
    int rc;

    if (s-&gt;tx_off &gt;= s-&gt;tx_len) {
    /*
         * Command tx finished.
         */
        s-&gt;tx_data = NULL;
        return -1;
    }

    rc = s-&gt;tx_data[s-&gt;tx_off];
    s-&gt;tx_off++;
    return rc;
}

/*
 * CRC for modbus over serial port.
 */
static const uint16_t mb_crc_tbl[] = {
    0x0000, 0xcc01, 0xd801, 0x1400, 0xf001, 0x3c00, 0x2800, 0xe401,
    0xa001, 0x6c00, 0x7800, 0xb401, 0x5000, 0x9c01, 0x8801, 0x4400
};

static uint16_t
mb_crc(const uint8_t *data, int len, uint16_t crc)
{
    while (len-- &gt; 0) {
        crc ^= *data++;
        crc = (crc &gt;&gt; 4) ^ mb_crc_tbl[crc &amp; 0xf];
        crc = (crc &gt;&gt; 4) ^ mb_crc_tbl[crc &amp; 0xf];
    }
    return crc;
}

static int
mb_crc_check(const void *pkt, int len)
{
    uint16_t crc, cmp;
    uint8_t *bp = (uint8_t *)pkt;

    if (len &lt; sizeof(crc) + 1) {
        return -1;
    }
    crc = mb_crc(pkt, len - 2, 0xffff);
    cmp = bp[len - 2] | (bp[len - 1] &lt;&lt; 8);
    if (crc != cmp) {
        return -1;
    } else {
        return 0;
    }
}

static int
senseair_rx_char(void *arg, uint8_t data)
{
    struct senseair *s = (struct senseair *)arg;
    int rc;

    if (s-&gt;rx_off &gt;= sizeof(s-&gt;rx_data)) {
        s-&gt;rx_off = 0;
    }
    s-&gt;rx_data[s-&gt;rx_off] = data;
    s-&gt;rx_off++;

    if (s-&gt;rx_off == 7) {
        rc = mb_crc_check(s-&gt;rx_data, s-&gt;rx_off);
        if (rc == 0) {
            s-&gt;value = s-&gt;rx_data[3] * 256 + s-&gt;rx_data[4];
            os_sem_release(&amp;s-&gt;sema);
        }
    }
    return 0;
}

void
senseair_tx(struct senseair *s, const uint8_t *tx_data, int data_len)
{
    s-&gt;tx_data = tx_data;
    s-&gt;tx_len = data_len;
    s-&gt;tx_off = 0;
    s-&gt;rx_off = 0;

    hal_uart_start_tx(s-&gt;uart);
}

int
senseair_read(enum senseair_read_type type)
{
    struct senseair *s = &amp;senseair;
    const uint8_t *cmd;
    int cmd_len;
    int rc;

    if (s-&gt;tx_data) {
        /*
         * busy
         */
        return -1;
    }
    switch (type) {
    case SENSEAIR_CO2:
        cmd = cmd_read_co2;
        cmd_len = sizeof(cmd_read_co2);
        break;
    default:
        return -1;
    }
    senseair_tx(s, cmd, cmd_len);
    rc = os_sem_pend(&amp;s-&gt;sema, OS_TICKS_PER_SEC / 2);
    if (rc == OS_TIMEOUT) {
        /*
         * timeout
         */
        return -2;
    }
    return s-&gt;value;
}

static int
senseair_shell_func(int argc, char **argv)
{
    int value;
    enum senseair_read_type type;

    if (argc &lt; 2) {
usage:
        console_printf(&quot;%s co2\n&quot;, argv[0]);
        return 0;
    }
    if (!strcmp(argv[1], &quot;co2&quot;)) {
        type = SENSEAIR_CO2;
    } else {
        goto usage;
    }
    value = senseair_read(type);
    if (value &gt;= 0) {
        console_printf(&quot;Got %d\n&quot;, value);
    } else {
        console_printf(&quot;Error while reading: %d\n&quot;, value);
    }
    return 0;
}

int
senseair_init(int uartno)
{
    int rc;
    struct senseair *s = &amp;senseair;

    rc = shell_cmd_register(&amp;senseair_cmd);
    if (rc) {
        return rc;
    }

    rc = os_sem_init(&amp;s-&gt;sema, 1);
    if (rc) {
        return rc;
    }
    rc = hal_uart_init_cbs(uartno, senseair_tx_char, NULL,
      senseair_rx_char, &amp;senseair);
    if (rc) {
        return rc;
    }
    rc = hal_uart_config(uartno, 9600, 8, 1, HAL_UART_PARITY_NONE,
      HAL_UART_FLOW_CTL_NONE);
    if (rc) {
        return rc;
    }
    s-&gt;uart = uartno;

    return 0;
}
</pre></div>
</div>
<p>And your modified main() for senseair driver init.</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>int
main(int argc, char **argv)
{
    ....
    senseair_init(0);
    ....
    }
</pre></div>
</div>
<p>You can see from the code that you are using the HAL interface to open a
UART port, and using OS semaphore as a way of blocking the task when
waiting for read response to come back from the sensor.</p>
<p>Now comes the fun part: Hooking up the sensor! It’s fun because a)
hooking up a sensor is always fun and b) the SenseAir sensor’s PCB is
entirely unlabeled, so you’ll have to trust us on how to hook it up.</p>
<p>So here we go.</p>
<p>You’ll have to do a little soldering. I soldered some header pins to the
SenseAir K30 board to make connecting wires easier using standard jumper
wires, but you can also just solder wires straight to the board if you
prefer.</p>
<p>Here’s what your SenseAir board should look like once it’s wired up:</p>
<div class="figure" id="id1">
<img alt="SenseAir Wiring" src="../_images/Senseair1.png" />
<p class="caption"><span class="caption-text">SenseAir Wiring</span></p>
</div>
<p>Now that you have that wired up, let’s get the Arduino Primo wired up. A
couple of things to note:</p>
<ul class="simple">
<li>The Arduino Primo’s ‘console’ UART is actually UART1.</li>
<li>The secondary (bit-banged) UART is UART0, so that’s where we’ll have
to hook up the SenseAir.</li>
</ul>
<p>Here’s what your Arduino Primo should now look like with everything
wired in:</p>
<div class="figure" id="id2">
<img alt="SenseAir and Arduino Primo Wiring" src="../_images/Senseair2.png" />
<p class="caption"><span class="caption-text">SenseAir and Arduino Primo Wiring</span></p>
</div>
<p>Everything is wired and you’re ready to go! Build and load your new app:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> newt build air_q
<span class="go">Building target targets/air_q</span>
<span class="go">Compiling apps/air_quality/src/main.c</span>
<span class="go">Archiving apps_air_quality.a</span>
<span class="go">Linking myproj/bin/targets/air_q/app/apps/air_quality/air_quality.elf</span>
<span class="go">Target successfully built: targets/air_q</span>
<span class="gp">$</span> newt create-image air_q <span class="m">1</span>.0.0
<span class="go">App image succesfully generated: myproj/bin/targets/air_q/app/apps/air_quality/air_quality.img</span>
<span class="gp">$</span> newt load air_q
<span class="go">Loading app image into slot 1</span>
</pre></div>
</div>
<p>Now, you should be able to connect to your serial port and read values:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>user@IsMyLaptop:~]$ minicom -D /dev/tty.usbserial-AH02MIE2


    Welcome to minicom 2.7

    OPTIONS:
    Compiled on Oct 12 2015, 07:48:30.
    Port /dev/tty.usbserial-AH02MIE2, 13:44:40

    Press CTRL-X Z for help on special keys

    1185: &gt; ?
    Commands:
    1382:     stat      echo         ?    prompt     ticks     tasks
    1390: mempools      date  senseair
    1395: &gt; senseair
    senseair co2
    2143: &gt; senseair co2
    Got 973
</pre></div>
</div>
<p>And you’re getting valid readings! Congratulations!</p>
<p>Next we’ll hook this all up via Bluetooth so that you can read those
values remotely.</p>
</div>
</div>


                   </div>
                  </div>
                  
                </div>
              </div>
            </div>
            <!-- ENDS CONTENT SECTION -->
          </div>
          <!-- ENDS .content -->
        </div>
      </div>
      <footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
          
              <p class="copyright">Apache Mynewt is available under Apache License, version 2.0.</p>
          
      </div>
      <div class="col-xs-12">
          <div class="logos">
              <img src="../_static/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
              <small class="footnote">
                Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt project logo are either
                registered trademarks or trademarks of the Apache Software Foundation in the United States and other countries.
              </small>
              <a href="https://join.slack.com/mynewt/shared_invite/MTkwMTg1ODM1NTg5LTE0OTYxNzQ4NzQtZTU1YmNhYjhkMg">
                <img src="../_static/img/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" />
              </a>
          </div>
      </div>
    </div>
  </div>
</footer>
    </div>
    <!-- ENDS #wrapper -->

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/js/bootstrap-3.0.3.min.js"></script>
      <script type="text/javascript" src="../_static/js/affix.js"></script>
      <script type="text/javascript" src="../_static/js/main.js"></script>

   

  </body>
</html>