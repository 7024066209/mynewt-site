

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    <title>Memory Pools &mdash; Apache Mynewt 1.3.0 documentation</title>
    

    
    
      <link rel="shortcut icon" href="../../../_static/mynewt-logo-only-newt32x32.png"/>
    

    

    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

    
      <link rel="stylesheet" href="../../../_static/css/sphinx_theme.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/bootstrap-3.0.3.min.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/v2.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/restructuredtext.css" type="text/css" />
    

    

    <link rel="stylesheet" href="../../../_static/css/overrides.css" type="text/css" />
          <link rel="index" title="Index"
                href="../../../genindex.html"/>
          <link rel="search" title="Search" href="../../../search.html"/>
      <link rel="top" title="Apache Mynewt 1.3.0 documentation" href="../../../index.html"/>
          <link rel="up" title="Mynewt Core OS" href="../mynewt_os.html"/>
          <link rel="next" title="Heap" href="../heap/heap.html"/>
          <link rel="prev" title="Mutex" href="../mutex/mutex.html"/> 

    
    <script src="../../../_static/js/modernizr.min.js"></script>

    
    <script>
    (function(i, s, o, g, r, a, m) {
	i["GoogleAnalyticsObject"] = r;
	(i[r] =
		i[r] ||
		function() {
			(i[r].q = i[r].q || []).push(arguments);
		}),
		(i[r].l = 1 * new Date());
	(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
	a.async = 1;
	a.src = g;
	m.parentNode.insertBefore(a, m);
})(window, document, "script", "//www.google-analytics.com/analytics.js", "ga");

ga("create", "UA-72162311-1", "auto");
ga("send", "pageview");
</script>
    

  </head>

  <body class="not-front page-documentation" role="document" >
    <div id="wrapper">
      <div class="container">
    <div id="banner" class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="../../../_static/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
              <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.3.0</a> released (December 13, 2017)
            </div>
        </div>
    </div>
</div>
      
<header>
    <nav id="navbar" class="navbar navbar-inverse" role="navigation">
        <div class="container">
            <!-- Collapsed navigation -->
            <div class="navbar-header">
                <!-- Expander button -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <!-- Expanded navigation -->
            <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                    </li>
                    <li class="important">
                        <a href="/get_started/quick_start.html">Quick Start</a>
                    </li>
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    <li>
                        <a href="/talks/">Talks</a>
                    </li>
                    <li class="active">
                        <a href="/documentation/">Documentation</a>
                    </li>
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    <li>
                        <a href="/community/">Community</a>
                    </li>
                    <li>
                        <a href="/events/">Events</a>
                    </li>
                </ul>

                <!-- Search, Navigation and Repo links -->
                <ul class="nav navbar-nav navbar-right">
                    
                </ul>
            </div>
        </div>
    </nav>
</header>
      <!-- STARTS MAIN CONTENT -->
      <div id="main-content">
        





<div id="breadcrumb">
  <div class="container">
    <a href="/documentation/">Docs</a> /
    
      <a href="../../os_user_guide.html">OS User Guide</a> /
    
      <a href="../mynewt_os.html">Mynewt Core OS</a> /
    
    Memory Pools
    
  <div class="sourcelink">
    <a href="https://github.com/apache/mynewt-core/edit/master/docs/os/core_os/memory_pool/memory_pool.rst" class="icon icon-github"
           rel="nofollow"> Edit on GitHub</a>
</div>
  </div>
</div>
        <!-- STARTS CONTAINER -->
        <div class="container">
          <!-- STARTS .content -->
          <div id="content" class="row">
            
            <!-- STARTS .container-sidebar -->
<div class="container-sidebar col-xs-12 col-sm-3">
  <div id="docSidebar" class="sticky-container">
    <div role="search" class="sphinx-search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" class="search-documentation" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    
<!-- Note: only works when deployed -->
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
    <option
      value="/develop"
      selected
      >
      Version: develop (latest - mynewt-documentation)
    </option>
    <option
      value="/latest/os/introduction"
      >
      Version: master (latest - mynewt-site)
    </option>
    <option
      value="/v1_2_0/os/introduction"
      >
      Version: 1.2.0
    </option>
    <option
      value="/v1_1_0/os/introduction">
      Version: 1.1.0
    </option>
    <option
      value="/v1_0_0/os/introduction">
      Version: 1.0.0
    </option>
    <option
      value="/v0_9_0/os/introduction">
      Version: 0_9_0
    </option>
</select>
    <div class="region region-sidebar">
      <div class="docs-menu">
      
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/index.html">Setup &amp; Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../os_user_guide.html">OS User Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../mynewt_os.html">OS Core</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../context_switch/context_switch.html">Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cputime/os_cputime.html">CPU Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="../time/os_time.html">OS Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task/task.html">Task</a></li>
<li class="toctree-l3"><a class="reference internal" href="../event_queue/event_queue.html">Event Queues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../semaphore/semaphore.html">Semaphore</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mutex/mutex.html">Mutex</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Memory Pools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../heap/heap.html">Heap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mbuf/mbuf.html">Mbufs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../msys/msys.html">Msys</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mqueue/mqueue.html">Mqueue</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sanity/sanity.html">Sanity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../callout/callout.html">Callout</a></li>
<li class="toctree-l3"><a class="reference internal" href="../API.html">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../porting/port_os.html">Porting Mynewt OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/console/console.html">Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/sysinitconfig/sysinitconfig.html">System Configuration and Initialization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/ble/ble_intro.html">BLE User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newt/index.html">Newt Tool Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newtmgr/index.html">Newt Manager Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/index.html">Appendix</a></li>
</ul>

        
      
      </div>
    </div>
  </div>
  <!-- ENDS STICKY CONTAINER -->
</div>
<!-- ENDS .container-sidebar -->

            <div class="col-xs-12 col-sm-9">
              <div class="alert alert-info" role="alert">
  <p>
    This is the development version of Apache Mynewt documentation. As such it may not be as complete as the latest
    stable version of the documentation found <a href="/latest/os/introduction/">here</a>.
  </p>
  <p>
    To improve this documentation please visit <a href="https://github.com/apache/mynewt-documentation">https://github.com/apache/mynewt-documentation</a>.
  </p>
</div>
              
              <div class="">
                <div class="rst-content">
                  <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                   <div itemprop="articleBody">
                    
  <div class="section" id="memory-pools">
<h1>Memory Pools<a class="headerlink" href="#memory-pools" title="Permalink to this headline">¶</a></h1>
<p>A memory pool is a collection of fixed sized elements called memory
blocks. Generally, memory pools are used when the developer wants to
allocate a certain amount of memory to a given feature. Unlike the heap,
where a code module is at the mercy of other code modules to insure
there is sufficient memory, memory pools can insure sufficient memory
allocation.</p>
<div class="section" id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>In order to create a memory pool the developer needs to do a few things.
The first task is to define the memory pool itself. This is a data
structure which contains information about the pool itself (i.e. number
of blocks, size of the blocks, etc).</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>struct os_mempool my_pool;
</pre></div>
</div>
<p>The next order of business is to allocate the memory used by the memory
pool. This memory can either be statically allocated (i.e. a global
variable) or dynamically allocated (i.e. from the heap). When
determining the amount of memory required for the memory pool, simply
multiplying the number of blocks by the size of each block is not
sufficient as the OS may have alignment requirements. The alignment size
definition is named <code class="docutils literal notranslate"><span class="pre">OS_ALIGNMENT</span></code> and can be found in os_arch.h as
it is architecture specific. The memory block alignment is usually for
efficiency but may be due to other reasons. Generally, blocks are
aligned on 32-bit boundaries. Note that memory blocks must also be of
sufficient size to hold a list pointer as this is needed to chain memory
blocks on the free list.</p>
<p>In order to simplify this for the user two macros have been provided:
<code class="docutils literal notranslate"><span class="pre">OS_MEMPOOL_BYTES(n,</span> <span class="pre">blksize)</span></code> and <code class="docutils literal notranslate"><span class="pre">OS_MEMPOOL_SIZE(n,</span> <span class="pre">blksize)</span></code>.
The first macro returns the number of bytes needed for the memory pool
while the second returns the number of <code class="docutils literal notranslate"><span class="pre">os_membuf_t</span></code> elements required
by the memory pool. The <code class="docutils literal notranslate"><span class="pre">os_membuf_t</span></code> type is used to guarantee that
the memory buffer used by the memory pool is aligned on the correct
boundary.</p>
<p>Here are some examples. Note that if a custom malloc implementation is
used it must guarantee that the memory buffer used by the pool is
allocated on the correct boundary (i.e. OS_ALIGNMENT).</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>void *my_memory_buffer;
my_memory_buffer = malloc(OS_MEMPOOL_BYTES(NUM_BLOCKS, BLOCK_SIZE));
</pre></div>
</div>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>os_membuf_t my_memory_buffer[OS_MEMPOOL_SIZE(NUM_BLOCKS, BLOCK_SIZE)];
</pre></div>
</div>
<p>Now that the memory pool has been defined as well as the memory
required for the memory blocks which make up the pool the user needs to
initialize the memory pool by calling <code class="docutils literal notranslate"><span class="pre">os_mempool_init</span></code>.</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>os_mempool_init(&amp;my_pool, NUM_BLOCKS, BLOCK_SIZE, my_memory_buffer,
                         &quot;MyPool&quot;);
</pre></div>
</div>
<p>Once the memory pool has been initialized the developer can allocate
memory blocks from the pool by calling <code class="docutils literal notranslate"><span class="pre">os_memblock_get</span></code>. When the
memory block is no longer needed the memory can be freed by calling
<code class="docutils literal notranslate"><span class="pre">os_memblock_put</span></code>.</p>
</div>
<div class="section" id="data-structures">
<h2>Data structures<a class="headerlink" href="#data-structures" title="Permalink to this headline">¶</a></h2>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>struct os_mempool {
    int mp_block_size;
    int mp_num_blocks;
    int mp_num_free;
    int mp_min_free;
    uint32_t mp_membuf_addr;
    STAILQ_ENTRY(os_mempool) mp_list;
    SLIST_HEAD(,os_memblock);
    char *name;
};

struct os_mempool_info {
    int omi_block_size;
    int omi_num_blocks;
    int omi_num_free;
    int omi_min_free;
    char omi_name[OS_MEMPOOL_INFO_NAME_LEN];
};
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Element</strong></th>
<th class="head"><a href="#id1"><span class="problematic" id="id2">**</span></a>Description*
*</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>mp_block_s
ize</td>
<td>Size of the
memory blocks,
in bytes. This
is not the
actual number
of bytes used
by each block;
it is the
requested size
of each block.
The actual
memory block
size will be
aligned to
OS_ALIGNMENT
bytes</td>
</tr>
<tr class="row-odd"><td>mp_num_blo
cks</td>
<td>Number of
memory blocks
in the pool</td>
</tr>
<tr class="row-even"><td>mp_num_fre
e</td>
<td>Number of free
blocks left</td>
</tr>
<tr class="row-odd"><td>mp_min_fre
e</td>
<td>Lowest number
of free blocks
seen</td>
</tr>
<tr class="row-even"><td>mp_membuf_
addr</td>
<td>The address of
the memory
block. This is
used to check
that a valid
memory block
is being
freed.</td>
</tr>
<tr class="row-odd"><td>mp_list</td>
<td>List pointer
to chain
memory pools
so they can be
displayed by
newt tools</td>
</tr>
<tr class="row-even"><td>SLIST_HEAD(
,os_membloc
k)</td>
<td>List pointer
to chain free
memory blocks</td>
</tr>
<tr class="row-odd"><td>name</td>
<td>Name for the
memory block</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">doxygengroup: Cannot find namespace “OSMempool” in doxygen xml output for project “mynewt-core” from directory: mynewt-core-xml</p>
</div>
</div>
</div>


                   </div>
                  </div>
                  
    <div class="rst-footer-buttons row" role="navigation" aria-label="footer navigation">
      
        <a href="../heap/heap.html" class="btn btn-neutral float-right" title="Heap" accesskey="n">Next: Heap <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../mutex/mutex.html" class="btn btn-neutral" title="Mutex" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous: Mutex</a>
      
    </div>

                </div>
              </div>
            </div>
            <!-- ENDS CONTENT SECTION -->
          </div>
          <!-- ENDS .content -->
        </div>
      </div>
      <footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
          
              <p class="copyright">Apache Mynewt is available under Apache License, version 2.0.</p>
          
      </div>
      <div class="col-xs-12">
          <div class="logos">
              <img src="../../../_static/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
              <small class="footnote">
                Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt project logo are either
                registered trademarks or trademarks of the Apache Software Foundation in the United States and other countries.
              </small>
              <a href="https://join.slack.com/mynewt/shared_invite/MTkwMTg1ODM1NTg5LTE0OTYxNzQ4NzQtZTU1YmNhYjhkMg">
                <img src="../../../_static/img/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" />
              </a>
          </div>
      </div>
    </div>
  </div>
</footer>
    </div>
    <!-- ENDS #wrapper -->

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/js/bootstrap-3.0.3.min.js"></script>
      <script type="text/javascript" src="../../../_static/js/affix.js"></script>
      <script type="text/javascript" src="../../../_static/js/main.js"></script>

   

  </body>
</html>