

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    <title>Event Queues &mdash; Apache Mynewt 1.3.0 documentation</title>
    

    
    
      <link rel="shortcut icon" href="../../../_static/mynewt-logo-only-newt32x32.png"/>
    

    

    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

    
      <link rel="stylesheet" href="../../../_static/css/sphinx_theme.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/bootstrap-3.0.3.min.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/v2.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/restructuredtext.css" type="text/css" />
    

    

    <link rel="stylesheet" href="../../../_static/css/overrides.css" type="text/css" />
          <link rel="index" title="Index"
                href="../../../genindex.html"/>
          <link rel="search" title="Search" href="../../../search.html"/>
      <link rel="top" title="Apache Mynewt 1.3.0 documentation" href="../../../index.html"/>
          <link rel="up" title="Mynewt Core OS" href="../mynewt_os.html"/>
          <link rel="next" title="Semaphore" href="../semaphore/semaphore.html"/>
          <link rel="prev" title="Task" href="../task/task.html"/> 

    
    <script src="../../../_static/js/modernizr.min.js"></script>

    
    <script>
    (function(i, s, o, g, r, a, m) {
	i["GoogleAnalyticsObject"] = r;
	(i[r] =
		i[r] ||
		function() {
			(i[r].q = i[r].q || []).push(arguments);
		}),
		(i[r].l = 1 * new Date());
	(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
	a.async = 1;
	a.src = g;
	m.parentNode.insertBefore(a, m);
})(window, document, "script", "//www.google-analytics.com/analytics.js", "ga");

ga("create", "UA-72162311-1", "auto");
ga("send", "pageview");
</script>
    

  </head>

  <body class="not-front page-documentation" role="document" >
    <div id="wrapper">
      <div class="container">
    <div id="banner" class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="../../../_static/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
              <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.3.0</a> released (December 13, 2017)
            </div>
        </div>
    </div>
</div>
      
<header>
    <nav id="navbar" class="navbar navbar-inverse" role="navigation">
        <div class="container">
            <!-- Collapsed navigation -->
            <div class="navbar-header">
                <!-- Expander button -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <!-- Expanded navigation -->
            <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                    </li>
                    <li class="important">
                        <a href="/get_started/quick_start.html">Quick Start</a>
                    </li>
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    <li>
                        <a href="/talks/">Talks</a>
                    </li>
                    <li class="active">
                        <a href="/documentation/">Documentation</a>
                    </li>
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    <li>
                        <a href="/community/">Community</a>
                    </li>
                    <li>
                        <a href="/events/">Events</a>
                    </li>
                </ul>

                <!-- Search, Navigation and Repo links -->
                <ul class="nav navbar-nav navbar-right">
                    
                </ul>
            </div>
        </div>
    </nav>
</header>
      <!-- STARTS MAIN CONTENT -->
      <div id="main-content">
        





<div id="breadcrumb">
  <div class="container">
    <a href="/documentation/">Docs</a> /
    
      <a href="../../os_user_guide.html">OS User Guide</a> /
    
      <a href="../mynewt_os.html">Mynewt Core OS</a> /
    
    Event Queues
    
  <div class="sourcelink">
    <a href="https://github.com/apache/mynewt-core/edit/master/docs/os/core_os/event_queue/event_queue.rst" class="icon icon-github"
           rel="nofollow"> Edit on GitHub</a>
</div>
  </div>
</div>
        <!-- STARTS CONTAINER -->
        <div class="container">
          <!-- STARTS .content -->
          <div id="content" class="row">
            
            <!-- STARTS .container-sidebar -->
<div class="container-sidebar col-xs-12 col-sm-3">
  <div id="docSidebar" class="sticky-container">
    <div role="search" class="sphinx-search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" class="search-documentation" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    
<!-- Note: only works when deployed -->
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
    <option
      value="/develop"
      selected
      >
      Version: develop (latest - mynewt-documentation)
    </option>
    <option
      value="/latest/os/introduction"
      >
      Version: master (latest - mynewt-site)
    </option>
    <option
      value="/v1_2_0/os/introduction"
      >
      Version: 1.2.0
    </option>
    <option
      value="/v1_1_0/os/introduction">
      Version: 1.1.0
    </option>
    <option
      value="/v1_0_0/os/introduction">
      Version: 1.0.0
    </option>
    <option
      value="/v0_9_0/os/introduction">
      Version: 0_9_0
    </option>
</select>
    <div class="region region-sidebar">
      <div class="docs-menu">
      
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/index.html">Setup &amp; Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../os_user_guide.html">OS User Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../mynewt_os.html">OS Core</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../context_switch/context_switch.html">Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cputime/os_cputime.html">CPU Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="../time/os_time.html">OS Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task/task.html">Task</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Event Queues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../semaphore/semaphore.html">Semaphore</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mutex/mutex.html">Mutex</a></li>
<li class="toctree-l3"><a class="reference internal" href="../memory_pool/memory_pool.html">Memory Pools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../heap/heap.html">Heap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mbuf/mbuf.html">Mbufs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../msys/msys.html">Msys</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mqueue/mqueue.html">Mqueue</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sanity/sanity.html">Sanity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../callout/callout.html">Callout</a></li>
<li class="toctree-l3"><a class="reference internal" href="../API.html">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../porting/port_os.html">Porting Mynewt OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/console/console.html">Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/sysinitconfig/sysinitconfig.html">System Configuration and Initialization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/ble/ble_intro.html">BLE User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newt/index.html">Newt Tool Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newtmgr/index.html">Newt Manager Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/index.html">Appendix</a></li>
</ul>

        
      
      </div>
    </div>
  </div>
  <!-- ENDS STICKY CONTAINER -->
</div>
<!-- ENDS .container-sidebar -->

            <div class="col-xs-12 col-sm-9">
              <div class="alert alert-info" role="alert">
  <p>
    This is the development version of Apache Mynewt documentation. As such it may not be as complete as the latest
    stable version of the documentation found <a href="/latest/os/introduction/">here</a>.
  </p>
  <p>
    To improve this documentation please visit <a href="https://github.com/apache/mynewt-documentation">https://github.com/apache/mynewt-documentation</a>.
  </p>
</div>
              
              <div class="">
                <div class="rst-content">
                  <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                   <div itemprop="articleBody">
                    
  <div class="section" id="event-queues">
<h1>Event Queues<a class="headerlink" href="#event-queues" title="Permalink to this headline">¶</a></h1>
<p>An event queue allows a task to serialize incoming events and simplify
event processing. Events are stored in a queue and a task removes and
processes an event from the queue. An event is processed in the context
of this task. Events may be generated by <a class="reference external" href="../callout/callout.html">OS
callouts</a>, interrupt handlers, and other
tasks.</p>
<div class="section" id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>Mynewt’s event queue model uses callback functions to process events.
Each event is associated with a callback function that is called to
process the event. This model enables a library package, that uses
events in its implementation but does not have real-time timing
requirements, to use an application event queue instead of creating a
dedicated event queue and task to process its events. The callback
function executes in the context of the task that the application
creates to manage the event queue. This model reduces an application’s
memory requirement because memory must be allocated for the task’s stack
when a task is created. A package that has real-time timing requirements
and must run at a specific task priority should create a dedicated event
queue and task to process its events.</p>
<p>In the Mynewt model, a package defines its events and implements the
callback functions for the events. A package that does not have
real-time timing requirements should use Mynewt’s default event queue
for its events. The callback function for an event from the Mynewt
default event queue is executed in the context of the application main
task. A package can, optionally, export a function that allows an
application to specify the event queue for the package to use. (See the
example in the <code class="docutils literal notranslate"><span class="pre">os_eventq_designate()</span></code> function description on how to
write such a function.) The application task handler that manages the
event queue simply pulls events from the event queue and executes the
event’s callback function in its context.</p>
<p>A common way that Mynewt applications or packages process events from an
event queue is to have a task that executes in an infinite loop and
calls the <code class="docutils literal notranslate"><span class="pre">os_eventq_get()</span></code> function to dequeue and return the event
from the head of the event queue. The task then calls the event callback
function to process the event. The <code class="docutils literal notranslate"><span class="pre">os_eventq_get()</span></code> function puts the
task in to the <code class="docutils literal notranslate"><span class="pre">sleeping</span></code> state when there are no events on the queue.
(See <a class="reference external" href="../context_switch/context_switch.html">Scheduler</a> for more
information on task execution states.) Other tasks (or interrupts) call
the <code class="docutils literal notranslate"><span class="pre">os_eventq_put()</span></code> function to add an event to the queue. The
<code class="docutils literal notranslate"><span class="pre">os_eventq_put()</span></code> function determines whether a task is blocked
waiting for an event on the queue and puts the task into the
<code class="docutils literal notranslate"><span class="pre">ready-to-run</span></code> state.</p>
<p>A task can use the <code class="docutils literal notranslate"><span class="pre">os_eventq_run()</span></code> wrapper function that calls the
<code class="docutils literal notranslate"><span class="pre">os_eventq_get()</span></code> function to dequeue an event from the queue and then
calls the event callback function to process the event.</p>
<p>Note:</p>
<ul class="simple">
<li>Only one task should consume or block waiting for events from an
event queue.</li>
<li>The <a class="reference external" href="../callout/callout.html">os_callout</a> subsystem uses events for
timer expiration notification.</li>
</ul>
</div>
<div class="section" id="data-structures">
<h2>Data structures<a class="headerlink" href="#data-structures" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">os_event</span></code> structure defines an event and has the following
fields:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>struct os_event {
    uint8_t ev_queued;
    os_event_fn *ev_cb;
    void *ev_arg;
    STAILQ_ENTRY(os_event) ev_next;
};
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Element</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">ev_queued</span></code></td>
<td>Internal field that indicates whether this event is currently linked to an event queue</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">ev_cb</span></code></td>
<td>Pointer to the callback function to call to process this event</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">ev_arg</span></code></td>
<td>Pointer to an optional opaque data that the callback function uses to process this event</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">ev_next</span></code></td>
<td>Linkage attaching this event to an event queue</td>
</tr>
</tbody>
</table>
<p>An event callback function has the following function prototype:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>typedef void os_event_fn(struct os_event *ev);
</pre></div>
</div>
<p>A pointer to the <code class="docutils literal notranslate"><span class="pre">os_event</span></code> structure for the event is passed as an
argument to the callback function.</p>
<p>Notes: If the memory for the <code class="docutils literal notranslate"><span class="pre">os_event</span></code> structure is dynamically
allocated:</p>
<ul class="simple">
<li>You must not free the memory for an event that is currently on an
event queue.</li>
<li>You must free the memory in the callback function after it completes
processing the event.</li>
</ul>
<p>You must set the callback function for an event when you initialize the
event. For example, here is an example of a statically-initialized event
in the NimBLE host:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>static void ble_hs_event_tx_notify(struct os_event *ev);

/** OS event - triggers tx of pending notifications and indications. */
static struct os_event ble_hs_ev_tx_notifications = {
    .ev_cb = ble_hs_event_tx_notify,
};
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">os_eventq</span></code> structure defines an event queue and has the following fields:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>struct os_eventq {
    struct os_task *evq_task;
    STAILQ_HEAD(, os_event) evq_list;
};
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Element</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">evq_task</span></code></td>
<td>Pointer to the task, if any, that is waiting (in the <code class="docutils literal notranslate"><span class="pre">sleeping</span></code> state) for the <code class="docutils literal notranslate"><span class="pre">os_eventq_get()</span></code> function to return an event</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">evq_list</span></code></td>
<td>Head of the list of events in this queue</td>
</tr>
</tbody>
</table>
<p>You must call the <code class="docutils literal notranslate"><span class="pre">os_eventq_init()</span></code> function to initialize an event
queue before you can add events to the queue.</p>
</div>
<div class="section" id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">doxygengroup: Cannot find namespace “OSEvent” in doxygen xml output for project “mynewt-core” from directory: mynewt-core-xml</p>
</div>
</div>
</div>


                   </div>
                  </div>
                  
    <div class="rst-footer-buttons row" role="navigation" aria-label="footer navigation">
      
        <a href="../semaphore/semaphore.html" class="btn btn-neutral float-right" title="Semaphore" accesskey="n">Next: Semaphore <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../task/task.html" class="btn btn-neutral" title="Task" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous: Task</a>
      
    </div>

                </div>
              </div>
            </div>
            <!-- ENDS CONTENT SECTION -->
          </div>
          <!-- ENDS .content -->
        </div>
      </div>
      <footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
          
              <p class="copyright">Apache Mynewt is available under Apache License, version 2.0.</p>
          
      </div>
      <div class="col-xs-12">
          <div class="logos">
              <img src="../../../_static/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
              <small class="footnote">
                Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt project logo are either
                registered trademarks or trademarks of the Apache Software Foundation in the United States and other countries.
              </small>
              <a href="https://join.slack.com/mynewt/shared_invite/MTkwMTg1ODM1NTg5LTE0OTYxNzQ4NzQtZTU1YmNhYjhkMg">
                <img src="../../../_static/img/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" />
              </a>
          </div>
      </div>
    </div>
  </div>
</footer>
    </div>
    <!-- ENDS #wrapper -->

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/js/bootstrap-3.0.3.min.js"></script>
      <script type="text/javascript" src="../../../_static/js/affix.js"></script>
      <script type="text/javascript" src="../../../_static/js/main.js"></script>

   

  </body>
</html>