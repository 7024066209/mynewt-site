

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    <title>Write a Test Suite for a Package &mdash; Apache Mynewt 1.3.0 documentation</title>
    

    
    
      <link rel="shortcut icon" href="../../_static/mynewt-logo-only-newt32x32.png"/>
    

    

    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

    
      <link rel="stylesheet" href="../../_static/css/sphinx_theme.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/bootstrap-3.0.3.min.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/v2.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/restructuredtext.css" type="text/css" />
    

    

    <link rel="stylesheet" href="../../_static/css/overrides.css" type="text/css" />
          <link rel="index" title="Index"
                href="../../genindex.html"/>
          <link rel="search" title="Search" href="../../search.html"/>
      <link rel="top" title="Apache Mynewt 1.3.0 documentation" href="../../index.html"/> 

    
    <script src="../../_static/js/modernizr.min.js"></script>

    
    <script>
    (function(i, s, o, g, r, a, m) {
	i["GoogleAnalyticsObject"] = r;
	(i[r] =
		i[r] ||
		function() {
			(i[r].q = i[r].q || []).push(arguments);
		}),
		(i[r].l = 1 * new Date());
	(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
	a.async = 1;
	a.src = g;
	m.parentNode.insertBefore(a, m);
})(window, document, "script", "//www.google-analytics.com/analytics.js", "ga");

ga("create", "UA-72162311-1", "auto");
ga("send", "pageview");
</script>
    

  </head>

  <body class="not-front page-documentation" role="document" >
    <div id="wrapper">
      <div class="container">
    <div id="banner" class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="../../_static/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
              <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.3.0</a> released (December 13, 2017)
            </div>
        </div>
    </div>
</div>
      
<header>
    <nav id="navbar" class="navbar navbar-inverse" role="navigation">
        <div class="container">
            <!-- Collapsed navigation -->
            <div class="navbar-header">
                <!-- Expander button -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <!-- Expanded navigation -->
            <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                    </li>
                    <li class="important">
                        <a href="/get_started/quick_start.html">Quick Start</a>
                    </li>
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    <li>
                        <a href="/talks/">Talks</a>
                    </li>
                    <li class="active">
                        <a href="/documentation/">Documentation</a>
                    </li>
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    <li>
                        <a href="/community/">Community</a>
                    </li>
                    <li>
                        <a href="/events/">Events</a>
                    </li>
                </ul>

                <!-- Search, Navigation and Repo links -->
                <ul class="nav navbar-nav navbar-right">
                    
                </ul>
            </div>
        </div>
    </nav>
</header>
      <!-- STARTS MAIN CONTENT -->
      <div id="main-content">
        





<div id="breadcrumb">
  <div class="container">
    <a href="/documentation/">Docs</a> /
    
    Write a Test Suite for a Package
    
  <div class="sourcelink">
    <a href="https://github.com/apache/mynewt-core/edit/master/docs/os/tutorials/unit_test.rst" class="icon icon-github"
           rel="nofollow"> Edit on GitHub</a>
</div>
  </div>
</div>
        <!-- STARTS CONTAINER -->
        <div class="container">
          <!-- STARTS .content -->
          <div id="content" class="row">
            
            <!-- STARTS .container-sidebar -->
<div class="container-sidebar col-xs-12 col-sm-3">
  <div id="docSidebar" class="sticky-container">
    <div role="search" class="sphinx-search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" class="search-documentation" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    
<!-- Note: only works when deployed -->
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
    <option
      value="/develop"
      selected
      >
      Version: develop (latest - mynewt-documentation)
    </option>
    <option
      value="/latest/os/introduction"
      >
      Version: master (latest - mynewt-site)
    </option>
    <option
      value="/v1_2_0/os/introduction"
      >
      Version: 1.2.0
    </option>
    <option
      value="/v1_1_0/os/introduction">
      Version: 1.1.0
    </option>
    <option
      value="/v1_0_0/os/introduction">
      Version: 1.0.0
    </option>
    <option
      value="/v0_9_0/os/introduction">
      Version: 0_9_0
    </option>
</select>
    <div class="region region-sidebar">
      <div class="docs-menu">
      
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/index.html">Setup &amp; Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../os_user_guide.html">OS User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network/ble/ble_intro.html">BLE User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../newt/index.html">Newt Tool Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../newtmgr/index.html">Newt Manager Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/index.html">Appendix</a></li>
</ul>

        
      
      </div>
    </div>
  </div>
  <!-- ENDS STICKY CONTAINER -->
</div>
<!-- ENDS .container-sidebar -->

            <div class="col-xs-12 col-sm-9">
              <div class="alert alert-info" role="alert">
  <p>
    This is the development version of Apache Mynewt documentation. As such it may not be as complete as the latest
    stable version of the documentation found <a href="/latest/os/introduction/">here</a>.
  </p>
  <p>
    To improve this documentation please visit <a href="https://github.com/apache/mynewt-documentation">https://github.com/apache/mynewt-documentation</a>.
  </p>
</div>
              
              <div class="">
                <div class="rst-content">
                  <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                   <div itemprop="articleBody">
                    
  <div class="section" id="write-a-test-suite-for-a-package">
<h1>Write a Test Suite for a Package<a class="headerlink" href="#write-a-test-suite-for-a-package" title="Permalink to this headline">¶</a></h1>
<p>This document guides the reader through creating a test suite for a
Mynewt package.</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Writing a test suite involves using the
<code class="docutils literal notranslate"><span class="pre">`test/testutil</span></code> &lt;../modules/testutil/testutil.html&gt;`__ package. The
testutil library provides the functionality needed to define test suites
and test cases.</p>
</div>
<div class="section" id="choose-your-package-under-test">
<h2>Choose Your Package Under Test<a class="headerlink" href="#choose-your-package-under-test" title="Permalink to this headline">¶</a></h2>
<p>Choose the package you want to write a test suite for. In this tutorial,
we will use the <code class="docutils literal notranslate"><span class="pre">time/datetime</span></code> in the apache-mynewt-core repo.
Throughout this tutorial, we will be inside the apache-mynewt-core repo
directory, unlike most tutorials which operate from the top-level
project directory.</p>
</div>
<div class="section" id="create-a-test-package">
<h2>Create A Test Package<a class="headerlink" href="#create-a-test-package" title="Permalink to this headline">¶</a></h2>
<p>Typically, a library has only one test package. The convention is name
the test package by appending <code class="docutils literal notranslate"><span class="pre">/test</span></code> to the host library name. For
example, the test package for <code class="docutils literal notranslate"><span class="pre">encoding/json</span></code> is
<code class="docutils literal notranslate"><span class="pre">encoding/json/test</span></code>. The directory structure of the json package is
shown below:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>encoding/json
├── include
│   └── json
│       └── json.h
├── pkg.yml
├── src
│   ├── json_decode.c
│   └── json_encode.c
└── test
    ├── pkg.yml
    └── src
        ├── test_json.c
        ├── test_json.h
        ├── test_json_utils.c
        └── testcases
            ├── json_simple_decode.c
            └── json_simple_encode.c
</pre></div>
</div>
<p>The top-level <code class="docutils literal notranslate"><span class="pre">test</span></code> directory contains the json test package. To
create a test package for the datetime package, we need to create a
similar package called <code class="docutils literal notranslate"><span class="pre">time/datetime/test</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ newt pkg new time/datetime/test -t unittest
Download package template for package type pkg.
Package successfuly installed into /home/me/mynewt-core/time/datetime/test.
</pre></div>
</div>
<p>We now have a test package inside <code class="docutils literal notranslate"><span class="pre">time/datetime</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>time/datetime
├── include
│   └── datetime
│       └── datetime.h
├── pkg.yml
├── src
│   └── datetime.c
└── test
    ├── README.md
    ├── pkg.yml
    ├── src
    │   └── main.c
    └── syscfg.yml
</pre></div>
</div>
<p>There is one modification we need to make to the new package before we
can start writing unit test code. A test package needs access to the
code it will be testing, so we need to add a dependency on
<code class="docutils literal notranslate"><span class="pre">&#64;apache-mynewt-core/time/datetime</span></code> to our <code class="docutils literal notranslate"><span class="pre">pkg.yml</span></code> file:</p>
<p>While we have the <code class="docutils literal notranslate"><span class="pre">pkg.yml</span></code> file open, let’s take a look at what newt
filled in automatically:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">pkg.type:</span> <span class="pre">unittest</span></code> designates this as a test package. A <em>test
package</em> is special in that it can be built and executed using the
<code class="docutils literal notranslate"><span class="pre">newt</span> <span class="pre">test</span></code> command.</li>
<li>A test package always depends on
<code class="docutils literal notranslate"><span class="pre">&#64;apache-mynewt-core/test/testutil</span></code>. The testutil library provides
the tools necessary for verifying package behavior,</li>
<li>The <code class="docutils literal notranslate"><span class="pre">SELFTEST</span></code> suffix indicates that a setting should only be
applied when the <code class="docutils literal notranslate"><span class="pre">newt</span> <span class="pre">test</span></code> command is used.</li>
</ul>
<p>Regarding the conditional dependency on <code class="docutils literal notranslate"><span class="pre">sys/console/stub</span></code>, the
datetime package requires some form of console to function. In a regular
application, the console dependency would be supplied by a higher order
package. Because <code class="docutils literal notranslate"><span class="pre">newt</span> <span class="pre">test</span></code> runs the test package without an
application present, the test package needs to supply all unresolved
dependencies itself when run in self-test mode.</p>
</div>
<div class="section" id="create-your-test-suite-code">
<h2>Create Your Test Suite Code<a class="headerlink" href="#create-your-test-suite-code" title="Permalink to this headline">¶</a></h2>
<p>We will be adding a <em>test suite</em> to the <code class="docutils literal notranslate"><span class="pre">main.c</span></code> file. The test suite
will be empty for now. We also need to invoke the test suite from
<code class="docutils literal notranslate"><span class="pre">main()</span></code>.</p>
<p>Our <code class="docutils literal notranslate"><span class="pre">main.c</span></code> file now looks like this:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>#include &quot;sysinit/sysinit.h&quot;
#include &quot;testutil/testutil.h&quot;

TEST_SUITE(test_datetime_suite) {
    /* Empty for now; add test cases later. */
}

#if MYNEWT_VAL(SELFTEST)
int
main(int argc, char **argv)
{
    /* Initialize all packages. */
    sysinit();

    test_datetime_suite();

    /* Indicate whether all test cases passed. */
    return tu_any_failed;
}
#endif
</pre></div>
</div>
</div>
<div class="section" id="try-it-out">
<h2>Try It Out<a class="headerlink" href="#try-it-out" title="Permalink to this headline">¶</a></h2>
<p>We now have a working test suite with no tests. Let’s make sure we get a
passing result when we run <code class="docutils literal notranslate"><span class="pre">newt</span> <span class="pre">test</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ newt test time/datetime
&lt;build output&gt;
Executing test: /home/me/mynewt-core/bin/targets/unittest/time_datetime_test/app/time/datetime/test/time_datetime_test.elf
Passed tests: [time/datetime/test]
All tests passed
</pre></div>
</div>
</div>
<div class="section" id="create-a-test">
<h2>Create a Test<a class="headerlink" href="#create-a-test" title="Permalink to this headline">¶</a></h2>
<p>To create a test within your test suite, there are two things to do.</p>
<ol class="arabic simple">
<li>Implement the test case function using the <code class="docutils literal notranslate"><span class="pre">testutil</span></code> macros.</li>
<li>Call the test case function from within the test suite.</li>
</ol>
<p>For this tutorial we will create a test case to verify the
<code class="docutils literal notranslate"><span class="pre">datetime_parse()</span></code> function. The <code class="docutils literal notranslate"><span class="pre">datetime_parse()</span></code> function is
declared as follows:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>/**
 * Parses an RFC 3339 datetime string.  Some examples of valid datetime strings
 * are:
 * 2016-03-02T22:44:00                  UTC time (implicit)
 * 2016-03-02T22:44:00Z                 UTC time (explicit)
 * 2016-03-02T22:44:00-08:00            PST timezone
 * 2016-03-02T22:44:00.1                fractional seconds
 * 2016-03-02T22:44:00.101+05:30        fractional seconds with timezone
 *
 * On success, the two output parameters are filled in (tv and tz).
 *
 * @return                      0 on success;
 *                              nonzero on parse error.
 */
int
datetime_parse(const char *input, struct os_timeval *tv, struct os_timezone *tz)
</pre></div>
</div>
<p>Our test case should make sure this function rejects invalid input, and
that it parses valid input correctly. The updated <code class="docutils literal notranslate"><span class="pre">main.c</span></code> file looks
like this:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>#include &quot;sysinit/sysinit.h&quot;
#include &quot;testutil/testutil.h&quot;
#include &quot;os/os_time.h&quot;
#include &quot;datetime/datetime.h&quot;

TEST_SUITE(test_datetime_suite)
{
    test_datetime_parse_simple();
}

TEST_CASE(test_datetime_parse_simple)
{
    struct os_timezone tz;
    struct os_timeval tv;
    int rc;

    /*** Valid input. */

    /* No timezone; UTC implied. */
    rc = datetime_parse(&quot;2017-06-28T22:37:59&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT_FATAL(rc == 0);
    TEST_ASSERT(tv.tv_sec == 1498689479);
    TEST_ASSERT(tv.tv_usec == 0);
    TEST_ASSERT(tz.tz_minuteswest == 0);
    TEST_ASSERT(tz.tz_dsttime == 0);

    /* PDT timezone. */
    rc = datetime_parse(&quot;2013-12-05T02:43:07-07:00&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT_FATAL(rc == 0);
    TEST_ASSERT(tv.tv_sec == 1386236587);
    TEST_ASSERT(tv.tv_usec == 0);
    TEST_ASSERT(tz.tz_minuteswest == 420);
    TEST_ASSERT(tz.tz_dsttime == 0);

    /*** Invalid input. */

    /* Nonsense. */
    rc = datetime_parse(&quot;abc&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT(rc != 0);

    /* Date-only. */
    rc = datetime_parse(&quot;2017-01-02&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT(rc != 0);

    /* Zero month. */
    rc = datetime_parse(&quot;2017-00-28T22:37:59&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT(rc != 0);

    /* 13 month. */
    rc = datetime_parse(&quot;2017-13-28T22:37:59&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT(rc != 0);
}

#if MYNEWT_VAL(SELFTEST)
int
main(int argc, char **argv)
{
    /* Initialize all packages. */
    sysinit();

    test_datetime_suite();

    /* Indicate whether all test cases passed. */
    return tu_any_failed;
}
#endif
</pre></div>
</div>
<p>Take a few minutes to review the above code. Then keep reading for some
specifics.</p>
<div class="section" id="asserting">
<h3>Asserting<a class="headerlink" href="#asserting" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">test/testutil</span></code> package provides two tools for verifying the
correctness of a package:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">TEST_ASSERT</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">TEST_ASSERT_FATAL</span></code></li>
</ul>
<p>Both of these macros check if the supplied condition is true. They
differ in how they behave when the condition is not true. On failure,
<code class="docutils literal notranslate"><span class="pre">TEST_ASSERT</span></code> reports the error and proceeds with the remainder of the
test case. <code class="docutils literal notranslate"><span class="pre">TEST_ASSERT_FATAL</span></code>, on the other hand, aborts the test
case on failure.</p>
<p>The general rule is to only use <code class="docutils literal notranslate"><span class="pre">TEST_ASSERT_FATAL</span></code> when subsequent
assertions depend on the condition being checked. For example, when
<code class="docutils literal notranslate"><span class="pre">datetime_parse()</span></code> is expected to succeed, the return code is checked
with <code class="docutils literal notranslate"><span class="pre">TEST_ASSERT_FATAL</span></code>. If <code class="docutils literal notranslate"><span class="pre">datetime_parse()</span></code> unexpectedly failed,
the contents of the <code class="docutils literal notranslate"><span class="pre">tv</span></code> and <code class="docutils literal notranslate"><span class="pre">tz</span></code> objects would be indeterminate, so
it is desirable to abort the test instead of checking them and reporting
spurious failures.</p>
</div>
<div class="section" id="scaling-up">
<h3>Scaling Up<a class="headerlink" href="#scaling-up" title="Permalink to this headline">¶</a></h3>
<p>The above example is small and self contained, so it is reasonable to
put everything in a single C file. A typical package will need a lot
more test code, and it helps to follow some conventions to maintain
organization. Let’s take a look at a more realistic example. Here is the
directory structure of the <code class="docutils literal notranslate"><span class="pre">fs/nffs/test</span></code> package:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>fs/nffs/test
├── pkg.yml
└── src
    ├── nffs_test.c
    ├── nffs_test.h
    ├── nffs_test_debug.c
    ├── nffs_test_priv.h
    ├── nffs_test_system_01.c
    ├── nffs_test_utils.c
    ├── nffs_test_utils.h
    └── testcases
        ├── append_test.c
        ├── cache_large_file_test.c
        ├── corrupt_block_test.c
        ├── corrupt_scratch_test.c
        ├── gc_on_oom_test.c
        ├── gc_test.c
        ├── incomplete_block_test.c
        ├── large_system_test.c
        ├── large_unlink_test.c
        ├── large_write_test.c
        ├── long_filename_test.c
        ├── lost_found_test.c
        ├── many_children_test.c
        ├── mkdir_test.c
        ├── open_test.c
        ├── overwrite_many_test.c
        ├── overwrite_one_test.c
        ├── overwrite_three_test.c
        ├── overwrite_two_test.c
        ├── read_test.c
        ├── readdir_test.c
        ├── rename_test.c
        ├── split_file_test.c
        ├── truncate_test.c
        ├── unlink_test.c
        └── wear_level_test.c
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">fs/nffs/test</span></code> package follows these conventions:</p>
<ol class="arabic simple">
<li>A maximum of one test case per C file.</li>
<li>Each test case file goes in the <code class="docutils literal notranslate"><span class="pre">testcases</span></code> subdirectory.</li>
<li>Test suites and utility functions go directly in the <code class="docutils literal notranslate"><span class="pre">src</span></code>
directory.</li>
</ol>
<p>Test packages contributed to the Mynewt project should follow these
conventions.</p>
</div>
</div>
<div class="section" id="congratulations">
<h2>Congratulations<a class="headerlink" href="#congratulations" title="Permalink to this headline">¶</a></h2>
<p>Now you can begin the work of validating your packages.</p>
</div>
</div>


                   </div>
                  </div>
                  
                </div>
              </div>
            </div>
            <!-- ENDS CONTENT SECTION -->
          </div>
          <!-- ENDS .content -->
        </div>
      </div>
      <footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
          
              <p class="copyright">Apache Mynewt is available under Apache License, version 2.0.</p>
          
      </div>
      <div class="col-xs-12">
          <div class="logos">
              <img src="../../_static/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
              <small class="footnote">
                Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt project logo are either
                registered trademarks or trademarks of the Apache Software Foundation in the United States and other countries.
              </small>
              <a href="https://join.slack.com/mynewt/shared_invite/MTkwMTg1ODM1NTg5LTE0OTYxNzQ4NzQtZTU1YmNhYjhkMg">
                <img src="../../_static/img/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" />
              </a>
          </div>
      </div>
    </div>
  </div>
</footer>
    </div>
    <!-- ENDS #wrapper -->

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/js/bootstrap-3.0.3.min.js"></script>
      <script type="text/javascript" src="../../_static/js/affix.js"></script>
      <script type="text/javascript" src="../../_static/js/main.js"></script>

   

  </body>
</html>