

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    <title>Config &mdash; Apache Mynewt 1.3.0 documentation</title>
    

    
    
      <link rel="shortcut icon" href="../../../_static/mynewt-logo-only-newt32x32.png"/>
    

    

    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

    
      <link rel="stylesheet" href="../../../_static/css/sphinx_theme.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/bootstrap-3.0.3.min.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/v2.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/restructuredtext.css" type="text/css" />
    

    

    <link rel="stylesheet" href="../../../_static/css/overrides.css" type="text/css" />
          <link rel="index" title="Index"
                href="../../../genindex.html"/>
          <link rel="search" title="Search" href="../../../search.html"/>
      <link rel="top" title="Apache Mynewt 1.3.0 documentation" href="../../../index.html"/> 

    
    <script src="../../../_static/js/modernizr.min.js"></script>

    
    <script>
    (function(i, s, o, g, r, a, m) {
	i["GoogleAnalyticsObject"] = r;
	(i[r] =
		i[r] ||
		function() {
			(i[r].q = i[r].q || []).push(arguments);
		}),
		(i[r].l = 1 * new Date());
	(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
	a.async = 1;
	a.src = g;
	m.parentNode.insertBefore(a, m);
})(window, document, "script", "//www.google-analytics.com/analytics.js", "ga");

ga("create", "UA-72162311-1", "auto");
ga("send", "pageview");
</script>
    

  </head>

  <body class="not-front page-documentation" role="document" >
    <div id="wrapper">
      <div class="container">
    <div id="banner" class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="../../../_static/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
              <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.3.0</a> released (December 13, 2017)
            </div>
        </div>
    </div>
</div>
      
<header>
    <nav id="navbar" class="navbar navbar-inverse" role="navigation">
        <div class="container">
            <!-- Collapsed navigation -->
            <div class="navbar-header">
                <!-- Expander button -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <!-- Expanded navigation -->
            <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                    </li>
                    <li class="important">
                        <a href="/get_started/quick_start.html">Quick Start</a>
                    </li>
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    <li>
                        <a href="/talks/">Talks</a>
                    </li>
                    <li class="active">
                        <a href="/documentation/">Documentation</a>
                    </li>
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    <li>
                        <a href="/community/">Community</a>
                    </li>
                    <li>
                        <a href="/events/">Events</a>
                    </li>
                </ul>

                <!-- Search, Navigation and Repo links -->
                <ul class="nav navbar-nav navbar-right">
                    
                </ul>
            </div>
        </div>
    </nav>
</header>
      <!-- STARTS MAIN CONTENT -->
      <div id="main-content">
        





<div id="breadcrumb">
  <div class="container">
    <a href="/documentation/">Docs</a> /
    
    Config
    
  <div class="sourcelink">
    <a href="https://github.com/apache/mynewt-core/edit/master/docs/os/modules/config/config.rst" class="icon icon-github"
           rel="nofollow"> Edit on GitHub</a>
</div>
  </div>
</div>
        <!-- STARTS CONTAINER -->
        <div class="container">
          <!-- STARTS .content -->
          <div id="content" class="row">
            
            <!-- STARTS .container-sidebar -->
<div class="container-sidebar col-xs-12 col-sm-3">
  <div id="docSidebar" class="sticky-container">
    <div role="search" class="sphinx-search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" class="search-documentation" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    
<!-- Note: only works when deployed -->
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
    <option
      value="/develop"
      selected
      >
      Version: develop (latest - mynewt-documentation)
    </option>
    <option
      value="/latest/os/introduction"
      >
      Version: master (latest - mynewt-site)
    </option>
    <option
      value="/v1_2_0/os/introduction"
      >
      Version: 1.2.0
    </option>
    <option
      value="/v1_1_0/os/introduction">
      Version: 1.1.0
    </option>
    <option
      value="/v1_0_0/os/introduction">
      Version: 1.0.0
    </option>
    <option
      value="/v0_9_0/os/introduction">
      Version: 0_9_0
    </option>
</select>
    <div class="region region-sidebar">
      <div class="docs-menu">
      
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/index.html">Setup &amp; Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../os_user_guide.html">OS User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/ble/ble_intro.html">BLE User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newt/index.html">Newt Tool Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newtmgr/index.html">Newt Manager Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/index.html">Appendix</a></li>
</ul>

        
      
      </div>
    </div>
  </div>
  <!-- ENDS STICKY CONTAINER -->
</div>
<!-- ENDS .container-sidebar -->

            <div class="col-xs-12 col-sm-9">
              <div class="alert alert-info" role="alert">
  <p>
    This is the development version of Apache Mynewt documentation. As such it may not be as complete as the latest
    stable version of the documentation found <a href="/latest/os/introduction/">here</a>.
  </p>
  <p>
    To improve this documentation please visit <a href="https://github.com/apache/mynewt-documentation">https://github.com/apache/mynewt-documentation</a>.
  </p>
</div>
              
              <div class="">
                <div class="rst-content">
                  <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                   <div itemprop="articleBody">
                    
  <div class="section" id="config">
<h1>Config<a class="headerlink" href="#config" title="Permalink to this headline">¶</a></h1>
<p>Config subsystem is meant for persisting per-device configuration
and runtime state for packages.</p>
<p>Configuration items are stored as key-value pairs, where both the key and
the value are expected to be strings. Keys are divided into component
elements, where packages register their subtree using the first element.
E.g key <code class="docutils literal notranslate"><span class="pre">id/serial</span></code> consists of 2 components, <code class="docutils literal notranslate"><span class="pre">id</span></code> and <code class="docutils literal notranslate"><span class="pre">serial</span></code>.
Package sys/id registered it’s subtree of configuration elements to be
under <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
<p>There are convenience routines for converting value back and forth
from string.</p>
<div class="section" id="handlers">
<h2>Handlers<a class="headerlink" href="#handlers" title="Permalink to this headline">¶</a></h2>
<p>Config handlers for subtree implement a set of handler functions.
These are registered using a call to <code class="docutils literal notranslate"><span class="pre">conf_register()</span></code>.</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>ch_get</dt>
<dd>This gets called when somebody asks for a config element value
by it’s name using <code class="docutils literal notranslate"><span class="pre">conf_get_value()</span></code>.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>ch_set</dt>
<dd>This is called when value is being set using <code class="docutils literal notranslate"><span class="pre">conf_set_value()</span></code>, and
also when configuration is loaded from persisted storage with
<code class="docutils literal notranslate"><span class="pre">conf_load()</span></code>.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>ch_commit</dt>
<dd>This gets called after configuration has been loaded in full.
Sometimes you don’t want individual configuration value to take
effect right away, for example if there are multiple settings
which are interdependent.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>ch_export</dt>
<dd>This gets called to dump all current configuration. This happens
when <code class="docutils literal notranslate"><span class="pre">conf_save()</span></code> tries to save the settings, or when CLI is
dumping current system configuration to console.</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="persistence">
<h2>Persistence<a class="headerlink" href="#persistence" title="Permalink to this headline">¶</a></h2>
<p>Backend storage for the config can be either FCB, a file in filesystem,
or both.</p>
<p>You can declare multiple sources for configuration; settings from
all of these are restored when <code class="docutils literal notranslate"><span class="pre">conf_load()</span></code> is called.</p>
<p>There can be only one target for writing configuration; this is where
data is stored when you call <code class="docutils literal notranslate"><span class="pre">conf_save()</span></code>, or conf_save_one().</p>
<p>FCB read target is registered using <code class="docutils literal notranslate"><span class="pre">conf_fcb_src()</span></code>, and write target
using <code class="docutils literal notranslate"><span class="pre">conf_fcb_dst()</span></code>. <code class="docutils literal notranslate"><span class="pre">conf_fcb_src()</span></code> as side-effect initializes the
FCB area, so it must be called when calling <code class="docutils literal notranslate"><span class="pre">conf_fcb_dst()</span></code>.
File read target is registered using <code class="docutils literal notranslate"><span class="pre">conf_file_src()</span></code>, and write target
<code class="docutils literal notranslate"><span class="pre">conf_file_dst()</span></code>.</p>
<p>Convenience initialization of one config area can be enabled by
setting either syscfg variable CONFIG_FCB or CONFIG_NFFS. These
use other syscfg variables to figure which flash_map entry of BSP
defines flash area, or which file to use. Check the syscfg.yml in
sys/config package for more detailed description.</p>
</div>
<div class="section" id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this headline">¶</a></h2>
<p>This can be enabled when shell package is enabled by setting syscfg
variable CONFIG_CLI to 1.</p>
<p>Here you can set config variables, inspect their values and print
both saved configuration as well as running configuration.</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>config dump</dt>
<dd>Dump the current running configuration</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>config dump saved</dt>
<dd>Dump the saved configuration. The values are printed in the ordered
they’re restored.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>config &lt;key&gt;</dt>
<dd>Print the value of config variable identified by &lt;key&gt;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>config &lt;key&gt; &lt;value&gt;</dt>
<dd>Set the value of config variable &lt;key&gt; to be &lt;value&gt;</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="example-device-configuration">
<h2>Example: Device Configuration<a class="headerlink" href="#example-device-configuration" title="Permalink to this headline">¶</a></h2>
<p>This is a simple example, config handler only implements <code class="docutils literal notranslate"><span class="pre">ch_set</span></code> and
<code class="docutils literal notranslate"><span class="pre">ch_export</span></code>. <code class="docutils literal notranslate"><span class="pre">ch_set</span></code> is called when value is restored from storage (or
when set initially), and <code class="docutils literal notranslate"><span class="pre">ch_export</span></code> is used to write the value to
storage (or dump to console).</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>static int8 foo_val;

struct conf_handler my_conf = {
    .ch_name = &quot;foo&quot;,
    .ch_set = foo_conf_set,
    .ch_export = foo_conf_export
}

static int
foo_conf_set(int argc, char **argv, char *val)
{
     if (argc == 1) {
          if (!strcmp(argv[0], &quot;bar&quot;)) {
                 return CONF_VALUE_SET(val, CONF_INT8, foo_val);
          }
     }
     return OS_ENOENT;
}

static int
foo_conf_export(void (*func)(char *name, char *val), enum conf_export_tgt tgt)
{
    char buf[4];

    conf_str_from_value(CONF_INT8, &amp;foo_val, buf, sizeof(buf));
    func(&quot;foo/bar&quot;, buf)
    return 0;
}
</pre></div>
</div>
</div>
<div class="section" id="example-persist-runtime-state">
<h2>Example: Persist Runtime State<a class="headerlink" href="#example-persist-runtime-state" title="Permalink to this headline">¶</a></h2>
<p>This is a simple example showing how to persist runtime state. Here
there is only <code class="docutils literal notranslate"><span class="pre">ch_set</span></code> defined, which is used when restoring value from
persisted storage.</p>
<p>There’s a os_callout function which increments foo_val, and then
persists the latest number. When system restarts, and calls <code class="docutils literal notranslate"><span class="pre">conf_load()</span></code>,
foo_val will continue counting up from where it was before restart.</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>static int8 foo_val;

struct conf_handler my_conf = {
    .ch_name = &quot;foo&quot;,
    .ch_set = foo_conf_set
}

static int
foo_conf_set(int argc, char **argv, char *val)
{
     if (argc == 1) {
          if (!strcmp(argv[0], &quot;bar&quot;)) {
                 return CONF_VALUE_SET(val, CONF_INT8, foo_val);
          }
     }
     return OS_ENOENT;
}

static void
foo_callout(struct os_event *ev)
{
    struct os_callout *c = (struct os_callout *)ev;
    char buf[4];

    foo_val++;
    conf_str_from_value(CONF_INT8, &amp;foo_val, buf, sizeof(buf));
    conf_save_one(&quot;foo/bar&quot;, bar);

    callout_reset(c, OS_TICKS_PER_SEC * 120);
}
</pre></div>
</div>
</div>
<div class="section" id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">doxygengroup: Cannot find namespace “sys_config” in doxygen xml output for project “mynewt-core” from directory: mynewt-core-xml</p>
</div>
</div>
</div>


                   </div>
                  </div>
                  
                </div>
              </div>
            </div>
            <!-- ENDS CONTENT SECTION -->
          </div>
          <!-- ENDS .content -->
        </div>
      </div>
      <footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
          
              <p class="copyright">Apache Mynewt is available under Apache License, version 2.0.</p>
          
      </div>
      <div class="col-xs-12">
          <div class="logos">
              <img src="../../../_static/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
              <small class="footnote">
                Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt project logo are either
                registered trademarks or trademarks of the Apache Software Foundation in the United States and other countries.
              </small>
              <a href="https://join.slack.com/mynewt/shared_invite/MTkwMTg1ODM1NTg5LTE0OTYxNzQ4NzQtZTU1YmNhYjhkMg">
                <img src="../../../_static/img/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" />
              </a>
          </div>
      </div>
    </div>
  </div>
</footer>
    </div>
    <!-- ENDS #wrapper -->

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/js/bootstrap-3.0.3.min.js"></script>
      <script type="text/javascript" src="../../../_static/js/affix.js"></script>
      <script type="text/javascript" src="../../../_static/js/main.js"></script>

   

  </body>
</html>