<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://mynewt.incubator.apache.org/os/mutex/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Mutexes - Mynewt Testing</title>

        <link href="../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../css/custom.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900,300,100' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'mynewt.incubator.apache.org');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Mutexes">


        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="logo-container">
        <img src="http://mynewt.incubator.apache.org/img/logo.svg">
    </div>
    <div class="container-fluid">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="http://mynewt.incubator.apache.org/">Home</a>
                </li>
                <li>
                    <a href="http://mynewt.incubator.apache.org/documentation/">Docs</a>
                </li>
                <li>
                    <a href="http://mynewt.incubator.apache.org/download/">Download</a>
                </li>
                <li>
                    <a href="http://mynewt.incubator.apache.org/community/">Community</a>
                </li>
                <li>
                    <a href="http://mynewt.incubator.apache.org/events/">Events</a>
                </li>
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
    </div>
</div>

        <div class="container-fluid">
            
                <div class="row sm-extra-padding">
                    <div class="col-md-3 bg-grey sidebar-container"><div class="bs-sidebar hidden-print" role="complementary">    
    <div class="sidebar-top">
        <img class="hidden-xs hidden-sm logo-small" src="http://mynewt.incubator.apache.org/img/logo.svg" alt="MyNewt" title="MyNewt">
        <div class="small" role="search">
            <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" placeholder="Search documentation" />
                    <button class="search-button" type="submit"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>
    <ul class="nav bs-sidenav">
        
            
        
            
        
            
        
            
        
            
        
            
                <li class="main"><a href="../../get_started/newt_concepts/">Chapter 1 - Get Started</a></li>
                
            
        
            
                <li class="main"><a href="../../get_acclimated/vocabulary/">Chapter 2 - Get Acclimated</a></li>
                
            
        
            
                <li class="main"><a href="../../newt/newt_ops/">Chapter 3 - Newt Tool</a></li>
                
            
        
            
                <li class="main"><a href="../mynewt_os/">Chapter 4 - Mynewt OS</a></li>
                
                    <ul class="current-toc">
                        
                            <li class="toctree-l2"><a href="../mynewt_os/">Overview</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../context_switch/">Scheduler/Context Switching</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../time/">Time</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../task/">Tasks</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../event_queue/">Event Queues</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../semaphore/">Semaphores</a></li>
                            
                        
                            <li class="toctree-l2"><a href="./">Mutexes</a></li>
                            
                                
                                    
                                        <li class="toctree-l3"><a href="#description">Description</a></li>
                                    
                                        <li class="toctree-l3"><a href="#data-structures">Data structures</a></li>
                                    
                                        <li class="toctree-l3"><a href="#list-of-functions">List of Functions</a></li>
                                    
                                        <li class="toctree-l3"><a href="#function-reference">Function Reference</a></li>
                                    
                                        <li class="toctree-l3"><a href="#os_mutex_init">os_mutex_init</a></li>
                                    
                                        <li class="toctree-l3"><a href="#os_mutex_release">os_mutex_release</a></li>
                                    
                                        <li class="toctree-l3"><a href="#os_mutex_pend">os_mutex_pend </a></li>
                                    
                                        <li class="toctree-l3"><a href="#os_mutex_delete">os_mutex_delete </a></li>
                                    
                                
                            
                        
                            <li class="toctree-l2"><a href="../memory_pool/">Memory Pools</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../heap/">Heap</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../mbufs/">Mbufs</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../sanity/">Sanity</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../callout/">Callout Functions</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../port_os/">Porting to other Platforms</a></li>
                            
                        
                    </ul>
                
            
        
            
                <li class="main"><a href="../../modules/console/">Chapter 5 - Modules</a></li>
                
            
        
            
                <li class="main"><a href="../../newtmgr/overview/">Chapter 6 - Newt Manager</a></li>
                
            
        
            
                <li class="main"><a href="../../packaging/dist/">Chapter 7 - Packaging it</a></li>
                
            
        
    </ul>
</div></div>
                    
                    <div class="show-sidebar-container">
                        <button class="show-sidebar">Docs Menu</button>
                    </div>
                    
                    <div class="col-md-9 documentation-viewer" role="main">
                        <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Chapter 4 - Mynewt OS &raquo;</li>
        
      
    
    <li>Mutexes</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
                        
                            <h1 id="mutex">Mutex<a class="headerlink" href="#mutex" title="Permanent link">&para;</a></h1>
<p>Mutex is short for "mutual exclusion"; a mutex provides mutually exclusive access to a shared resource. A mutex provides <em>priority inheritance</em> in order to prevent <em>priority inversion</em>. Priority inversion occurs when a higher priority task is waiting on a resource owned by a lower priority task. Using a mutex, the lower priority task will inherit the highest priority of any task waiting on the mutex. </p>
<h2 id="description">Description<a class="headerlink" href="#description" title="Permanent link">&para;</a></h2>
<p>The first order of business when using a mutex is to declare the mutex globally. The mutex needs to be initialized before it is used (see the examples). It is generally a good idea to initialize the mutex before tasks start running in order to avoid a task possibly using the mutex before it is initialized.</p>
<p>When a task wants exclusive access to a shared resource it needs to obtain the mutex by calling <em>os_mutex_pend</em>. If the mutex is currently owned by a different task (a lower priority task), the requesting task will be put to sleep and the owners priority will be elevated to the priority of the requesting task. Note that multiple tasks can request ownership and the current owner is elevated to the highest priority of any task waitin on the mutex. When the task is done using the shared resource, it needs to release the mutex by called <em>os_mutex_release</em>. There needs to be one release per call to pend. Note that nested calls to <em>os_mutex_pend</em> are allowed but there needs to be one release per pend.</p>
<p>The following example will illustrate how priority inheritance works. In this example, the task number is the same as its priority. Remember that the lower the number, the higher the priority (i.e. priority 0 is higher priority than priority 1). Suppose that task 5 gets ownership of a mutex but is preempted by task 4. Task 4 attempts to gain ownership of the mutex but cannot as it is owned by task 5. Task 4 is put to sleep and task 5 is temporarily raised to priority 4. Before task 5 can release the mutex, task 3 runs and attempts to acquire the mutex. At this point, both task 3 and task 4 are waiting on the mutex (sleeping). Task 5 now runs at priority 3 (the highest priority of all the tasks waiting on the mutex). When task 5 finally releases the mutex it will be preempted as two higher priority tasks are waiting for it. </p>
<p>Note that when multiple tasks are waiting on a mutex owned by another task, once the mutex is released the highest priority task waiting on the mutex is run. </p>
<h2 id="data-structures">Data structures<a class="headerlink" href="#data-structures" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">struct os_mutex
{
    SLIST_HEAD(, os_task) mu_head;
    uint8_t     _pad;
    uint8_t     mu_prio;
    uint16_t    mu_level;
    struct os_task *mu_owner;
};
</code></pre>

<table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mu_head</td>
<td>Queue head for list of tasks waiting on mutex</td>
</tr>
<tr>
<td>_pad</td>
<td>Padding</td>
</tr>
<tr>
<td>mu_prio</td>
<td>Default priority of owner of mutex. Used to reset priority of task when mutex released</td>
</tr>
<tr>
<td>mu_level</td>
<td>Call nesting level (for nested calls)</td>
</tr>
<tr>
<td>mu_owner</td>
<td>Pointer to task structure which owns mutex</td>
</tr>
</tbody>
</table>
<h2 id="list-of-functions">List of Functions<a class="headerlink" href="#list-of-functions" title="Permanent link">&para;</a></h2>
<p><List all the functions here. Note how the anchors work. You put the text you want to show up as a link within [] and the relevant #heading within (). Note that the words of the heading need to be connected with a dash for the anchor to work. Hence the word "function" and the function name is connected with a dash, not underscore! And the header has to have at least 2 words for the anchor to work - that's how it is.></p>
<p>The functions available in this OS feature are:</p>
<ul>
<li><a href="#os_mutex_init">os_mutex_init</a></li>
<li><a href="#os_mutex_release">os_mutex_release</a></li>
<li><a href="#os_mutex_pend">os_mutex_pend</a></li>
<li><a href="#os_mutex_delete">os_mutex_delete</a></li>
</ul>
<h2 id="function-reference">Function Reference<a class="headerlink" href="#function-reference" title="Permanent link">&para;</a></h2>
<hr />
<h2 id="os_mutex_init"><font color="#F2853F" style="font-size:24pt">os_mutex_init</font><a class="headerlink" href="#os_mutex_init" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">os_error_t os_mutex_init(struct os_mutex *mu)
</code></pre>

<p>Initialize the mutex. Must be called before the mutex can be used.</p>
<h4 id="arguments">Arguments<a class="headerlink" href="#arguments" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>*mu</td>
<td>Pointer to mutex</td>
</tr>
</tbody>
</table>
<h4 id="returned-values">Returned values<a class="headerlink" href="#returned-values" title="Permanent link">&para;</a></h4>
<p>OS_INVALID_PARM: returned when *mu is NULL on entry.</p>
<p>OS_OK: mutex initialized successfully.</p>
<h4 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">&para;</a></h4>
<p><Any special feature/special benefit that we want to tout. 
Does it need to be used with some other specific functions?
Any caveats to be careful about (e.g. high memory requirements).></p>
<h4 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h4>
<pre><code class="no-highlight">struct os_mutex g_mutex1;
os_error_t err;

err = os_mutex_init(&amp;g_mutex1);
assert(err == OS_OK);
</code></pre>

<hr />
<h2 id="os_mutex_release"><font color="#F2853F" style="font-size:24pt">os_mutex_release</font><a class="headerlink" href="#os_mutex_release" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">os_error_t os_mutex_release(struct os_mutex *mu)
</code></pre>

<p>Release ownership of a mutex</p>
<h4 id="arguments_1">Arguments<a class="headerlink" href="#arguments_1" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>*mu</td>
<td>Pointer to mutex</td>
</tr>
</tbody>
</table>
<h4 id="returned-values_1">Returned values<a class="headerlink" href="#returned-values_1" title="Permanent link">&para;</a></h4>
<p>OS_INVALID_PARM: returned when *mu is NULL on entry.</p>
<p>OS_OK: mutex initialized successfully.</p>
<p>OS_BAD_MUTEX: The mutex was not owned by the task attempting to release it.</p>
<p>OS_NOT_STARTED: Attempt to release a mutex before the os has been started.</p>
<h4 id="example_1">Example<a class="headerlink" href="#example_1" title="Permanent link">&para;</a></h4>
<pre><code class="no-highlight">struct os_mutex g_mutex1;
os_error_t err;

err = os_mutex_pend(&amp;g_mutex1, 0);
assert(err == OS_OK);

/* Perform operations requiring exclusive access */

err = os_mutex_release(&amp;g_mutex1);
assert(err == OS_OK);
</code></pre>

<hr />
<h2 id="os_mutex_pend"><font color="#F2853F" style="font-size:24pt">os_mutex_pend </font><a class="headerlink" href="#os_mutex_pend" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">os_error_t os_mutex_pend(struct os_mutex *mu, uint32_t timeout) 
</code></pre>

<p>Acquire ownership of a mutex.</p>
<h4 id="arguments_2">Arguments<a class="headerlink" href="#arguments_2" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>*mu</td>
<td>Pointer to mutex</td>
</tr>
<tr>
<td>timeout</td>
<td>Timeout, in os ticks. A value of 0 means no timeout. A value of 0xFFFFFFFF means to wait forever.</td>
</tr>
</tbody>
</table>
<h4 id="returned-values_2">Returned values<a class="headerlink" href="#returned-values_2" title="Permanent link">&para;</a></h4>
<p>OS_INVALID_PARM: returned when *mu is NULL on entry.</p>
<p>OS_OK: mutex was successfully acquired.</p>
<p>OS_TIMEOUT: the mutex was not available within the timeout specified.</p>
<p>OS_NOT_STARTED: Attempt to release a mutex before the os has been started.</p>
<h4 id="notes_1">Notes<a class="headerlink" href="#notes_1" title="Permanent link">&para;</a></h4>
<p>If the mutex is owned by another task and the timeout is 0 the function returns immediately with the error code OS_TIMEOUT. The calling task <em>does not</em> own the mutex when this occurs.</p>
<h4 id="example_2">Example<a class="headerlink" href="#example_2" title="Permanent link">&para;</a></h4>
<pre><code class="no-highlight">struct os_mutex g_mutex1;
os_error_t err;

err = os_mutex_pend(&amp;g_mutex1, 0);
assert(err == OS_OK);

/* Perform operations requiring exclusive access */

err = os_mutex_release(&amp;g_mutex1);
assert(err == OS_OK);
</code></pre>

<hr />
<h2 id="os_mutex_delete"><font color="#F2853F" style="font-size:24pt">os_mutex_delete </font><a class="headerlink" href="#os_mutex_delete" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">os_error_t os_mutex_pend(struct os_mutex *mu)
</code></pre>

<p>Delete a mutex</p>
<h4 id="arguments_3">Arguments<a class="headerlink" href="#arguments_3" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>*mu</td>
<td>Pointer to mutex</td>
</tr>
</tbody>
</table>
<h4 id="returned-values_3">Returned values<a class="headerlink" href="#returned-values_3" title="Permanent link">&para;</a></h4>
<p>OS_INVALID_PARM: returned when *mu is NULL on entry.</p>
<p>OS_OK: mutex initialized successfully.</p>
<p>OS_NOT_STARTED: Attempt to release a mutex before the os has been started.</p>
<h4 id="example_3">Example<a class="headerlink" href="#example_3" title="Permanent link">&para;</a></h4>
<pre><code class="no-highlight">struct os_mutex g_mutex1;
os_error_t err;

err = os_mutex_delete(&amp;g_mutex1);
assert(err == OS_OK);
</code></pre>

<hr />
                        
                    </div>
                </div>
            
            <div class="row">    
                <footer>
    <div class="row">
        <div class="col-md-12">
            
                <p class="copyright">Copyright &copy; 2015 The Apache Software Foundation, Licensed under the Apache License, Version 2.0 Apache and the Apache feather logo are trademarks of The Apache Software Foundation.<br>The Apache Software Foundation Apache Incubator</p>
            
        </div>
    </div>
    <div class="copyright-logos">
        <div class="row">
            <div class="col-xs-6 text-right">
                <img src="http://mynewt.incubator.apache.org/img/apache-feather.png" alt="Apache" title="Apache">
            </div>
            <div class="col-xs-6 text-left">
                <img src="http://mynewt.incubator.apache.org/img/apache-logo.png" alt="Apache Incubator" title="Apache Incubator">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
        </div>
    </div>
</footer>
            </div>
        </div>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../js/custom.js"></script>

    </body>
</html>