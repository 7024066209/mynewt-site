<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://mynewt.apache.org/os/modules/hal/hal_creation/">
        <link rel="shortcut icon" href="../../../../img/favicon.ico">

	<title>Creating - Apache Mynewt</title>

        <link href="../../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../../../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../../css/highlight.css">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link href="../../../../css/custom.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900,300,100' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'mynewt.incubator.apache.org');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Creating">


        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="logo-container">
        <img src="/img/logo.svg">
    </div>
    <div class="container-fluid">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/documentation/">Docs</a>
                </li>
                <li>
                    <a href="/download/">Download</a>
                </li>
                <li>
                    <a href="/community/">Community</a>
                </li>
                <li>
                    <a href="/events/">Events</a>
                </li>
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
    </div>
</div>

        <div class="container-fluid">
            
                <div class="row sm-extra-padding">
                    <div class="col-md-3 bg-grey sidebar-container"><div class="bs-sidebar hidden-print" role="complementary">
    <div class="sidebar-top">
        <img class="hidden-xs hidden-sm logo-small" src="/img/logo.svg" alt="MyNewt" title="MyNewt">
        <div class="small" role="search">
            <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" placeholder="Search documentation" />
                    <button class="search-button" type="submit"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>
    <ul class="nav bs-sidenav">
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  <li><a href="
  ../../../get_started/introduction/
">Apache Mynewt Manual</a>
    
      <ul class="current-toc">
          
              
  
    <li>
      <a href="../../../get_started/introduction/">Introduction</a>
    </li>
  

          
              
  
  <li><a href="
  ../../../get_started/project1/
">Get Started</a>
    
  </li>

          
              
  
  <li><a href="
  ../../../tutorials/STM32F303/
">Tutorials</a>
    
  </li>

          
              
  
  <li><a href="
  
  
  
  
  ../../../core_os/mynewt_os/


">OS User Guide</a>
    
      <ul class="current-toc">
          
              
  
  <li><a href="
  
  
  ../../../core_os/mynewt_os/

">OS Core</a>
    
  </li>

          
              
  
  <li><a href="
  ../../../core_os/porting/port_os/
">Porting to your Platform</a>
    
  </li>

          
              
  
  <li><a href="
  ../../console/console/
">Console</a>
    
  </li>

          
              
  
  <li><a href="
  ../../shell/shell/
">Shell</a>
    
  </li>

          
              
  
  <li><a href="
  ../../bootloader/bootloader/
">Bootloader</a>
    
  </li>

          
              
  
  <li><a href="
  
  
  ../../fs/fs/fs/

">File System</a>
    
  </li>

          
              
  
  <li><a href="
  ../hal/
">Hardware Abstraction Layer</a>
    
      <ul class="current-toc">
          
              
  
    <li>
      <a href="../hal/">Overview</a>
    </li>
  

          
              
  
  <li><a href="
  ../hal_api/
">API</a>
    
  </li>

          
              
  
    <li>
      <a href="../hal_in_libraries/">Using</a>
    </li>
  

          
              
  
    <li class="active">
      Creating
    </li>
  

          
      </ul>
    
  </li>

          
              
  
  <li><a href="
  ../../testutil/testutil/
">Test Utilities</a>
    
  </li>

          
              
  
  <li><a href="
  ../../imgmgr/imgmgr/
">Image Manager</a>
    
  </li>

          
              
  
    <li>
      <a href="../../baselibc/">Baselibc library</a>
    </li>
  

          
              
  
  <li><a href="
  ../../elua/elua/
">Embedded Lua</a>
    
  </li>

          
              
  
  <li><a href="
  ../../json/json/
">JSON</a>
    
  </li>

          
      </ul>
    
  </li>

          
              
  
  <li><a href="
  
  
  ../../../../network/ble/ble_intro/

">Networking User Guide</a>
    
  </li>

          
      </ul>
    
  </li>

        
      
        
          
  
  <li><a href="
  ../../../../newt/newt_intro/
">Newt Tool Manual</a>
    
  </li>

        
      
        
          
  
  <li><a href="
  ../../../../newtmgr/overview/
">Newt Manager Manual</a>
    
  </li>

        
      
    </ul>
</div></div>
                    
                    <div class="show-sidebar-container">
                        <button class="show-sidebar">Docs Menu</button>
                    </div>
                    
                    <div class="col-md-9 documentation-viewer" role="main">
                        <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../..">Docs</a> &raquo;</li>
    
      
        
          <li>OS User Guide &raquo;</li>
        
      
        
          <li>Hardware Abstraction Layer &raquo;</li>
        
      
    
    <li>Creating</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
                        
                            <h1 id="creating-new-hal-interfaces">Creating New HAL Interfaces<a class="headerlink" href="#creating-new-hal-interfaces" title="Permanent link">&para;</a></h1>
<h2 id="hal-api">HAL API<a class="headerlink" href="#hal-api" title="Permanent link">&para;</a></h2>
<p>A HAL always includes header file with function declarations 
for the HAL functionality in <code>/hw/hal/include/hal</code>.
The first argument of all functions in the interface include the virtual 
device_id of the device you are controlling.  </p>
<p>For example, in <a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_gpio.h"><code>hal_gpio.h</code></a> 
the device enumeration is the first argument to all methods and called <code>pin</code>.</p>
<pre><code class="no-highlight">    void hal_gpio_set(int pin);
</code></pre>

<p>The device_id (in this case called <code>pin</code>) is not a physical device 
(actual hardware pin), but a virtual pin which is defined by the 
implementation of the HAL (and documented in the implementation of the HAL)</p>
<p>Below this, there are two different paradigms for HAL interface.  They are 
discussed below.</p>
<h2 id="direct-hal-interface">Direct HAL Interface<a class="headerlink" href="#direct-hal-interface" title="Permanent link">&para;</a></h2>
<p>In one HAL paradigm called <strong>direct HAL</strong>, the header file is the only component 
of the HAL interface.   Implementers of this HAL would create a source file
that implements these methods.  </p>
<p>This has the advantage of being simple, small, and low execution overhead.</p>
<p>It has the disadvantage that its not possible to have two different implementations
of the same <strong>direct HAL</strong> within the same image. Said another way, if I create
a <strong>direct HAL</strong> <code>hal_foo.h</code>, there can be many implementations of 
<code>xxx/hal_foo.c</code> but only one can be included in a project.  </p>
<p>For example, support there is an ADC attached directly to the MCU and an ADC
that is attached via SPI.  There would be no way in this simple paradigm
to use both these devices from the HAL API at the same time.</p>
<p>This brings up the second paradigm.</p>
<h2 id="indirect-hal-interface">Indirect HAL Interface<a class="headerlink" href="#indirect-hal-interface" title="Permanent link">&para;</a></h2>
<p>The second paradigm, <strong>indirect HAL</strong>  preserves the simple function 
API with enumerated device_id but adds a small layer of code in the 
HAL to allow different implementations to connect at runtime.</p>
<p>The abstract interface contains three components:</p>
<ul>
<li>A header file <code>hal_foo.h</code> that includes the API above with a <code>device_id</code></li>
<li>An implementation <code>hal/hal_foo.c</code> which maps the <code>device_id</code> to 
a driver interface structure.  </li>
<li>A driver interface structure that is defined for the underlying implementation</li>
</ul>
<p>Using this simple model, the user can be exposed to a simple function 
interface (without structures or function pointers) and the system can provide
a different software implementation for each device id.</p>
<p>Although the GPIO interface for Mynewt uses the <strong>direct HAL</strong>, we can describe
what it might look like for an indirect HAL.  </p>
<p>The API <code>hal_gpio.h</code> is identical with a direct or indirect HAL.</p>
<p>In the indirect HAL there is an additional header file <code>hal_gpio_int.h</code>
 which describes the driver interface for underlying implementations.  It 
looks similar to the HAL API except is driven by function pointers.</p>
<pre><code class="no-highlight">struct hal_gpio_funcs {
    void (*hgpio_set)(void);
    . . .
};

struct hal_gpio_int {
    struct hal_gpio_funcs funcs;
}

const struct hal_gpio_int *bsp_gpio_dev(uint8_t pin);
</code></pre>

<p>The BSP specific function is what will map the specific pin (device_id) 
to its implementation.</p>
<p>This is different than the <strong>direct HAL</strong> which maps this virtual/physical 
device pairing in the MCU implementation.  For the <strong>indirect HAL</strong> the 
mapping has to be done in the BSP since that is the place where multiple 
disparate devices can be enumerated into a single <code>device_id</code> space.</p>
<p>An interface file <code>hal/hal_gpio.c</code> would perform the mapping as 
follows:</p>
<pre><code class="no-highlight">    void hal_gpio_set(int pin) {
        const struct hal_gpio_int *pgpio;
        pgpio = bsp_get_gpio_device(pin);
        if(pgpio) {
            pgpio-&gt;funcs.set();
        }
    }
</code></pre>

<p>The implementer of GPIO functionality (say in <code>mcu/xxx/hal_gpio.c</code>) would 
implement the structure and provide the function pointers.</p>
<pre><code class="no-highlight">void xxx_hal_gpio_set(void) {
    /* implementation for this particular gpio device */
    . . .
}

struct hal_gpio_int xxx_hal_gpio = {
    .funcs.hgpio_set = xxx_hal_gpio_set;
}
</code></pre>

<p>This leaves the BSP implementation to complete the function </p>
<pre><code class="no-highlight">const struct hal_gpio_int *bsp_gpio_dev(uint8_t pin) {
    switch(pin) {
        case 0:
            return &amp;xxx_hal_gpio;
        case 1:
            return &amp;yyy_hal_gpio;
    }
    return NULL;
}
</code></pre>

<p><strong>NOTE</strong>: In this example there could be 10s of GPIO. It may be memory inefficient
to have that many <code>hal_gpio_int</code> structures around to basically call the 
same functions.  In Mynewt today, the hal_gpio is a <strong>direct HAL</strong> and does 
not have this overhead. More HAL paradigms may be added in the future to address 
the flexibility of the <strong>indirect HAL</strong> with the memory efficiency of the <strong>direct HAL</strong></p>
                        
                    </div>
                </div>
            
            <div class="row">    
                <footer>
    <div class="row">
        <div class="col-md-12">
            
                <p class="copyright">Copyright &copy; 2015 The Apache Software Foundation, Licensed under the Apache License, Version 2.0 Apache and the Apache feather logo are trademarks of The Apache Software Foundation.<br>The Apache Software Foundation Apache Incubator</p>
            
        </div>
    </div>
    <div class="copyright-logos">
        <div class="row">
            <div class="col-xs-6 text-right">
                <img src="/img/apache-feather.png" alt="Apache" title="Apache">
            </div>
            <div class="col-xs-6 text-left">
                <img src="/img/apache-logo.png" alt="Apache Incubator" title="Apache Incubator">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
        </div>
    </div>
</footer>
            </div>
        </div>

        <script src="../../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../../js/highlight.pack.js"></script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../js/custom.js"></script>

    </body>
</html>