<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://mynewt.apache.org/os/modules/stats/stats/">
        <link rel="shortcut icon" href="../../../../img/favicon.ico">

	<title>toc - Apache Mynewt</title>

        <link href="../../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../../../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../../css/highlight.css">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link href="../../../../css/custom.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900,300,100' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'mynewt.incubator.apache.org');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="toc">


        <div id="navbar" class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="logo-container">
        <img src="/img/logo.svg">
    </div>
    <div class="container-fluid">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li class="dropdown">
                    <a href="/documentation/" class="dropdown-toggle" data-toggle="dropdown">Docs <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        
                        
                        
                        
                        <li >
                            <a href="../../../../documentation/">
                                Overview
                            </a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="active">
                            <a href="../../../get_started/introduction/">
                                Mynewt OS Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../../newt/newt_intro/">
                                Newt Tool Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../../newtmgr/overview/">
                                Newt Manager Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../../faq/answers/">
                                Appendix
                            </a>
                        </li>
                        
                        
                    </ul>
                </li>
                <li>
                    <a href="/download/">Download</a>
                </li>
                <li>
                    <a href="/community/">Community</a>
                </li>
                <li>
                    <a href="/events/">Events</a>
                </li>
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
    </div>
</div>

        

        <div class="container-fluid">
            
                <div class="row sm-extra-padding">
                    <div id="docSidebar" class="col-md-3 bg-grey sidebar-container"><div class="bs-sidebar hidden-print" role="complementary">
    <div class="sidebar-top">
        <img class="hidden-xs hidden-sm logo-small" src="/img/logo.svg" alt="MyNewt" title="MyNewt">
        <div class="small" role="search">
            <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" placeholder="Search documentation" />
                    <button class="search-button" type="submit"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>
    <ul class="nav bs-sidenav">
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  
    <li><a href="
  ../../../get_started/introduction/
">Mynewt OS Manual</a>
  
    
      <ul class="current-toc">
          
              
                
  
    <li>
      <a href="../../../get_started/introduction/">Introduction</a>
    </li>
  

              
          
              
                
  
  
    <li ><a href="../../../get_started/get_started/">Quick Start</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../get_started/vocabulary/">Concepts</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../tutorials/tutorials/">Tutorials</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../os_user_guide/">OS User Guide</a></li>
  
    
      <ul class="current-toc">
          
              
          
              
                
  
  
    <li ><a href="../../../core_os/mynewt_os/">OS Core</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../core_os/porting/port_os/">Porting to your Platform</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../console/console/">Console</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../shell/shell/">Shell</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../bootloader/bootloader/">Bootloader</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../fs/fs/fs/

">File System</a>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../hal/hal/">Hardware Abstraction Layer</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../testutil/testutil/">Test Utilities</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../imgmgr/imgmgr/">Image Manager</a></li>
  
    
  </li>

              
          
              
                
  
    <li>
      <a href="../../baselibc/">Baselibc library</a>
    </li>
  

              
          
              
                
  
  
    <li ><a href="../../elua/elua/">Embedded Lua</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../json/json/">JSON</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li class="active"><a href="./">Stats</a></li>
  
    
      <ul class="current-toc">
          
              
          
      </ul>
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../logs/logs/">Logs</a></li>
  
    
  </li>

              
          
      </ul>
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../../../network/ble/ble_intro/

">Networking User Guide</a>
  
    
  </li>

              
          
      </ul>
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../newt/newt_intro/
">Newt Tool Manual</a>
  
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../newtmgr/overview/
">Newt Manager Manual</a>
  
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../faq/answers/
">Appendix</a>
  
    
  </li>

        
      
    </ul>
</div></div>

                    <div class="show-sidebar-container">
                        <button class="show-sidebar">Docs Menu</button>
                    </div>

                    <div class="col-md-offset-3 col-md-9 documentation-viewer" role="main">
                        <div class="row doc-header">
                            <div class="col-sm-6">
                                
<ul class="nav nav-pills">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="active" role="presentation"><a href="../../../get_started/introduction/">Mynewt OS</a></li>
    
    
    
    <li  role="presentation"><a href="../../../../newt/newt_intro/">Newt Tool</a></li>
    
    
    
    <li  role="presentation"><a href="../../../../newtmgr/overview/">Newt Mgr</a></li>
    
    
    
    
</ul>
                            </div>
                            <div class="col-sm-6">
                                <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="/documentation/">Docs</a></li>
    
    
        
          <li>&raquo; <a href="../../../os_user_guide/">OS User Guide</a></li>
        
      
        
          <li>&raquo; Stats</li>
        
      
      
    
    
  </ul>
</div>
                            </div>
                        </div>
                        
                            <h1 id="statistics-module">Statistics Module<a class="headerlink" href="#statistics-module" title="Permanent link">&para;</a></h1>
<p>The statistics module allows application, libraries, or drivers to
record statistics that can be shown via the Newtmgr tool and console.</p>
<p>This allows easy integration of statistics for troubleshooting,
maintenance, and usage monitoring.</p>
<p>By creating and registering your statistics, they are automatically
included in the Newtmgr shell and console APIs.</p>
<h3 id="implementation-details">Implementation Details<a class="headerlink" href="#implementation-details" title="Permanent link">&para;</a></h3>
<p>A statistic is an unsigned integer that can be set by the 
code. When building stats, the implementer chooses the size of the 
statistic depending on the frequency of the statistic and the 
resolution required before the counter wraps.    </p>
<p>Typically the stats are incremented upon code events; however, they are 
not limted to that purpose.  </p>
<p>Stats are organized into sections. Each section of stats has its own
name and can be queried separately through the API.  Each section of stats
also has its own statistic size, allowing the user to separate large (64-bit)
statistics from small (16 bit statistics).  NOTE:  It is not currently possible
to group different size stats into the same section.  Please ensure all stats
in a section have the same size.</p>
<p>Stats sections are currently stored in a single global stats group.  </p>
<p>Statistics are stored in a simple structure which contains a small
stats header followed by a list of stats.  The stats header contains:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">struct</span> <span style="color: #000000">stats_hdr</span> {
     <span style="color: #A90D91">char</span> <span style="color: #000000">*s_name</span>;
     <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">s_size</span>;
     <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">s_cnt</span>;
     <span style="color: #A90D91">uint16_t</span> <span style="color: #000000">s_pad1</span>;
 <span style="color: #633820">#ifdef STATS_NAME_ENABLE</span>
     <span style="color: #A90D91">struct</span> <span style="color: #000000">stats_name_map</span> <span style="color: #000000">*s_map</span>;
     <span style="color: #A90D91">int</span> <span style="color: #000000">s_map_cnt</span>;
 <span style="color: #633820">#endif</span>
     <span style="color: #000000">STAILQ_ENTRY</span>(<span style="color: #000000">stats_hdr</span>) <span style="color: #000000">s_next</span>;
 };
 <span style="color: #000000">```</span>

 <span style="color: #000000">&lt;br&gt;</span>

<span style="color: #633820">#### Compile Time Options</span>

<span style="color: #000000">When</span> <span style="color: #000000">building</span> <span style="color: #000000">your</span> <span style="color: #000000">app</span>, <span style="color: #000000">there</span> <span style="color: #000000">is</span> <span style="color: #000000">a</span> <span style="color: #000000">single</span> <span style="color: #000000">compile</span> <span style="color: #000000">time</span> <span style="color: #000000">option</span> <span style="color: #A90D91">for</span>
<span style="color: #000000">statistics</span>.  <span style="color: #000000">When</span> <span style="color: #000000">querying</span> <span style="color: #000000">statistics</span>, <span style="color: #000000">they</span> <span style="color: #000000">are</span> <span style="color: #000000">always</span> <span style="color: #000000">queried</span> <span style="color: #000000">by</span> <span style="color: #000000">number</span>,
<span style="color: #000000">but</span> <span style="color: #A90D91">if</span> <span style="color: #000000">you</span> <span style="color: #000000">want</span> <span style="color: #000000">to</span> <span style="color: #000000">see</span> <span style="color: #000000">the</span> <span style="color: #000000">results</span> <span style="color: #000000">by</span> <span style="color: #000000">name</span>, <span style="color: #000000">you</span> <span style="color: #000000">need</span> <span style="color: #000000">to</span> <span style="color: #000000">define</span> 
<span style="color: #000000">`STATS_NAME_ENABLE`</span>.  <span style="color: #000000">This</span> <span style="color: #000000">is</span> <span style="color: #000000">defined</span> <span style="color: #000000">using</span> 
</pre></div>


<p>pkg.clfags: -DSTATS_NAME_ENABLE</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">in your apps pkg.yml file or 
</pre></div>


<p>target.clfags: -DSTATS_NAME_ENABLE</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">in your target definition.

Enabling stat names provides better descriptions in the reported stats,
but takes code space to store the strings within the image.

&lt;br&gt;

### Adding Stats to your code.

Creating new stats table requires the following steps.

* Include the stats header file 
* Define a stats section
* Declare an instance of the section 
* Define the stat sections names table
* Implement stat in your code
* Initialize the stats
* Register the stats

&lt;br&gt;

#### Include the stats header file

Add the stats library to your pkg.yml file for your package or app by adding
this line to your package dependencies.
</pre></div>


<p>pkg.deps:
    - "@apache-mynewt-core/sys/stats"</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

Add this include directive to code files using the stats library.
</pre></div>


<h1 id="include">include <stats/stats.h><a class="headerlink" href="#include" title="Permanent link">&para;</a></h1>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

#### Define a stats section

You must use the `stats.h` macros to define your stats table.  A 
stats section definition looks like this.  
</pre></div>


<p>STATS_SECT_START(my_stat_section)
    STATS_SECT_ENTRY(attempt_stat)
    STATS_SECT_ENTRY(error_stat)
STATS_SECT_END</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

In this case we chose to make the stats 32-bits each.  `stats.h` supports three
different stats sizes through the following macros:

* `STATS_SIZE_16` -- stats are 16 bits (wraps at 65536)
* `STATS_SIZE_32` -- stats are 32 bits (wraps at 4294967296)
* `STATS_SIZE_64` -- stats are 64-bits

When this compiles/pre-processes, it produces a structure definition like this
</pre></div>


<p>struct stats_my_stat_section { 
    struct stats_hdr s_hdr;
    uint32_t sattempt_stat;
    uint32_t serror_stat;
};</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

You can see that the defined structure has a small stats structure
header and the two stats we have defined.

Depending on whether these stats are used in multiple modules, you may need
to include this definition in a header file.

&lt;br&gt;

#### Declaring a variable to hold the stats

Declare the global variable to hold your statistics. Since it is possible to
have multiple copies of the same section (for example a stat section for
each of 5 identical peripherals), the variable name of the stats section 
must be unique.
</pre></div>


<p>STATS_SECT_DECL(my_stat_section) g_mystat;</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

Again, if your stats section is used in multiple C files you will need to 
include the above definition in one of the C files and &#39;extern&#39; this declaration 
in your header file.
</pre></div>


<p>extern STATS_SECT_DECL(my_stat_section) g_mystat;</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

#### Define the stats section name table

Whether or not you are using `STATS_NAME_ENABLE`, you must define 
a stats name table.  If `STATS_NAME_ENABLE` is not enabled, this will 
not take any code space or image size.  
</pre></div>


<p>/<em> define a few stats for querying </em>/
STATS_NAME_START(my_stat_section)
    STATS_NAME(my_stat_section, attempt_stat)
    STATS_NAME(my_stat_section, error_stat)
STATS_NAME_END(my_stat_section)</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

When compiled by the preprocessor, it creates a structure that looks like this.
</pre></div>


<p>struct stats_name_map g_stats_map_my_stat_section[] = {
    { <strong>builtin_offsetof (struct stats_my_stat_section, sattempt_stat), "attempt_stat" },
    { </strong>builtin_offsetof (struct stats_my_stat_section, serror_stat), "error_stat" },
};</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

This table will allow the UI components to find a nice string name for the 
stat.

&lt;br&gt;

#### Implement stats in your code.

You can use the `STATS_INC` or `STATS_INCN` macros to increment your statistics
within your C-code.  For example, your code may do this:
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">STATS_INC(g_mystat, attempt_stat);
rc = do_task();
if(rc == ERR) { 
    STATS_INC(g_mystat, error_stat);        
}
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

#### Initialize the statistics

You must initialize the stats so they can be operated on by the stats
library.  As per our example above, it would look like the following.

This tells the system how large each statistic is and the number of 
statistics in the section.  It also initialize the name information for
the statistics if enabled as shown above.
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">rc = stats_init(
    STATS_HDR(g_mystat), 
    STATS_SIZE_INIT_PARMS(g_mystat, STATS_SIZE_32), 
    STATS_NAME_INIT_PARMS(my_stat_section));
assert(rc == 0);
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

#### Register the statistic section

If you want the system to know about your stats,  you must register them.
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">rc = stats_register(&quot;my_stats&quot;, STATS_HDR(g_mystat));
assert(rc == 0);
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

There is also a method that does initialization and registration at the 
same time,  called `stats_init_and_reg`.

&lt;br&gt;

### Retrieving stats through console or Newtmgr

If you enable console in your project you can see stats through the 
serial port defined.

This is the stats as shown from the example above with names enabled.
</pre></div>


<p>stat my_stats
12274:attempt_stat: 3
12275:error_stat: 0</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">&lt;br&gt;

This is the stats as shown from the example without names enabled.
</pre></div>


<p>stat my_stats
29149:s0: 3
29150:s1: 0
```</p>
<p><br></p>
<h3 id="a-note-on-multiple-stats-sections">A note on multiple stats sections<a class="headerlink" href="#a-note-on-multiple-stats-sections" title="Permanent link">&para;</a></h3>
<p>If you are implementing a device with multiple instances, you may
want multiple stats sections with the exact same format.</p>
<p>For example, suppose I write a driver for an external distance sensor.  My
driver supports up to 5 sensors and I want to record the stats of 
each device separately.</p>
<p>This works identically to the example above, except you would need to 
register each one separately with a unique name.  The stats system will
not let two sections be entered with the same name.</p>
                        
                        <div class="row">
                            
<ul class="nav nav-pills" style="margin-bottom: 10px">
    <li>
    
    <a href=../../json/json_target_address/><span class="fa fa-arrow-left"></span>  Previous: json_target_address</a>
    
    </li>
    <li class="pull-right">
    
    <a href=../../logs/logs/></span>Next: toc  <span class="fa fa-arrow-right">
    
    </li>
</ul>
                        </div>
                        <div class="row">
                            <footer>
    <div class="row">
        <div class="col-md-12">
            
                <p class="copyright">Copyright &copy; 2015 The Apache Software Foundation, Licensed under the Apache License, Version 2.0 Apache and the Apache feather logo are trademarks of The Apache Software Foundation.<br>The Apache Software Foundation Apache Incubator</p>
            
        </div>
    </div>
    <div class="copyright-logos">
        <div class="row">
            <div class="col-xs-6 text-right">
                <img src="/img/apache-feather.png" alt="Apache" title="Apache">
            </div>
            <div class="col-xs-6 text-left">
                <img src="/img/apache-logo.png" alt="Apache Incubator" title="Apache Incubator">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
        </div>
    </div>
</footer>
                        </div>
                    </div>
                </div>
            
            
        </div>

        <script src="../../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../../js/highlight.pack.js"></script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../js/custom.js"></script>

    </body>
</html>