<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://mynewt.apache.org/os/tutorials/air_quality_sensor/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">

	<title>Adding an air-quality sensor - Apache Mynewt</title>

        <link href="../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <link href="../../../css/base.css" rel="stylesheet">
        <link href="../../../css/custom.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900,300,100' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'mynewt.incubator.apache.org');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Adding an air-quality sensor">


        <div id="navbar" class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="logo-container">
        <img src="/img/logo.svg">
    </div>
    <div class="container-fluid">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li class="dropdown">
                    <a href="/documentation/" class="dropdown-toggle" data-toggle="dropdown">Docs <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        
                        
                        
                        
                        <li >
                            <a href="../../../documentation/">
                                Overview
                            </a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="active">
                            <a href="../../get_started/introduction/">
                                Mynewt OS Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../newt/newt_intro/">
                                Newt Tool Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../newtmgr/overview/">
                                Newt Manager Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../faq/answers/">
                                Appendix
                            </a>
                        </li>
                        
                        
                    </ul>
                </li>
                <li>
                    <a href="/download/">Download</a>
                </li>
                <li>
                    <a href="/community/">Community</a>
                </li>
                <li>
                    <a href="/events/">Events</a>
                </li>
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
    </div>
</div>

        

        <div class="container-fluid">
            
                <div class="row sm-extra-padding">
                    <div id="docSidebar" class="col-md-3 bg-grey sidebar-container"><div class="bs-sidebar hidden-print" role="complementary">
    <div class="sidebar-top">
        <img class="hidden-xs hidden-sm logo-small" src="/img/logo.svg" alt="MyNewt" title="MyNewt">
        <div class="small" role="search">
            <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" placeholder="Search documentation" />
                    <button class="search-button" type="submit"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>
    <ul class="nav bs-sidenav">
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  
    <li><a href="
  ../../get_started/introduction/
">Mynewt OS Manual</a>
  
    
      <ul class="current-toc">
          
              
                
  
    <li>
      <a href="../../get_started/introduction/">Introduction</a>
    </li>
  

              
          
              
                
  
  
    <li><a href="
  ../../get_started/native_tools/
">Get Started</a>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../get_started/vocabulary/">Concepts</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../olimex/
">Tutorials</a>
  
    
      <ul class="current-toc">
          
              
                
  
    <li>
      <a href="../olimex/">Blinky on Olimex</a>
    </li>
  

              
          
              
                
  
    <li>
      <a href="../STM32F303/">Blinky on STM32F303</a>
    </li>
  

              
          
              
                
  
    <li>
      <a href="../nRF52/">Blinky on nRF52</a>
    </li>
  

              
          
              
                
  
    <li>
      <a href="../arduino_zero/">Blinky on Arduino Zero</a>
    </li>
  

              
          
              
                
  
    <li>
      <a href="../unit_test/">Unit Testing a Package</a>
    </li>
  

              
          
              
                
  
    <li class="active">
      Adding an air-quality sensor
    </li>
  

              
          
              
                
  
    <li>
      <a href="../how_to_edit_docs/">Edit Docs</a>
    </li>
  

              
          
      </ul>
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../core_os/mynewt_os/

">OS User Guide</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../../network/ble/ble_intro/

">Networking User Guide</a>
  
    
  </li>

              
          
      </ul>
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../newt/newt_intro/
">Newt Tool Manual</a>
  
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../newtmgr/overview/
">Newt Manager Manual</a>
  
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../faq/answers/
">Appendix</a>
  
    
  </li>

        
      
    </ul>
</div></div>

                    <div class="show-sidebar-container">
                        <button class="show-sidebar">Docs Menu</button>
                    </div>

                    <div class="col-md-offset-3 col-md-9 documentation-viewer" role="main">
                        <div class="row doc-header">
                            <div class="col-sm-6">
                                
<ul class="nav nav-pills">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="active" role="presentation"><a href="../../get_started/introduction/">Mynewt OS</a></li>
    
    
    
    <li  role="presentation"><a href="../../../newt/newt_intro/">Newt Tool</a></li>
    
    
    
    <li  role="presentation"><a href="../../../newtmgr/overview/">Newt Mgr</a></li>
    
    
    
    
</ul>
                            </div>
                            <div class="col-sm-6">
                                <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="/documentation/">Docs</a></li>
    
    
        
          <li>&raquo; <a href="../../get_started/introduction/">Mynewt OS Manual</a></li>
        
      
        
          <li>&raquo; <a href="../olimex/">Tutorials</a></li>
        
      
      
        <li>&raquo; Adding an air-quality sensor</li>
      
    
    
  </ul>
</div>
                            </div>
                        </div>
                        
                            <h2 id="air-quality-sensor-project">Air quality sensor project<a class="headerlink" href="#air-quality-sensor-project" title="Permanent link">&para;</a></h2>
<h3 id="setting-up-source-tree-for-stuff-you-need">Setting up source tree for stuff you need<a class="headerlink" href="#setting-up-source-tree-for-stuff-you-need" title="Permanent link">&para;</a></h3>
<p>To start with, you need to create a new app under which you will do this development. So you type in:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    $ mkdir $<span style="color: #000000">HOME</span>/src
    $ cd $<span style="color: #000000">HOME</span>/src
    $ newt new air_quality
</pre></div>


<p>Let's say you are using STM32F3discovery board for this project. You know you need the board support package for that hardware. You can look up its location in the repository, fetch the package list from there, and install the egg for the BSP.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ newt app add-pkg-list mynewt_stm32f3 https://github.com/runtimeinc/mynewt_stm32f3.git
    Downloading pkg-list.yml from https://github.com/runtimeinc/mynewt_stm32f3.git/master... ok!
    Verifying pkg-list.yml format...
 ok!
    Package list mynewt_stm32f3 successfully installed to application.
    [user@IsMyLaptop:~/src/air_quality]$ newt pkg install hw/bsp/stm32f3discovery
    Downloading mynewt_stm32f3 from https://github.com/runtimeinc/mynewt_stm32f3.git/master... ok!
    Installing hw/bsp/stm32f3discovery
    Installing hw/mcu/stm/stm32f3xx
    Error: No package libs/cmsis-core found
</pre></div>


<p>Ooops. You forgot to bring in the package list for larva itself. That's the one with most of the packages. Including libs/cmsis-core.</p>
<p>This time you need the latest and greatest from larva, so you want to bring in the 'develop' branch. Note that normally the use of the more stable master branch is recommended. In that case you would drop the '-b develop' from command line.</p>
<p>However, you want to bring in the packages from develop branch. To make that happen you say:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ newt app add-pkg-list -b develop larva https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva.git
    Downloading pkg-list.yml from https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva.git/develop... ok!
    Verifying pkg-list.yml format...
 ok!
    Package list larva successfully installed to application.
    [user@IsMyLaptop:~/src/air_quality]$ newt pkg install libs/cmsis-core          Downloading     larva from https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva/develop... ok!
    Installing libs/cmsis-core
    Installation was a success!
</pre></div>


<p>That's better. You want to make sure you have all the needed bits for supporting your board; so you decide to build the blinky project for it first.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ newt pkg install project/blinky
    Downloading larva from https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva/develop... ok!
    Installing project/blinky
    Installing libs/console/full
    Installing libs/newtmgr
    Installing libs/json
    Installing libs/shell
    Installing sys/config
    Installing sys/log
    Installing sys/stats
    Installation was a success!
    [user@IsMyLaptop:~/src/air_quality]$ newt pkg install compiler/arm-none-eabi-m4
    Downloading larva from https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva/develop... ok!
    Installing compiler/arm-none-eabi-m4
    Installation was a success!
</pre></div>


<p>As you can see, this brought in quite a few other dependencies as well.</p>
<p>Now create a target for it and build it.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ newt target create blink_f3
    Creating target blink_f3
        Target blink_f3 successfully created!
    [user@IsMyLaptop:~/src/air_quality]$ newt target set blink_f3 arch=cortex_m4
    Target blink_f3 successfully set arch to cortex_m4
    [user@IsMyLaptop:~/src/air_quality]$ newt target set blink_f3 bsp=hw/bsp/stm32f3discovery
    Target blink_f3 successfully set bsp to hw/bsp/stm32f3discovery
    [user@IsMyLaptop:~/src/air_quality]$ newt target set blink_f3 compiler=arm-none-eabi-m4
    Target blink_f3 successfully set compiler to arm-none-eabi-m4
    [user@IsMyLaptop:~/src/air_quality]$ newt target set blink_f3 compiler_def=debug
    Target blink_f3 successfully set compiler_def to debug
    [user@IsMyLaptop:~/src/air_quality]$ newt target set blink_f3 project=blinky
    Target blink_f3 successfully set project to blinky
    [user@IsMyLaptop:~/src/air_quality]$ newt target build blink_f3
    Building target blink_f3 (project = blinky)
     ...
    [user@IsMyLaptop:~/src/air_quality]$ newt target build blink_f3
    Building target blink_f3 (project = blinky)
    Building project blinky
    Linking blinky.elf
    /usr/local/Cellar/gcc-arm-none-eabi-49/20150609/bin/../lib/gcc/arm-none-eabi 
    4.9.3/../../../../arm-none-eabi/bin/ld: /Users/user/src/air_quality/project/blinky//bin/    blink_f3/blinky.elf section `.text&#39; will not fit in region `FLASH&#39;
    /usr/local/Cellar/gcc-arm-none-eabi-49/20150609/bin/../lib/gcc/arm-none-eabi 4.9.3/../../../../arm-none-eabi/bin/ld: region `FLASH&#39; overflowed by 5180 bytes
    collect2: error: ld returned 1 exit status
</pre></div>


<p>The error indicates that the images need to be smaller for this board, so you decide to switch over to using baselibc instead of libc.</p>
<p>To do that, you modify the project's egg file project/blinky/pkg.yml. And add <em>libs/baselibc</em> to list of package dependencies (pkg.deps).</p>
<p>Now:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ newt target build blink_f3
    Building target blink_f3 (project = blinky)
    ....
    Archiving libstm32f3discovery.a
    Compiling main.c
    Building project blinky
    Linking blinky.elf
    Successfully run!
</pre></div>


<p>That's better.</p>
<p>You know that this platform uses bootloader, which means you have to create a target for that too. And download the bootloader package.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ newt target create boot_f3
    Creating target boot_f3
    Target boot_f3 successfully created!
    [user@IsMyLaptop:~/src/air_quality]$ newt target set boot_f3 arch=cortex_m4
    newTarget boot_f3 successfully set arch to cortex_m4
    [user@IsMyLaptop:~/src/air_quality]$ newt target set boot_f3 bsp=hw/bsp/stm32f3discovery
    newtTarget boot_f3 successfully set bsp to hw/bsp/stm32f3discovery
    [user@IsMyLaptop:~/src/air_quality]$ newt target set boot_f3 compiler=arm-none-eabi-m4
    Target boot_f3 successfully set compiler to arm-none-eabi-m4
    [user@IsMyLaptop:~/src/air_quality]$ newt target set boot_f3 compiler_def=optimized
    Target boot_f3 successfully set compiler_def to optimized
    [user@IsMyLaptop:~/src/air_quality]$ newt target set boot_f3 project=boot
    Target boot_f3 successfully set project to boot
    [user@IsMyLaptop:~/src/air_quality]$ newt pkg install project/boot
    Downloading larva from https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva/develop... ok!
    Installing project/boot
    Installing fs/nffs
    Installing fs/fs
    Installing libs/bootutil
    Installing libs/mbedtls
    Installing libs/console/stub
    Installation was a success!
</pre></div>


<p>And then build it:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    newt target build boot_f3
    ....
    Linking boot.elf
    Successfully run!
</pre></div>


<p>Next you must download the targets to board, and see that the LED actually blinks. You plug in the STM32F3 discovery board to your laptop, and say:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ newt target download blink_f3
    Downloading with /Users/user/src/air_quality/hw/bsp/stm32f3discovery/stm32f3discovery_download.sh
    Downloading /Users/user/src/air_quality/project/blinky/bin/blink_f3/blinky.img to 0x08008000
    Open On-Chip Debugger 0.9.0 (2015-05-28-12:05)
    ...
    target state: halted
    target halted due to debug-request, current mode: Thread 
    xPSR: 0x01000000 pc: 0x0800026c msp: 0x10002000
    auto erase enabled
    Error: couldn&#39;t open /Users/user/src/air_quality/project/blinky/bin/blink_f3/blinky.img
    Error: exit status 1
    exit status 1
</pre></div>


<p>Ah. Forgot to create an image out of the blinky binary.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ newt target create-image blink_f3 0.0.1
    Building target blink_f3 (project = blinky)
    Compiling hal_flash.c
    Archiving libhal.a
    Compiling cons_tty.c
    Archiving libfull.a
    Compiling hal_uart.c
    Archiving libstm32f3xx.a
    Compiling hal_bsp.c
    Archiving libstm32f3discovery.a
    Compiling main.c
    Building project blinky
    Linking blinky.elf
    [user@IsMyLaptop:~/src/air_quality]$ newt target download blink_f3
    Downloading with /Users/user/src/air_quality/hw/bsp/stm32f3discovery/stm32f3discovery_download.sh
</pre></div>


<p>And it's blinking.</p>
<h3 id="create-test-project">Create test project<a class="headerlink" href="#create-test-project" title="Permanent link">&para;</a></h3>
<p>Now that you have your system setup, you can start creating your own stuff.
First you want to create a project for yourself - you can start by getting project template from blinky, as it pretty much has what you want.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ mkdir project/air_quality
    [user@IsMyLaptop:~/src/air_quality]$ cp project/blinky/pkg.yml project/air_quality/
    [user@IsMyLaptop:~/src/air_quality]$ mkdir project/air_quality/src
    [user@IsMyLaptop:~/src/air_quality]$ cp project/blinky/src/main.c project/air_quality/src/
</pre></div>


<p>Then you modify the project/air_quality/pkg.yml for air_quality in order to change the <em>pkg.name</em> to be <em>project/air_quality</em>.</p>
<p>And create a target for it:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ newt target create air_q
    newt targCreating target air_q
    Target air_q successfully created!
    [user@IsMyLaptop:~/src/air_quality]$ newt target set air_q arch=cortex_m4
    Target air_q successfully set arch to cortex_m4
    [user@IsMyLaptop:~/src/air_quality]$ newt target set air_q bsp=hw/bsp/stm32f3discovery
    Target air_q successfully set bsp to hw/bsp/stm32f3discovery
    [user@IsMyLaptop:~/src/air_quality]$ newt target set air_q compiler=arm-none-eabi-m4
    Target air_q successfully set compiler to arm-none-eabi-m4
    [user@IsMyLaptop:~/src/air_quality]$ newt target set air_q compiler_def=debug
    Target air_q successfully set compiler_def to debug
    [user@IsMyLaptop:~/src/air_quality]$ newt target set air_q project=air_quality
    Target air_q successfully set project to air_quality
    [user@IsMyLaptop:~/src/air_quality]$ newt target build air_q
       ....
    Successfully run!
</pre></div>


<h3 id="create-packages-for-drivers">Create packages for drivers<a class="headerlink" href="#create-packages-for-drivers" title="Permanent link">&para;</a></h3>
<p>One of the sensors you want to enable is SenseAir K30, which will connect to the board over serial port.
To start development of the driver, you first need to create a package description for it, and add stubs for sources.</p>
<p>So you add few files. pkg.yml to describe the driver, and then header stub followed by source stub.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">[user@IsMyLaptop:~/src/air_quality]$ cat libs/my_drivers/senseair/pkg.yml
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">#</span>
<span style="color: #633820"># Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="color: #633820"># or more contributor license agreements.  See the NOTICE file</span>
<span style="color: #633820"># distributed with this work for additional information</span>
<span style="color: #633820"># regarding copyright ownership.  The ASF licenses this file</span>
<span style="color: #633820"># to you under the Apache License, Version 2.0 (the</span>
<span style="color: #633820"># &quot;License&quot;); you may not use this file except in compliance</span>
<span style="color: #633820"># with the License.  You may obtain a copy of the License at</span>
<span style="color: #633820"># </span>
<span style="color: #633820">#  http:</span><span style="color: #177500">//www.apache.org/licenses/LICENSE-2.0</span>
<span style="color: #633820">#</span>
<span style="color: #633820"># Unless required by applicable law or agreed to in writing,</span>
<span style="color: #633820"># software distributed under the License is distributed on an</span>
<span style="color: #633820"># &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span style="color: #633820"># KIND, either express or implied.  See the License for the</span>
<span style="color: #633820"># specific language governing permissions and limitations</span>
<span style="color: #633820"># under the License.</span>
<span style="color: #633820">#</span>
<span style="color: #000000">pkg</span>.<span style="color: #000000">name</span>: <span style="color: #000000">libs/my_drivers/senseair</span>
<span style="color: #000000">pkg</span>.<span style="color: #000000">deps</span>:
    <span style="color: #000000">-</span> <span style="color: #000000">hw/hal</span>
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">[user@IsMyLaptop:~/src/air_quality]$ cat libs/my_drivers/senseair/include/senseair/senseair.h
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #177500">/*</span>
<span style="color: #177500"> * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="color: #177500"> * or more contributor license agreements.  See the NOTICE file</span>
<span style="color: #177500"> * distributed with this work for additional information</span>
<span style="color: #177500"> * regarding copyright ownership.  The ASF licenses this file</span>
<span style="color: #177500"> * to you under the Apache License, Version 2.0 (the</span>
<span style="color: #177500"> * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="color: #177500"> * with the License.  You may obtain a copy of the License at</span>
<span style="color: #177500"> * </span>
<span style="color: #177500"> *  http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="color: #177500"> *</span>
<span style="color: #177500"> * Unless required by applicable law or agreed to in writing,</span>
<span style="color: #177500"> * software distributed under the License is distributed on an</span>
<span style="color: #177500"> * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span style="color: #177500"> * KIND, either express or implied.  See the License for the</span>
<span style="color: #177500"> * specific language governing permissions and limitations</span>
<span style="color: #177500"> * under the License.</span>
<span style="color: #177500">*/</span>
<span style="color: #633820">#ifndef _SENSEAIR_H_</span>
<span style="color: #633820">#define _SENSEAIR_H_</span>

<span style="color: #A90D91">void</span> <span style="color: #000000">senseair_init</span>(<span style="color: #A90D91">void</span>);

<span style="color: #633820">#endif </span><span style="color: #177500">/* _SENSEAIR_H_ */</span><span style="color: #633820"></span>
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">[user@IsMyLaptop:~/src/air_quality]$ cat libs/my_drivers/senseair/src/senseair.c
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #177500">/**</span>
<span style="color: #177500"> * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="color: #177500"> * or more contributor license agreements.  See the NOTICE file</span>
<span style="color: #177500"> * distributed with this work for additional information</span>
<span style="color: #177500"> * regarding copyright ownership.  The ASF licenses this file</span>
<span style="color: #177500"> * to you under the Apache License, Version 2.0 (the</span>
<span style="color: #177500"> * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="color: #177500"> * with the License.  You may obtain a copy of the License at</span>
<span style="color: #177500"> * </span>
<span style="color: #177500"> *  http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="color: #177500"> *</span>
<span style="color: #177500"> * Unless required by applicable law or agreed to in writing,</span>
<span style="color: #177500"> * software distributed under the License is distributed on an</span>
<span style="color: #177500"> * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span style="color: #177500"> * KIND, either express or implied.  See the License for the</span>
<span style="color: #177500"> * specific language governing permissions and limitations</span>
<span style="color: #177500"> * under the License.</span>
<span style="color: #177500"> */</span>

<span style="color: #A90D91">void</span>
<span style="color: #000000">senseair_init</span>(<span style="color: #A90D91">void</span>)
{
}
</pre></div>


<p>And add dependency to this package in my project yml file.</p>
<p>Here's from project/air_quality/pkg.yml</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">pkg.name: project/air_quality
pkg.vers: 0.8.0
pkg.description: Basic example application which blinks an LED.
pkg.author: Marko Kiiskila &lt;user@runtime.io&gt;
pkg.homepage: http://mynewt.apache.org/os/get_acclimated/project2/
pkg.repository: https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva
pkg.keywords:

pkg.deps:
    - libs/console/full
    - libs/newtmgr
    - libs/os
    - libs/shell
    - libs/baselibc
    - sys/config
    - sys/log
    - sys/stats
    - libs/my_drivers/senseair
</pre></div>


<p>And add a call to your main() to initialize this driver.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ diff project/blinky/src/main.c project/air_quality/src/main.c
    28a29
    &gt; #include &lt;senseair/senseair.h&gt;
    190a192
    &gt; senseair_init();
    [user@IsMyLaptop:~/src/air_quality
</pre></div>


<p>And then build it to make sure all goes well.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ newt target build air_q
    Building target air_q (project = air_quality)
    Building project air_quality
    Successfully run!
</pre></div>


<p>All looks good.</p>
<h3 id="add-cli-commands-for-testing-drivers">Add CLI commands for testing drivers<a class="headerlink" href="#add-cli-commands-for-testing-drivers" title="Permanent link">&para;</a></h3>
<p>While developing the driver, you want to issue operations from console asking it to do stuff. The way to do this is to register your command handler with shell. Whenever your custom command is issued, you can respond to it.</p>
<p>The way you do this is first adding a dependency to shell package for your senseair driver. So you change libs/my_drivers/senseair/pkg.yml to have the following:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">pkg.name: libs/my_drivers/senseair
pkg.deps:
    - hw/hal
    - libs/shell
</pre></div>


<p>And then register your shell command in <em>senseair_init()</em>.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">[user@IsMyLaptop:~/src/air_quality]$ cat libs/my_drivers/senseair/src/senseair.c
 ....
</pre></div>


<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">#include &lt;shell/shell.h&gt;</span>
<span style="color: #633820">#include &lt;console/console.h&gt;</span>

<span style="color: #A90D91">static</span> <span style="color: #A90D91">int</span> <span style="color: #000000">senseair_shell_func</span>(<span style="color: #A90D91">int</span> <span style="color: #000000">argc</span>, <span style="color: #A90D91">char</span> <span style="color: #000000">**argv</span>);
<span style="color: #A90D91">static</span> <span style="color: #A90D91">struct</span> <span style="color: #000000">shell_cmd</span> <span style="color: #000000">senseair_cmd</span> <span style="color: #000000">=</span> {
    .<span style="color: #000000">sc_cmd</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;senseair&quot;</span>,
    .<span style="color: #000000">sc_cmd_func</span> <span style="color: #000000">=</span> <span style="color: #000000">senseair_shell_func</span>,
};

<span style="color: #A90D91">void</span>
<span style="color: #000000">senseair_init</span>(<span style="color: #A90D91">void</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">shell_cmd_register</span>(<span style="color: #000000">&amp;senseair_cmd</span>);
    <span style="color: #000000">assert</span>(<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>);
}

<span style="color: #A90D91">static</span> <span style="color: #A90D91">int</span>
<span style="color: #000000">senseair_shell_func</span>(<span style="color: #A90D91">int</span> <span style="color: #000000">argc</span>, <span style="color: #A90D91">char</span> <span style="color: #000000">**argv</span>)
{
    <span style="color: #000000">console_printf</span>(<span style="color: #C41A16">&quot;Yay! Somebody called!\n&quot;</span>);
    <span style="color: #A90D91">return</span> <span style="color: #1C01CE">0</span>;
}
</pre></div>


<p>Then you build this, download to target, and start minicom on your console port.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~]$ minicom -D /dev/tty.usbserial-AH02MIE2


    Welcome to minicom 2.7

    OPTIONS: 
    Compiled on Oct 12 2015, 07:48:30.
    Port /dev/tty.usbserial-AH02MIE2, 13:44:40

    Press CTRL-X Z for help on special keys

    ?
    141964:Unknown command ?
    ?
    143804:config   log     echo    ?       tasks   mempools 
    143806:stat     senseair 
    senseair
    150644:Yay! Somebody called!
</pre></div>


<p>Now that's great. You can connect the hardware to board and start developing code for the driver itself.</p>
<h3 id="use-of-hal-for-drivers">Use of HAL for drivers<a class="headerlink" href="#use-of-hal-for-drivers" title="Permanent link">&para;</a></h3>
<p>The sensor has a serial port connection, and that's how you are going to connect to it. Your original BSP, hw/bsp/stm32f3discovery, has only one UART set up (as specified in src/hal_bsp.c, include/hal/bsp.h). Therefore, you need to create your own bsp which has configuration for this added hardware.</p>
<p>So in the shell you make a copy of the original BSP, and then change the package file a little.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ cp -R hw/bsp/stm32f3discovery hw/bsp/stm32f3discovery_with_senseair
</pre></div>


<p>Then you modify the pkg.yml in the copied BSP to assign name for this package.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">    [user@IsMyLaptop:~/src/air_quality]$ grep pkg.name hw/bsp/stm32f3discovery_with_senseair/pkg.yml
    pkg.name: &quot;hw/bsp/stm32f3discovery_with_senseair&quot;
</pre></div>


<p>And you want to use this BSP with my target. So you change the BSP in the target definition.</p>
<p>Here's your new target.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%">[user@IsMyLaptop:~/src/air_quality]$ newt target show air_q                    air_q
    arch=cortex_m4
    bsp=hw/bsp/stm32f3discovery_with_senseair
    compiler=arm-none-eabi-m4
    compiler_def=debug
    name=air_q
    project=air_quality
    vers=0.0.1
</pre></div>


<p>You add the 2nd serial port to my new BSP.</p>
<p>Modify the include/hal/bsp.h to increase UART_CNT to 2, and add a definition of the 2nd logical UART. You will use this in your sensor driver.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">static</span> <span style="color: #A90D91">const</span> <span style="color: #A90D91">struct</span> <span style="color: #000000">stm32f3_uart_cfg</span> <span style="color: #000000">uart_cfg</span>[<span style="color: #000000">UART_CNT</span>] <span style="color: #000000">=</span> {
    [<span style="color: #1C01CE">0</span>] <span style="color: #000000">=</span> {
        .<span style="color: #000000">suc_uart</span> <span style="color: #000000">=</span> <span style="color: #000000">USART1</span>,
        .<span style="color: #000000">suc_rcc_cmd</span> <span style="color: #000000">=</span> <span style="color: #000000">RCC_APB2PeriphClockCmd</span>,
        .<span style="color: #000000">suc_rcc_dev</span> <span style="color: #000000">=</span> <span style="color: #000000">RCC_APB2Periph_USART1</span>,
        .<span style="color: #000000">suc_pin_tx</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">9</span>,
        .<span style="color: #000000">suc_pin_rx</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">10</span>,
        .<span style="color: #000000">suc_pin_rts</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">12</span>,
        .<span style="color: #000000">suc_pin_cts</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">11</span>,
        .<span style="color: #000000">suc_pin_af</span> <span style="color: #000000">=</span> <span style="color: #000000">GPIO_AF_7</span>,
        .<span style="color: #000000">suc_irqn</span> <span style="color: #000000">=</span> <span style="color: #000000">USART1_IRQn</span>
    },
    [<span style="color: #1C01CE">1</span>] <span style="color: #000000">=</span> {
        .<span style="color: #000000">suc_uart</span> <span style="color: #000000">=</span> <span style="color: #000000">USART2</span>,
        .<span style="color: #000000">suc_rcc_cmd</span> <span style="color: #000000">=</span> <span style="color: #000000">RCC_APB1PeriphClockCmd</span>,
        .<span style="color: #000000">suc_rcc_dev</span> <span style="color: #000000">=</span> <span style="color: #000000">RCC_APB1Periph_USART2</span>,
        .<span style="color: #000000">suc_pin_tx</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">19</span>, <span style="color: #177500">/* PB3 */</span>
        .<span style="color: #000000">suc_pin_rx</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">20</span>, <span style="color: #177500">/* PB4 */</span>
        .<span style="color: #000000">suc_pin_rts</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">1</span>,
        .<span style="color: #000000">suc_pin_cts</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">0</span>,
        .<span style="color: #000000">suc_pin_af</span> <span style="color: #000000">=</span> <span style="color: #000000">GPIO_AF_7</span>,
        .<span style="color: #000000">suc_irqn</span> <span style="color: #000000">=</span> <span style="color: #000000">USART2_IRQn</span>
    }
};
</pre></div>


<p>With this in place, you can refer to serial port where your SenseAir sensor is by a logical number. This makes the code more platform independent - you could connect this sensor to another board, like Olimex. You will also use the HAL UART abstraction to do the UART port setup and data transfer. That way you don't need to have any platform dependent pieces within your little driver.</p>
<p>You will now see what the driver code ends up looking like. Here's the header file, filled in from stub you created earlier.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #177500">/*</span>
<span style="color: #177500"> * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="color: #177500"> * or more contributor license agreements.  See the NOTICE file</span>
<span style="color: #177500"> * distributed with this work for additional information</span>
<span style="color: #177500"> * regarding copyright ownership.  The ASF licenses this file</span>
<span style="color: #177500"> * to you under the Apache License, Version 2.0 (the</span>
<span style="color: #177500"> * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="color: #177500"> * with the License.  You may obtain a copy of the License at</span>
<span style="color: #177500"> * </span>
<span style="color: #177500"> *  http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="color: #177500"> *</span>
<span style="color: #177500"> * Unless required by applicable law or agreed to in writing,</span>
<span style="color: #177500"> * software distributed under the License is distributed on an</span>
<span style="color: #177500"> * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span style="color: #177500"> * KIND, either express or implied.  See the License for the</span>
<span style="color: #177500"> * specific language governing permissions and limitations</span>
<span style="color: #177500"> * under the License.</span>
<span style="color: #177500">*/</span>
<span style="color: #633820">#ifndef _SENSEAIR_H_</span>
<span style="color: #633820">#define _SENSEAIR_H_</span>

<span style="color: #A90D91">enum</span> <span style="color: #000000">senseair_read_type</span> {
        <span style="color: #000000">SENSEAIR_CO2</span>,
        <span style="color: #000000">SENSEAIR_TEMPERATURE</span>,
        <span style="color: #000000">SENSEAIR_HUMIDITY</span>
};

<span style="color: #A90D91">int</span> <span style="color: #000000">senseair_init</span>(<span style="color: #A90D91">int</span> <span style="color: #000000">uartno</span>);

<span style="color: #A90D91">int</span> <span style="color: #000000">senseair_read</span>(<span style="color: #A90D91">enum</span> <span style="color: #000000">senseair_read_type</span>);

<span style="color: #633820">#endif </span><span style="color: #177500">/* _SENSEAIR_H_ */</span><span style="color: #633820"></span>
</pre></div>


<p>As you can see, logical UART number has been added to the init routine. A 'read' function has been added, which is a blocking read. If you were making a commercial product, you would probably have a callback for reporting the results.</p>
<p>And here is the source for the driver.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #177500">/**</span>
<span style="color: #177500"> * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="color: #177500"> * or more contributor license agreements.  See the NOTICE file</span>
<span style="color: #177500"> * distributed with this work for additional information</span>
<span style="color: #177500"> * regarding copyright ownership.  The ASF licenses this file</span>
<span style="color: #177500"> * to you under the Apache License, Version 2.0 (the</span>
<span style="color: #177500"> * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="color: #177500"> * with the License.  You may obtain a copy of the License at</span>
<span style="color: #177500"> *</span>
<span style="color: #177500"> *  http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="color: #177500"> *</span>
<span style="color: #177500"> * Unless required by applicable law or agreed to in writing,</span>
<span style="color: #177500"> * software distributed under the License is distributed on an</span>
<span style="color: #177500"> * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span style="color: #177500"> * KIND, either express or implied.  See the License for the</span>
<span style="color: #177500"> * specific language governing permissions and limitations</span>
<span style="color: #177500"> * under the License.</span>
<span style="color: #177500"> */</span>
<span style="color: #633820">#include &lt;string.h&gt;</span>

<span style="color: #633820">#include &lt;shell/shell.h&gt;</span>
<span style="color: #633820">#include &lt;console/console.h&gt;</span>
<span style="color: #633820">#include &lt;os/os.h&gt;</span>

<span style="color: #633820">#include &lt;hal/hal_uart.h&gt;</span>

<span style="color: #633820">#include &quot;senseair/senseair.h&quot;</span>

<span style="color: #A90D91">static</span> <span style="color: #A90D91">const</span> <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">cmd_read_co2</span>[] <span style="color: #000000">=</span> {
    <span style="color: #1C01CE">0xFE</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X44</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X00</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X08</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X02</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X9F</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X25</span>
};
<span style="color: #A90D91">static</span> <span style="color: #A90D91">const</span> <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">cmd_read_temp</span>[] <span style="color: #000000">=</span> {
    <span style="color: #1C01CE">0xFE</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X44</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X00</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X12</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X02</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X94</span>, <span style="color: #1C01CE">0</span><span style="color: #000000">X45</span>
};
<span style="color: #A90D91">static</span> <span style="color: #A90D91">const</span> <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">cmd_read_humidity</span>[] <span style="color: #000000">=</span> {
    <span style="color: #1C01CE">0xFE</span>, <span style="color: #1C01CE">0x44</span>, <span style="color: #1C01CE">0x00</span>, <span style="color: #1C01CE">0x14</span>, <span style="color: #1C01CE">0x02</span>, <span style="color: #1C01CE">0x97</span>, <span style="color: #1C01CE">0xE5</span>
};

<span style="color: #A90D91">static</span> <span style="color: #A90D91">int</span> <span style="color: #000000">senseair_shell_func</span>(<span style="color: #A90D91">int</span> <span style="color: #000000">argc</span>, <span style="color: #A90D91">char</span> <span style="color: #000000">**argv</span>);
<span style="color: #A90D91">static</span> <span style="color: #A90D91">struct</span> <span style="color: #000000">shell_cmd</span> <span style="color: #000000">senseair_cmd</span> <span style="color: #000000">=</span> {
    .<span style="color: #000000">sc_cmd</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;senseair&quot;</span>,
    .<span style="color: #000000">sc_cmd_func</span> <span style="color: #000000">=</span> <span style="color: #000000">senseair_shell_func</span>,
};

<span style="color: #A90D91">struct</span> <span style="color: #000000">senseair</span> { 
    <span style="color: #A90D91">int</span> <span style="color: #000000">uart</span>;
    <span style="color: #A90D91">struct</span> <span style="color: #000000">os_sem</span> <span style="color: #000000">sema</span>;
    <span style="color: #A90D91">const</span> <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">*tx_data</span>;
    <span style="color: #A90D91">int</span> <span style="color: #000000">tx_off</span>;
    <span style="color: #A90D91">int</span> <span style="color: #000000">tx_len</span>;
    <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">rx_data</span>[<span style="color: #1C01CE">32</span>]; 
    <span style="color: #A90D91">int</span> <span style="color: #000000">rx_off</span>;
    <span style="color: #A90D91">int</span> <span style="color: #000000">value</span>;
} <span style="color: #000000">senseair</span>;

<span style="color: #A90D91">static</span> <span style="color: #A90D91">int</span>
<span style="color: #000000">senseair_tx_char</span>(<span style="color: #A90D91">void</span> <span style="color: #000000">*arg</span>)
{
    <span style="color: #A90D91">struct</span> <span style="color: #000000">senseair</span> <span style="color: #000000">*s</span> <span style="color: #000000">=</span> <span style="color: #000000">&amp;senseair</span>;
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;

    <span style="color: #A90D91">if</span> (<span style="color: #000000">s-&gt;tx_off</span> <span style="color: #000000">&gt;=</span> <span style="color: #000000">s-&gt;tx_len</span>) {
    <span style="color: #177500">/*</span>
<span style="color: #177500">         * Command tx finished.</span>
<span style="color: #177500">         */</span>
        <span style="color: #000000">s-&gt;tx_data</span> <span style="color: #000000">=</span> <span style="color: #A90D91">NULL</span>;
        <span style="color: #A90D91">return</span> <span style="color: #000000">-</span><span style="color: #1C01CE">1</span>;
    }

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">s-&gt;tx_data</span>[<span style="color: #000000">s-&gt;tx_off</span>];
    <span style="color: #000000">s-&gt;tx_off++</span>;
    <span style="color: #A90D91">return</span> <span style="color: #000000">rc</span>;
}

<span style="color: #177500">/*</span>
<span style="color: #177500"> * CRC for modbus over serial port.</span>
<span style="color: #177500"> */</span>
<span style="color: #A90D91">static</span> <span style="color: #A90D91">const</span> <span style="color: #A90D91">uint16_t</span> <span style="color: #000000">mb_crc_tbl</span>[] <span style="color: #000000">=</span> {
    <span style="color: #1C01CE">0x0000</span>, <span style="color: #1C01CE">0xcc01</span>, <span style="color: #1C01CE">0xd801</span>, <span style="color: #1C01CE">0x1400</span>, <span style="color: #1C01CE">0xf001</span>, <span style="color: #1C01CE">0x3c00</span>, <span style="color: #1C01CE">0x2800</span>, <span style="color: #1C01CE">0xe401</span>,
    <span style="color: #1C01CE">0xa001</span>, <span style="color: #1C01CE">0x6c00</span>, <span style="color: #1C01CE">0x7800</span>, <span style="color: #1C01CE">0xb401</span>, <span style="color: #1C01CE">0x5000</span>, <span style="color: #1C01CE">0x9c01</span>, <span style="color: #1C01CE">0x8801</span>, <span style="color: #1C01CE">0x4400</span>
};

<span style="color: #A90D91">static</span> <span style="color: #A90D91">uint16_t</span>
<span style="color: #000000">mb_crc</span>(<span style="color: #A90D91">const</span> <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">*data</span>, <span style="color: #A90D91">int</span> <span style="color: #000000">len</span>, <span style="color: #A90D91">uint16_t</span> <span style="color: #000000">crc</span>)
{
    <span style="color: #A90D91">while</span> (<span style="color: #000000">len--</span> <span style="color: #000000">&gt;</span> <span style="color: #1C01CE">0</span>) {
        <span style="color: #000000">crc</span> <span style="color: #000000">^=</span> <span style="color: #000000">*data++</span>;
        <span style="color: #000000">crc</span> <span style="color: #000000">=</span> (<span style="color: #000000">crc</span> <span style="color: #000000">&gt;&gt;</span> <span style="color: #1C01CE">4</span>) <span style="color: #000000">^</span> <span style="color: #000000">mb_crc_tbl</span>[<span style="color: #000000">crc</span> <span style="color: #000000">&amp;</span> <span style="color: #1C01CE">0xf</span>];
        <span style="color: #000000">crc</span> <span style="color: #000000">=</span> (<span style="color: #000000">crc</span> <span style="color: #000000">&gt;&gt;</span> <span style="color: #1C01CE">4</span>) <span style="color: #000000">^</span> <span style="color: #000000">mb_crc_tbl</span>[<span style="color: #000000">crc</span> <span style="color: #000000">&amp;</span> <span style="color: #1C01CE">0xf</span>];
    }
    <span style="color: #A90D91">return</span> <span style="color: #000000">crc</span>;
}

<span style="color: #A90D91">static</span> <span style="color: #A90D91">int</span>
<span style="color: #000000">mb_crc_check</span>(<span style="color: #A90D91">const</span> <span style="color: #A90D91">void</span> <span style="color: #000000">*pkt</span>, <span style="color: #A90D91">int</span> <span style="color: #000000">len</span>)
{
    <span style="color: #A90D91">uint16_t</span> <span style="color: #000000">crc</span>, <span style="color: #000000">cmp</span>;
    <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">*bp</span> <span style="color: #000000">=</span> (<span style="color: #A90D91">uint8_t</span> <span style="color: #000000">*</span>)<span style="color: #000000">pkt</span>;

    <span style="color: #A90D91">if</span> (<span style="color: #000000">len</span> <span style="color: #000000">&lt;</span> <span style="color: #A90D91">sizeof</span>(<span style="color: #000000">crc</span>) <span style="color: #000000">+</span> <span style="color: #1C01CE">1</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">-</span><span style="color: #1C01CE">1</span>;
    }
    <span style="color: #000000">crc</span> <span style="color: #000000">=</span> <span style="color: #000000">mb_crc</span>(<span style="color: #000000">pkt</span>, <span style="color: #000000">len</span> <span style="color: #000000">-</span> <span style="color: #1C01CE">2</span>, <span style="color: #1C01CE">0xffff</span>);
    <span style="color: #000000">cmp</span> <span style="color: #000000">=</span> <span style="color: #000000">bp</span>[<span style="color: #000000">len</span> <span style="color: #000000">-</span> <span style="color: #1C01CE">2</span>] <span style="color: #000000">|</span> (<span style="color: #000000">bp</span>[<span style="color: #000000">len</span> <span style="color: #000000">-</span> <span style="color: #1C01CE">1</span>] <span style="color: #000000">&lt;&lt;</span> <span style="color: #1C01CE">8</span>);
    <span style="color: #A90D91">if</span> (<span style="color: #000000">crc</span> <span style="color: #000000">!=</span> <span style="color: #000000">cmp</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">-</span><span style="color: #1C01CE">1</span>;
    } <span style="color: #A90D91">else</span> {
        <span style="color: #A90D91">return</span> <span style="color: #1C01CE">0</span>;
    }
}

<span style="color: #A90D91">static</span> <span style="color: #A90D91">int</span>
<span style="color: #000000">senseair_rx_char</span>(<span style="color: #A90D91">void</span> <span style="color: #000000">*arg</span>, <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">data</span>)
{
    <span style="color: #A90D91">struct</span> <span style="color: #000000">senseair</span> <span style="color: #000000">*s</span> <span style="color: #000000">=</span> (<span style="color: #A90D91">struct</span> <span style="color: #000000">senseair</span> <span style="color: #000000">*</span>)<span style="color: #000000">arg</span>;
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;

    <span style="color: #A90D91">if</span> (<span style="color: #000000">s-&gt;rx_off</span> <span style="color: #000000">&gt;=</span> <span style="color: #A90D91">sizeof</span>(<span style="color: #000000">s-&gt;rx_data</span>)) {
        <span style="color: #000000">s-&gt;rx_off</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">0</span>;
    }
    <span style="color: #000000">s-&gt;rx_data</span>[<span style="color: #000000">s-&gt;rx_off</span>] <span style="color: #000000">=</span> <span style="color: #000000">data</span>;
    <span style="color: #000000">s-&gt;rx_off++</span>;

    <span style="color: #A90D91">if</span> (<span style="color: #000000">s-&gt;rx_off</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">7</span>) {
        <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">mb_crc_check</span>(<span style="color: #000000">s-&gt;rx_data</span>, <span style="color: #000000">s-&gt;rx_off</span>);
        <span style="color: #A90D91">if</span> (<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #1C01CE">0</span>) {
            <span style="color: #000000">s-&gt;value</span> <span style="color: #000000">=</span> <span style="color: #000000">s-&gt;rx_data</span>[<span style="color: #1C01CE">3</span>] <span style="color: #000000">*</span> <span style="color: #1C01CE">256</span> <span style="color: #000000">+</span> <span style="color: #000000">s-&gt;rx_data</span>[<span style="color: #1C01CE">4</span>];
            <span style="color: #000000">os_sem_release</span>(<span style="color: #000000">&amp;s-&gt;sema</span>);
        }
    }
    <span style="color: #A90D91">return</span> <span style="color: #1C01CE">0</span>;
}

<span style="color: #A90D91">void</span>
<span style="color: #000000">senseair_tx</span>(<span style="color: #A90D91">struct</span> <span style="color: #000000">senseair</span> <span style="color: #000000">*s</span>, <span style="color: #A90D91">const</span> <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">*tx_data</span>, <span style="color: #A90D91">int</span> <span style="color: #000000">data_len</span>)
{
    <span style="color: #000000">s-&gt;tx_data</span> <span style="color: #000000">=</span> <span style="color: #000000">tx_data</span>;
    <span style="color: #000000">s-&gt;tx_len</span> <span style="color: #000000">=</span> <span style="color: #000000">data_len</span>;
    <span style="color: #000000">s-&gt;tx_off</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">0</span>;
    <span style="color: #000000">s-&gt;rx_off</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">0</span>;

    <span style="color: #000000">hal_uart_start_tx</span>(<span style="color: #000000">s-&gt;uart</span>);
}

<span style="color: #A90D91">int</span>
<span style="color: #000000">senseair_read</span>(<span style="color: #A90D91">enum</span> <span style="color: #000000">senseair_read_type</span> <span style="color: #000000">type</span>)
{
    <span style="color: #A90D91">struct</span> <span style="color: #000000">senseair</span> <span style="color: #000000">*s</span> <span style="color: #000000">=</span> <span style="color: #000000">&amp;senseair</span>;
    <span style="color: #A90D91">const</span> <span style="color: #A90D91">uint8_t</span> <span style="color: #000000">*cmd</span>;
    <span style="color: #A90D91">int</span> <span style="color: #000000">cmd_len</span>;
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;

    <span style="color: #A90D91">if</span> (<span style="color: #000000">s-&gt;tx_data</span>) {
        <span style="color: #177500">/*</span>
<span style="color: #177500">         * busy</span>
<span style="color: #177500">         */</span>
        <span style="color: #A90D91">return</span> <span style="color: #000000">-</span><span style="color: #1C01CE">1</span>;
    }
    <span style="color: #A90D91">switch</span> (<span style="color: #000000">type</span>) {
    <span style="color: #A90D91">case</span> <span style="color: #000000">SENSEAIR_CO2</span>:
        <span style="color: #000000">cmd</span> <span style="color: #000000">=</span> <span style="color: #000000">cmd_read_co2</span>;
        <span style="color: #000000">cmd_len</span> <span style="color: #000000">=</span> <span style="color: #A90D91">sizeof</span>(<span style="color: #000000">cmd_read_co2</span>);
        <span style="color: #A90D91">break</span>;
    <span style="color: #A90D91">case</span> <span style="color: #000000">SENSEAIR_TEMPERATURE</span>:
        <span style="color: #000000">cmd</span> <span style="color: #000000">=</span> <span style="color: #000000">cmd_read_temp</span>;
        <span style="color: #000000">cmd_len</span> <span style="color: #000000">=</span> <span style="color: #A90D91">sizeof</span>(<span style="color: #000000">cmd_read_temp</span>);
        <span style="color: #A90D91">break</span>;
    <span style="color: #A90D91">case</span> <span style="color: #000000">SENSEAIR_HUMIDITY</span>:
        <span style="color: #000000">cmd</span> <span style="color: #000000">=</span> <span style="color: #000000">cmd_read_humidity</span>;
        <span style="color: #000000">cmd_len</span> <span style="color: #000000">=</span> <span style="color: #A90D91">sizeof</span>(<span style="color: #000000">cmd_read_humidity</span>);
        <span style="color: #A90D91">break</span>;
    <span style="color: #A90D91">default</span><span style="color: #000000">:</span>
        <span style="color: #A90D91">return</span> <span style="color: #000000">-</span><span style="color: #1C01CE">1</span>;
    }
    <span style="color: #000000">senseair_tx</span>(<span style="color: #000000">s</span>, <span style="color: #000000">cmd</span>, <span style="color: #000000">cmd_len</span>);
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_sem_pend</span>(<span style="color: #000000">&amp;s-&gt;sema</span>, <span style="color: #000000">OS_TICKS_PER_SEC</span> <span style="color: #000000">/</span> <span style="color: #1C01CE">2</span>);
    <span style="color: #A90D91">if</span> (<span style="color: #000000">rc</span> <span style="color: #000000">==</span> <span style="color: #000000">OS_TIMEOUT</span>) {
        <span style="color: #177500">/*</span>
<span style="color: #177500">         * timeout</span>
<span style="color: #177500">         */</span>
        <span style="color: #A90D91">return</span> <span style="color: #000000">-</span><span style="color: #1C01CE">2</span>;
    }
    <span style="color: #A90D91">return</span> <span style="color: #000000">s-&gt;value</span>;
}

<span style="color: #A90D91">static</span> <span style="color: #A90D91">int</span>
<span style="color: #000000">senseair_shell_func</span>(<span style="color: #A90D91">int</span> <span style="color: #000000">argc</span>, <span style="color: #A90D91">char</span> <span style="color: #000000">**argv</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">value</span>;
    <span style="color: #A90D91">enum</span> <span style="color: #000000">senseair_read_type</span> <span style="color: #000000">type</span>;

    <span style="color: #A90D91">if</span> (<span style="color: #000000">argc</span> <span style="color: #000000">&lt;</span> <span style="color: #1C01CE">2</span>) {
<span style="color: #000000">usage</span>:
        <span style="color: #000000">console_printf</span>(<span style="color: #C41A16">&quot;%s &lt;co2|temp|humidity&gt;\n&quot;</span>, <span style="color: #000000">argv</span>[<span style="color: #1C01CE">0</span>]);
        <span style="color: #A90D91">return</span> <span style="color: #1C01CE">0</span>;
    }
    <span style="color: #A90D91">if</span> (<span style="color: #000000">!strcmp</span>(<span style="color: #000000">argv</span>[<span style="color: #1C01CE">1</span>], <span style="color: #C41A16">&quot;co2&quot;</span>)) {
        <span style="color: #000000">type</span> <span style="color: #000000">=</span> <span style="color: #000000">SENSEAIR_CO2</span>;
    } <span style="color: #A90D91">else</span> <span style="color: #A90D91">if</span> (<span style="color: #000000">!strcmp</span>(<span style="color: #000000">argv</span>[<span style="color: #1C01CE">1</span>], <span style="color: #C41A16">&quot;temp&quot;</span>)) {
        <span style="color: #000000">type</span> <span style="color: #000000">=</span> <span style="color: #000000">SENSEAIR_TEMPERATURE</span>;
    } <span style="color: #A90D91">else</span> <span style="color: #A90D91">if</span> (<span style="color: #000000">!strcmp</span>(<span style="color: #000000">argv</span>[<span style="color: #1C01CE">1</span>], <span style="color: #C41A16">&quot;humidity&quot;</span>)) {
        <span style="color: #177500">/*</span>
<span style="color: #177500">         * timeout</span>
<span style="color: #177500">         */</span>
        <span style="color: #A90D91">return</span> <span style="color: #000000">-</span><span style="color: #1C01CE">2</span>;
    }
    <span style="color: #A90D91">return</span> <span style="color: #000000">s-&gt;value</span>;
}

<span style="color: #A90D91">static</span> <span style="color: #A90D91">int</span>
<span style="color: #000000">senseair_shell_func</span>(<span style="color: #A90D91">int</span> <span style="color: #000000">argc</span>, <span style="color: #A90D91">char</span> <span style="color: #000000">**argv</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">value</span>;
    <span style="color: #A90D91">enum</span> <span style="color: #000000">senseair_read_type</span> <span style="color: #000000">type</span>;

    <span style="color: #A90D91">if</span> (<span style="color: #000000">argc</span> <span style="color: #000000">&lt;</span> <span style="color: #1C01CE">2</span>) {
<span style="color: #000000">usage</span>:
        <span style="color: #000000">console_printf</span>(<span style="color: #C41A16">&quot;%s &lt;co2|temp|humidity&gt;\n&quot;</span>, <span style="color: #000000">argv</span>[<span style="color: #1C01CE">0</span>]);
        <span style="color: #A90D91">return</span> <span style="color: #1C01CE">0</span>;
    }
    <span style="color: #A90D91">if</span> (<span style="color: #000000">!strcmp</span>(<span style="color: #000000">argv</span>[<span style="color: #1C01CE">1</span>], <span style="color: #C41A16">&quot;co2&quot;</span>)) {
        <span style="color: #000000">type</span> <span style="color: #000000">=</span> <span style="color: #000000">SENSEAIR_CO2</span>;
    } <span style="color: #A90D91">else</span> <span style="color: #A90D91">if</span> (<span style="color: #000000">!strcmp</span>(<span style="color: #000000">argv</span>[<span style="color: #1C01CE">1</span>], <span style="color: #C41A16">&quot;temp&quot;</span>)) {
        <span style="color: #000000">type</span> <span style="color: #000000">=</span> <span style="color: #000000">SENSEAIR_TEMPERATURE</span>;
    } <span style="color: #A90D91">else</span> <span style="color: #A90D91">if</span> (<span style="color: #000000">!strcmp</span>(<span style="color: #000000">argv</span>[<span style="color: #1C01CE">1</span>], <span style="color: #C41A16">&quot;humidity&quot;</span>)) {
        <span style="color: #000000">type</span> <span style="color: #000000">=</span> <span style="color: #000000">SENSEAIR_HUMIDITY</span>;
    } <span style="color: #A90D91">else</span> {
        <span style="color: #A90D91">goto</span> <span style="color: #000000">usage</span>;
    }
    <span style="color: #000000">value</span> <span style="color: #000000">=</span> <span style="color: #000000">senseair_read</span>(<span style="color: #000000">type</span>);
    <span style="color: #A90D91">if</span> (<span style="color: #000000">value</span> <span style="color: #000000">&gt;=</span> <span style="color: #1C01CE">0</span>) {
        <span style="color: #000000">console_printf</span>(<span style="color: #C41A16">&quot;Got %d\n&quot;</span>, <span style="color: #000000">value</span>);
    } <span style="color: #A90D91">else</span> {
        <span style="color: #000000">console_printf</span>(<span style="color: #C41A16">&quot;Error while reading: %d\n&quot;</span>, <span style="color: #000000">value</span>);
    }
    <span style="color: #A90D91">return</span> <span style="color: #1C01CE">0</span>;
}

<span style="color: #A90D91">int</span>
<span style="color: #000000">senseair_init</span>(<span style="color: #A90D91">int</span> <span style="color: #000000">uartno</span>)
{
    <span style="color: #A90D91">int</span> <span style="color: #000000">rc</span>;
    <span style="color: #A90D91">struct</span> <span style="color: #000000">senseair</span> <span style="color: #000000">*s</span> <span style="color: #000000">=</span> <span style="color: #000000">&amp;senseair</span>;

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">shell_cmd_register</span>(<span style="color: #000000">&amp;senseair_cmd</span>);
    <span style="color: #A90D91">if</span> (<span style="color: #000000">rc</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">rc</span>;
    }

    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">os_sem_init</span>(<span style="color: #000000">&amp;s-&gt;sema</span>, <span style="color: #1C01CE">1</span>);
    <span style="color: #A90D91">if</span> (<span style="color: #000000">rc</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">rc</span>;
    }
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">hal_uart_init_cbs</span>(<span style="color: #000000">uartno</span>, <span style="color: #000000">senseair_tx_char</span>, <span style="color: #A90D91">NULL</span>,
      <span style="color: #000000">senseair_rx_char</span>, <span style="color: #000000">&amp;senseair</span>);
    <span style="color: #A90D91">if</span> (<span style="color: #000000">rc</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">rc</span>;
    }
    <span style="color: #000000">rc</span> <span style="color: #000000">=</span> <span style="color: #000000">hal_uart_config</span>(<span style="color: #000000">uartno</span>, <span style="color: #1C01CE">9600</span>, <span style="color: #1C01CE">8</span>, <span style="color: #1C01CE">1</span>, <span style="color: #000000">HAL_UART_PARITY_NONE</span>,
      <span style="color: #000000">HAL_UART_FLOW_CTL_NONE</span>);
    <span style="color: #A90D91">if</span> (<span style="color: #000000">rc</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">rc</span>;
    }
    <span style="color: #000000">s-&gt;uart</span> <span style="color: #000000">=</span> <span style="color: #000000">uartno</span>;

    <span style="color: #A90D91">return</span> <span style="color: #1C01CE">0</span>;
}
</pre></div>


<p>And you modified your main() for senseair driver init.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">int</span>
<span style="color: #000000">main</span>(<span style="color: #A90D91">int</span> <span style="color: #000000">argc</span>, <span style="color: #A90D91">char</span> <span style="color: #000000">**argv</span>)
{
    ....
    <span style="color: #000000">senseair_init</span>(<span style="color: #1C01CE">1</span>);
    ....
    }
</pre></div>


<p>You can see from the code that you are using the HAL interface to open a UART port, and using OS semaphore as a way of blocking the task when waiting for read response to come back from the sensor.</p>
                        
                        <div class="row">
                            <footer>
    <div class="row">
        <div class="col-md-12">
            
                <p class="copyright">Copyright &copy; 2015 The Apache Software Foundation, Licensed under the Apache License, Version 2.0 Apache and the Apache feather logo are trademarks of The Apache Software Foundation.<br>The Apache Software Foundation Apache Incubator</p>
            
        </div>
    </div>
    <div class="copyright-logos">
        <div class="row">
            <div class="col-xs-6 text-right">
                <img src="/img/apache-feather.png" alt="Apache" title="Apache">
            </div>
            <div class="col-xs-6 text-left">
                <img src="/img/apache-logo.png" alt="Apache Incubator" title="Apache Incubator">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
        </div>
    </div>
</footer>
                        </div>
                    </div>
                </div>
            
            
        </div>

        <script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script>
        <script src="../../../js/base.js"></script>
        <script src="../../../js/custom.js"></script>

    </body>
</html>