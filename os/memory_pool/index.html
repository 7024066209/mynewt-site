<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://mynewt.incubator.apache.org/os/memory_pool/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Memory Pools - Apache Mynewt</title>

        <link href="../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../css/custom.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900,300,100' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'mynewt.incubator.apache.org');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Memory Pools">


        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="logo-container">
        <img src="/img/logo.svg">
    </div>
    <div class="container-fluid">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/documentation/">Docs</a>
                </li>
                <li>
                    <a href="/download/">Download</a>
                </li>
                <li>
                    <a href="/community/">Community</a>
                </li>
                <li>
                    <a href="/events/">Events</a>
                </li>
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
    </div>
</div>

        <div class="container-fluid">
            
                <div class="row sm-extra-padding">
                    <div class="col-md-3 bg-grey sidebar-container"><div class="bs-sidebar hidden-print" role="complementary">
    <div class="sidebar-top">
        <img class="hidden-xs hidden-sm logo-small" src="/img/logo.svg" alt="MyNewt" title="MyNewt">
        <div class="small" role="search">
            <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" placeholder="Search documentation" />
                    <button class="search-button" type="submit"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>
    <ul class="nav bs-sidenav">
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  <li><a href="
  ../../get_started/newt_concepts/
">Chapter 1 - Get Started</a>
    
  </li>

        
      
        
          
  
  <li><a href="
  ../../get_acclimated/vocabulary/
">Chapter 2 - Get Acclimated</a>
    
  </li>

        
      
        
          
  
  <li><a href="
  ../../newt/newt_ops/
">Chapter 3 - Newt Tool</a>
    
  </li>

        
      
        
          
  
  <li><a href="
  ../mynewt_os/
">Chapter 4 - Mynewt OS</a>
    
      <ul class="current-toc">
          
              
  
    <li>
      <a href="../mynewt_os/">Overview</a>
    </li>
  

          
              
  
    <li>
      <a href="../context_switch/">Scheduler/Context Switching</a>
    </li>
  

          
              
  
    <li>
      <a href="../time/">Time</a>
    </li>
  

          
              
  
    <li>
      <a href="../task/">Tasks</a>
    </li>
  

          
              
  
    <li>
      <a href="../event_queue/">Event Queues</a>
    </li>
  

          
              
  
    <li>
      <a href="../semaphore/">Semaphores</a>
    </li>
  

          
              
  
    <li>
      <a href="../mutex/">Mutexes</a>
    </li>
  

          
              
  
    <li class="active">
      Memory Pools
    </li>
  

          
              
  
    <li>
      <a href="../heap/">Heap</a>
    </li>
  

          
              
  
    <li>
      <a href="../mbufs/">Mbufs</a>
    </li>
  

          
              
  
    <li>
      <a href="../sanity/">Sanity</a>
    </li>
  

          
              
  
    <li>
      <a href="../callout/">Callout Functions</a>
    </li>
  

          
              
  
    <li>
      <a href="../port_os/">Porting to other Platforms</a>
    </li>
  

          
      </ul>
    
  </li>

        
      
        
          
  
  <li><a href="
  
  
  ../../modules/console/console/

">Chapter 5 - Modules</a>
    
  </li>

        
      
        
          
  
  <li><a href="
  ../../newtmgr/overview/
">Chapter 6 - Newt Manager</a>
    
  </li>

        
      
        
          
  
  <li><a href="
  ../../packaging/dist/
">Chapter 7 - Packaging it</a>
    
  </li>

        
      
    </ul>
</div></div>
                    
                    <div class="show-sidebar-container">
                        <button class="show-sidebar">Docs Menu</button>
                    </div>
                    
                    <div class="col-md-9 documentation-viewer" role="main">
                        <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Chapter 4 - Mynewt OS &raquo;</li>
        
      
    
    <li>Memory Pools</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
                        
                            <h1 id="memory-pools">Memory Pools<a class="headerlink" href="#memory-pools" title="Permanent link">&para;</a></h1>
<p>Memory can be pre-allocated to a pool of fixed size elements.</p>
<h2 id="description">Description<a class="headerlink" href="#description" title="Permanent link">&para;</a></h2>
<p>Sometimes it's useful to have several memory blocks of same size preallocated for specific use. E.g. you want to limit the amount of memory used for it, or you want to make sure that there is memory available when you ask for it.</p>
<p>This can be done using a memory pool. You allocate memory either statically or from heap, and then designate that memory to be used as storage for fixed size elements.</p>
<p>Pool will be initialized by calling <em>os_mempool_init()</em>. Element can be allocated from it with <em>os_mempool_get()</em>, and released back with <em>os_mempool_put()</em>.</p>
<h2 id="data-structures">Data structures<a class="headerlink" href="#data-structures" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">struct os_mempool {
    int mp_block_size;
    int mp_num_blocks;
    int mp_num_free;
    SLIST_HEAD(,os_memblock);
    char *name;
};
</code></pre>

<table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mp_block_size</td>
<td>Size of the memory blocks, in bytes</td>
</tr>
<tr>
<td>mp_num_blocks</td>
<td>Number of memory blocks in the pool</td>
</tr>
<tr>
<td>mp_num_free</td>
<td>Number of free blocks left</td>
</tr>
<tr>
<td>name</td>
<td>Name for the memory block</td>
</tr>
</tbody>
</table>
<h2 id="list-of-functions">List of Functions<a class="headerlink" href="#list-of-functions" title="Permanent link">&para;</a></h2>
<p><Comments such as these instructions are placed within angle brackets. List all the functions here. Note how the anchors work. You put the text you want to show up as a link within [] and the relevant #heading within (). Note that the header has to have at least 2 words for the anchor to work - that's how it is. "no-highlight" disables syntax highlighting. You can enable it for a particular language by specifying what the language is instead of "no-highlight". Be warned that this highlighting or no-highlighting specification may not show up nicely on Mou.></p>
<p>The functions available in this OS feature are:</p>
<ul>
<li><a href="#os_mempool_init">os_mempool_init</a></li>
<li><a href="#os_memblock_get">os_memblock_get</a></li>
<li><a href="#os_memblock_put">os_memblock_put</a></li>
<li><a href="#OS_MEMPOOL_BYTES">OS_MEMPOOL_BYTES</a></li>
</ul>
<h2 id="function-reference">Function Reference<a class="headerlink" href="#function-reference" title="Permanent link">&para;</a></h2>
<hr />
<h2 id="os_mempool_init"><font color="F2853F" style="font-size:24pt"> os_mempool_init</font><a class="headerlink" href="#os_mempool_init" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">os_error_t os_mempool_init(struct os_mempool *mp, int blocks, int block_size, void *membuf, char *name)
</code></pre>

<p>Initializes the memory pool. Memory pointed by <em>membuf</em> is taken and <em>blocks</em> number of elements of size <em>block_size</em> are added to the pool. <em>name</em> is optional, and names the memory pool.</p>
<p>It is assumed that the amount of memory pointed by <em>membuf</em> has at least <em>OS_MEMPOOL_BYTES(blocks, block_size)</em> number of bytes.</p>
<p><em>name</em> is not copied, so caller should make sure that the memory does not get reused.</p>
<h4 id="arguments">Arguments<a class="headerlink" href="#arguments" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mp</td>
<td>Memory pool being initialized</td>
</tr>
<tr>
<td>blocks</td>
<td>Number of elements in the pool</td>
</tr>
<tr>
<td>block_size</td>
<td>Size of an individual element in pool</td>
</tr>
<tr>
<td>membuf</td>
<td>Backing store for the memory pool elements</td>
</tr>
<tr>
<td>name</td>
<td>Name of the memory pool</td>
</tr>
</tbody>
</table>
<h4 id="returned-values">Returned values<a class="headerlink" href="#returned-values" title="Permanent link">&para;</a></h4>
<p>OS_OK: operation was successful.
OS_INVALID_PARAM: invalid parameters. Block count or block size was negative, or membuf or mp was NULL.
OS_MEM_NOT_ALIGNED: membuf has to be aligned to 4 byte boundary.</p>
<h4 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">&para;</a></h4>
<p>Note that os_mempool_init() does not allocate backing storage. <em>membuf</em> has to be allocated by the caller.</p>
<p>It's recommended that you use <em>OS_MEMPOOL_BYTES()</em> to figure out how much memory to allocate for the pool.</p>
<h4 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h4>
<p><Add text to set up the context for the example here></p>
<pre><code class="no-highlight">    rc = os_mempool_init(&amp;nffs_file_pool, nffs_config.nc_num_files,
                         sizeof (struct nffs_file), nffs_file_mem,
                         &quot;nffs_file_pool&quot;);
    if (rc != 0) {
        return FS_EOS;
    }

</code></pre>

<hr />
<h2 id="os_memblock_get"><font color="#F2853F" style="font-size:24pt"> os_memblock_get</font><a class="headerlink" href="#os_memblock_get" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">void *os_memblock_get(struct os_mempool *mp)
</code></pre>

<p>Allocate an element from the memory pool. If succesful, you'll get a pointer to allocated element. If there are no elements available, you'll get NULL as response.</p>
<h4 id="arguments_1">Arguments<a class="headerlink" href="#arguments_1" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mp</td>
<td>Pool where element is getting allocated from</td>
</tr>
</tbody>
</table>
<h4 id="returned-values_1">Returned values<a class="headerlink" href="#returned-values_1" title="Permanent link">&para;</a></h4>
<p>NULL: no elements available.
<pointer>: pointer to allocated element.</p>
<h4 id="notes_1">Notes<a class="headerlink" href="#notes_1" title="Permanent link">&para;</a></h4>
<h4 id="example_1">Example<a class="headerlink" href="#example_1" title="Permanent link">&para;</a></h4>
<p><Add text to set up the context for the example here></p>
<pre><code class="no-highlight">    struct nffs_file *file;

    file = os_memblock_get(&amp;nffs_file_pool);
    if (file != NULL) {
        memset(file, 0, sizeof *file);
    }

</code></pre>

<hr />
<h2 id="os_memblock_put"><font color="#F2853F" style="font-size:24pt">os_memblock_put</font><a class="headerlink" href="#os_memblock_put" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">os_error_t os_memblock_put(struct os_mempool *mp, void *block_addr)
</code></pre>

<p>Releases previously allocated element back to the pool.</p>
<h4 id="arguments_2">Arguments<a class="headerlink" href="#arguments_2" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mp</td>
<td>Pointer to memory pool where element is put</td>
</tr>
<tr>
<td>block_addr</td>
<td>Pointer to element getting freed</td>
</tr>
</tbody>
</table>
<h4 id="returned-values_2">Returned values<a class="headerlink" href="#returned-values_2" title="Permanent link">&para;</a></h4>
<p>OS_OK: operation was a success:
OS_INVALID_PARAM: If either mp or block_addr were NULL.</p>
<h4 id="notes_2">Notes<a class="headerlink" href="#notes_2" title="Permanent link">&para;</a></h4>
<h4 id="example_2">Example<a class="headerlink" href="#example_2" title="Permanent link">&para;</a></h4>
<p><Add text to set up the context for the example here></p>
<pre><code class="no-highlight">    if (file != NULL) {
        rc = os_memblock_put(&amp;nffs_file_pool, file);
        if (rc != 0) {
            return FS_EOS;
        }
    }
</code></pre>

<hr />
<h2 id="os_mempool_bytes"><font color="#F2853F" style="font-size:24pt">OS_MEMPOOL_BYTES</font><a class="headerlink" href="#os_mempool_bytes" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">OS_MEMPOOL_BYTES(n,blksize)
</code></pre>

<p>Calculates how many bytes of memory is used by <em>n</em> number of elements, when individual element size is <em>blksize</em> bytes.</p>
<h4 id="arguments_3">Arguments<a class="headerlink" href="#arguments_3" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>Number of elements</td>
</tr>
<tr>
<td>blksize</td>
<td>Size of an element is number of bytes</td>
</tr>
</tbody>
</table>
<h4 id="returned-values_3">Returned values<a class="headerlink" href="#returned-values_3" title="Permanent link">&para;</a></h4>
<p>List any values returned.
Error codes?</p>
<h4 id="notes_3">Notes<a class="headerlink" href="#notes_3" title="Permanent link">&para;</a></h4>
<h4 id="example_3">Example<a class="headerlink" href="#example_3" title="Permanent link">&para;</a></h4>
<p>Here we allocate memory to be used as a pool.</p>
<pre><code class="no-highlight">void *nffs_file_mem;

nffs_file_mem = malloc(
        OS_MEMPOOL_BYTES(nffs_config.nc_num_files, sizeof (struct nffs_file)));
    if (nffs_file_mem == NULL) {
        return FS_ENOMEM;
    }
</code></pre>

<hr />
                        
                    </div>
                </div>
            
            <div class="row">    
                <footer>
    <div class="row">
        <div class="col-md-12">
            
                <p class="copyright">Copyright &copy; 2015 The Apache Software Foundation, Licensed under the Apache License, Version 2.0 Apache and the Apache feather logo are trademarks of The Apache Software Foundation.<br>The Apache Software Foundation Apache Incubator</p>
            
        </div>
    </div>
    <div class="copyright-logos">
        <div class="row">
            <div class="col-xs-6 text-right">
                <img src="/img/apache-feather.png" alt="Apache" title="Apache">
            </div>
            <div class="col-xs-6 text-left">
                <img src="/img/apache-logo.png" alt="Apache Incubator" title="Apache Incubator">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
        </div>
    </div>
</footer>
            </div>
        </div>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../js/custom.js"></script>

    </body>
</html>