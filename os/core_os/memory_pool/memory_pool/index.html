<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://mynewt.apache.org/os/core_os/memory_pool/memory_pool/">
        <link rel="shortcut icon" href="../../../../img/favicon.ico">

	<title>Overview - Apache Mynewt</title>

        <link href="../../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../../../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../../css/highlight.css">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link href="../../../../css/custom.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900,300,100' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'mynewt.incubator.apache.org');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Overview">


        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="logo-container">
        <img src="/img/logo.svg">
    </div>
    <div class="container-fluid">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/documentation/">Docs</a>
                </li>
                <li>
                    <a href="/download/">Download</a>
                </li>
                <li>
                    <a href="/community/">Community</a>
                </li>
                <li>
                    <a href="/events/">Events</a>
                </li>
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
    </div>
</div>

        <div class="container-fluid">
            
                <div class="row sm-extra-padding">
                    <div class="col-md-3 bg-grey sidebar-container"><div class="bs-sidebar hidden-print" role="complementary">
    <div class="sidebar-top">
        <img class="hidden-xs hidden-sm logo-small" src="/img/logo.svg" alt="MyNewt" title="MyNewt">
        <div class="small" role="search">
            <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" placeholder="Search documentation" />
                    <button class="search-button" type="submit"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>
    <ul class="nav bs-sidenav">
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  
    <li><a href="
  ../../../get_started/introduction/
">Apache Mynewt Manual</a>
  
    
      <ul class="current-toc">
          
              
                
  
    <li>
      <a href="../../../get_started/introduction/">Introduction</a>
    </li>
  

              
          
              
                
  
  
    <li><a href="
  ../../../get_started/project1/
">Get Started</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../../tutorials/STM32F303/
">Tutorials</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  
  
  ../../mynewt_os/


">OS User Guide</a>
  
    
      <ul class="current-toc">
          
              
                
  
  
    <li><a href="
  
  
  ../../mynewt_os/

">OS Core</a>
  
    
      <ul class="current-toc">
          
              
                
  
  
    <li><a href="
  ../../mynewt_os/
">OS Fundamentals</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../context_switch/context_switch/
">Scheduler</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../time/os_time/
">Time</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../task/task/
">Tasks</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../event_queue/event_queue/
">Event Queues</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../semaphore/semaphore/
">Semaphores</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../mutex/mutex/
">Mutexes</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ./
">Memory Pools</a>
  
    
      <ul class="current-toc">
          
              
                
  
    <li class="active">
      Overview
    </li>
  

              
          
              
                
  
  
    <li><a href="
  ../os_memblock_get/
">Functions/Macros</a>
  
    
  </li>

              
          
      </ul>
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../heap/heap/
">Heap</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../mbuf/mbuf/

">Memory Buffers</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../sanity/sanity/
">Sanity</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../callout/callout/
">Callouts</a>
  
    
  </li>

              
          
      </ul>
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../porting/port_os/
">Porting to your Platform</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../../modules/console/console/
">Console</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../../modules/shell/shell/
">Shell</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../../modules/bootloader/bootloader/
">Bootloader</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../../modules/fs/fs/fs/

">File System</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../../modules/hal/hal/
">Hardware Abstraction Layer</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../../modules/testutil/testutil/
">Test Utilities</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../../modules/imgmgr/imgmgr/
">Image Manager</a>
  
    
  </li>

              
          
              
                
  
    <li>
      <a href="../../../modules/baselibc/">Baselibc library</a>
    </li>
  

              
          
              
                
  
  
    <li><a href="
  ../../../modules/elua/elua/
">Embedded Lua</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../../modules/json/json/
">JSON</a>
  
    
  </li>

              
          
      </ul>
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../../../network/ble/ble_intro/

">Networking User Guide</a>
  
    
  </li>

              
          
      </ul>
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../newt/newt_intro/
">Newt Tool Manual</a>
  
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../newtmgr/overview/
">Newt Manager Manual</a>
  
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../faq/answers/
">Appendix</a>
  
    
  </li>

        
      
    </ul>
</div></div>
                    
                    <div class="show-sidebar-container">
                        <button class="show-sidebar">Docs Menu</button>
                    </div>
                    
                    <div class="col-md-9 documentation-viewer" role="main">
                        <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../..">Docs</a></li>
    
      
        
          <li>&raquo; OS Core</li>
        
      
        
          <li>&raquo; Memory Pools</li>
        
      
      
        <li>&raquo; Overview</li>
      
    
    
  </ul>
  <hr/>
</div>
                        
                            <h1 id="memory-pools">Memory Pools<a class="headerlink" href="#memory-pools" title="Permanent link">&para;</a></h1>
<p>A memory pool is a collection of fixed sized elements called memory blocks. Generally, memory pools are used when the developer wants to allocate a certain amount of memory to a given feature. Unlike the heap, where a code module is at the mercy of other code modules to insure there is sufficient memory, memory pools can insure sufficient memory allocation.</p>
<h2 id="description">Description<a class="headerlink" href="#description" title="Permanent link">&para;</a></h2>
<p>In order to create a memory pool the developer needs to do a few things. The first task is to define the memory pool itself. This is a data structure which contains information about the pool itself (i.e. number of blocks, size of the blocks, etc).</p>
<pre><code class="no-highlight">struct os_mempool my_pool;
</code></pre>

<p><br>
The next order of business is to allocate the memory used by the memory pool. This memory can either be statically allocated (i.e. a global variable) or dynamically allocated (i.e. from the heap). When determining the amount of memory required for the memory pool, simply multiplying the number of blocks by the size of each block is not sufficient as the OS may have alignment requirements. The alignment size definition is named <code>OS_ALIGNMENT</code> and can be found in os_arch.h as it is architecture specific. The memory block alignment is usually for efficiency but may be due to other reasons. Generally, blocks are aligned on 32-bit boundaries. Note that memory blocks must also be of sufficient size to hold a list pointer as this is needed to chain memory blocks on the free list.</p>
<p>In order to simplify this for the user two macros have been provided: <code>OS_MEMPOOL_BYTES(n, blksize)</code> and <code>OS_MEMPOOL_SIZE(n, blksize)</code>. The first macro returns the number of bytes needed for the memory pool while the second returns the number of <code>os_membuf_t</code> elements required by the memory pool. The <code>os_membuf_t</code> type is used to guarantee that the memory buffer used by the memory pool is aligned on the correct boundary. </p>
<p>Here are some examples. Note that if a custom malloc implementation is used it must guarantee that the memory buffer used by the pool is allocated on the correct boundary (i.e. OS_ALIGNMENT).</p>
<pre><code class="no-highlight">void *my_memory_buffer;
my_memory_buffer = malloc(OS_MEMPOOL_BYTES(NUM_BLOCKS, BLOCK_SIZE));
</code></pre>

<pre><code class="no-highlight">os_membuf_t my_memory_buffer[OS_MEMPOOL_SIZE(NUM_BLOCKS, BLOCK_SIZE)];
</code></pre>

<p><br>
Now that the memory pool has been defined as well as the memory required for the memory blocks which make up the pool the user needs to initialize the memory pool by calling <code>os_mempool_init</code>.</p>
<pre><code class="no-highlight">os_mempool_init(&amp;my_pool, NUM_BLOCKS, BLOCK_SIZE, my_memory_buffer,
                         &quot;MyPool&quot;);
</code></pre>

<p><br>
Once the memory pool has been initialized the developer can allocate memory blocks from the pool by calling <code>os_memblock_get</code>. When the memory block is no longer needed the memory can be freed by calling <code>os_memblock_put</code>. </p>
<h2 id="data-structures">Data structures<a class="headerlink" href="#data-structures" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">struct os_mempool {
    int mp_block_size;
    int mp_num_blocks;
    int mp_num_free;
    uint32_t mp_membuf_addr;
    STAILQ_ENTRY(os_mempool) mp_list;    
    SLIST_HEAD(,os_memblock);
    char *name;
};
</code></pre>

<p><br></p>
<table>
<thead>
<tr>
<th><strong>Element</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>mp_block_size</td>
<td>Size of the memory blocks, in bytes. This is not the actual  number of bytes used by each block; it is the requested size of each block. The actual memory block size will be aligned to OS_ALIGNMENT bytes</td>
</tr>
<tr>
<td>mp_num_blocks</td>
<td>Number of memory blocks in the pool</td>
</tr>
<tr>
<td>mp_num_free</td>
<td>Number of free blocks left</td>
</tr>
<tr>
<td>mp_membuf_addr</td>
<td>The address of the memory block. This is used to check that a valid memory block is being freed.</td>
</tr>
<tr>
<td>mp_list</td>
<td>List pointer to chain memory pools so they can be displayed by newt tools</td>
</tr>
<tr>
<td>SLIST_HEAD(,os_memblock)</td>
<td>List pointer to chain free memory blocks</td>
</tr>
<tr>
<td>name</td>
<td>Name for the memory block</td>
</tr>
</tbody>
</table>
<h2 id="list-of-functions">List of Functions<a class="headerlink" href="#list-of-functions" title="Permanent link">&para;</a></h2>
<p>The functions available in mem_pool are:</p>
<ul>
<li><a href="../os_memblock_get">os_memblock_get</a></li>
<li><a href="../os_mempool_init">os_mempool_init</a></li>
<li><a href="../os_memblock_put">os_memblock_put</a></li>
<li><a href="../OS_MEMPOOL_BYTES">OS_MEMPOOL_BYTES</a></li>
<li><a href="../OS_MEMPOOL_SIZE">OS_MEMPOOL_SIZE</a></li>
</ul>
                        
                    </div>
                </div>
            
            <div class="row">    
                <footer>
    <div class="row">
        <div class="col-md-12">
            
                <p class="copyright">Copyright &copy; 2015 The Apache Software Foundation, Licensed under the Apache License, Version 2.0 Apache and the Apache feather logo are trademarks of The Apache Software Foundation.<br>The Apache Software Foundation Apache Incubator</p>
            
        </div>
    </div>
    <div class="copyright-logos">
        <div class="row">
            <div class="col-xs-6 text-right">
                <img src="/img/apache-feather.png" alt="Apache" title="Apache">
            </div>
            <div class="col-xs-6 text-left">
                <img src="/img/apache-logo.png" alt="Apache Incubator" title="Apache Incubator">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
        </div>
    </div>
</footer>
            </div>
        </div>

        <script src="../../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../../js/highlight.pack.js"></script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../js/custom.js"></script>

    </body>
</html>