<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://mynewt.apache.org/os/core_os/task/task/">
        <link rel="shortcut icon" href="../../../../img/favicon.ico">

	<title>toc - Apache Mynewt</title>

        <link href="../../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../../../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../../css/highlight.css">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link href="../../../../css/custom.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900,300,100' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'mynewt.incubator.apache.org');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="toc">


        <div id="navbar" class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="logo-container">
        <img src="/img/logo.svg">
    </div>
    <div class="container-fluid">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li class="dropdown">
                    <a href="/documentation/" class="dropdown-toggle" data-toggle="dropdown">Docs <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        
                        
                        
                        
                        <li >
                            <a href="../../../../documentation/">
                                Overview
                            </a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="active">
                            <a href="../../../get_started/introduction/">
                                Mynewt OS Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../../newt/newt_intro/">
                                Newt Tool Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../../newtmgr/overview/">
                                Newt Manager Manual
                            </a>
                        </li>
                        
                        
                        
                        <li >
                            <a href="../../../../faq/answers/">
                                Appendix
                            </a>
                        </li>
                        
                        
                    </ul>
                </li>
                <li>
                    <a href="/download/">Download</a>
                </li>
                <li>
                    <a href="/community/">Community</a>
                </li>
                <li>
                    <a href="/events/">Events</a>
                </li>
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
    </div>
</div>

        

        <div class="container-fluid">
            
                <div class="row sm-extra-padding">
                    <div id="docSidebar" class="col-md-3 bg-grey sidebar-container"><div class="bs-sidebar hidden-print" role="complementary">
    <div class="sidebar-top">
        <img class="hidden-xs hidden-sm logo-small" src="/img/logo.svg" alt="MyNewt" title="MyNewt">
        <div class="small" role="search">
            <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" placeholder="Search documentation" />
                    <button class="search-button" type="submit"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>
    <ul class="nav bs-sidenav">
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  
    <li><a href="
  ../../../get_started/introduction/
">Mynewt OS Manual</a>
  
    
      <ul class="current-toc">
          
              
                
  
    <li>
      <a href="../../../get_started/introduction/">Introduction</a>
    </li>
  

              
          
              
                
  
  
    <li><a href="
  ../../../get_started/project1/
">Get Started</a>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../get_started/vocabulary/">Concepts</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  ../../../tutorials/STM32F303/
">Tutorials</a>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../mynewt_os/

">OS User Guide</a>
  
    
      <ul class="current-toc">
          
              
                
  
  
    <li ><a href="../../mynewt_os/">OS Core</a></li>
  
    
      <ul class="current-toc">
          
              
          
              
                
  
  
    <li><a href="
  ../../os_init/
">System-level Functions</a>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../context_switch/context_switch/">Scheduler</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../time/os_time/">Time</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li class="active"><a href="./">Tasks</a></li>
  
    
      <ul class="current-toc">
          
              
          
              
                
  
  
    <li><a href="
  ../os_task_count/
">Functions</a>
  
    
  </li>

              
          
      </ul>
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../event_queue/event_queue/">Event Queues</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../semaphore/semaphore/">Semaphores</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../mutex/mutex/">Mutexes</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../memory_pool/memory_pool/">Memory Pools</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../heap/heap/">Heap</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../mbuf/mbuf/

">Memory Buffers</a>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../sanity/sanity/">Sanity</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../callout/callout/">Callouts</a></li>
  
    
  </li>

              
          
      </ul>
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../porting/port_os/">Porting to your Platform</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../modules/console/console/">Console</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../modules/shell/shell/">Shell</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../modules/bootloader/bootloader/">Bootloader</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../../modules/fs/fs/fs/

">File System</a>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../modules/hal/hal/">Hardware Abstraction Layer</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../modules/testutil/testutil/">Test Utilities</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../modules/imgmgr/imgmgr/">Image Manager</a></li>
  
    
  </li>

              
          
              
                
  
    <li>
      <a href="../../../modules/baselibc/">Baselibc library</a>
    </li>
  

              
          
              
                
  
  
    <li ><a href="../../../modules/elua/elua/">Embedded Lua</a></li>
  
    
  </li>

              
          
              
                
  
  
    <li ><a href="../../../modules/json/json/">JSON</a></li>
  
    
  </li>

              
          
      </ul>
    
  </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../../../network/ble/ble_intro/

">Networking User Guide</a>
  
    
  </li>

              
          
      </ul>
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../newt/newt_intro/
">Newt Tool Manual</a>
  
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../newtmgr/overview/
">Newt Manager Manual</a>
  
    
  </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../faq/answers/
">Appendix</a>
  
    
  </li>

        
      
    </ul>
</div></div>

                    <div class="show-sidebar-container">
                        <button class="show-sidebar">Docs Menu</button>
                    </div>

                    <div class="col-md-offset-3 col-md-9 documentation-viewer" role="main">
                        <div class="row doc-header">
                            <div class="col-sm-6">
                                
<ul class="nav nav-pills">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="active" role="presentation"><a href="../../../get_started/introduction/">Mynewt OS</a></li>
    
    
    
    <li  role="presentation"><a href="../../../../newt/newt_intro/">Newt Tool</a></li>
    
    
    
    <li  role="presentation"><a href="../../../../newtmgr/overview/">Newt Mgr</a></li>
    
    
    
    
</ul>
                            </div>
                            <div class="col-sm-6">
                                <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="/documentation/">Docs</a></li>
    
    
        
          <li>&raquo; <a href="../../mynewt_os/">OS Core</a></li>
        
      
        
          <li>&raquo; Tasks</li>
        
      
      
    
    
  </ul>
</div>
                            </div>
                        </div>
                        
                            <h1 id="task">Task<a class="headerlink" href="#task" title="Permanent link">&para;</a></h1>
<p>A task, along with the scheduler, forms the basis of the Mynewt OS. A task 
consists of two basic elements: a task stack and a task function. The task 
function is basically a forever loop, waiting for some "event" to wake it up. 
There are two methods used to signal a task that it has work to do: event queues 
and semaphores (see the appropriate manual sections for descriptions of these 
features).</p>
<p>The Mynewt OS is a multi-tasking, preemptive OS. Every task is assigned a task 
priority (from 0 to 255), with 0 being the highest priority task. If a higher 
priority task than the current task wants to run, the scheduler preempts the 
currently running task and switches context to the higher priority task. This is 
just a fancy way of saying that the processor stack pointer now points to the 
stack of the higher priority task and the task resumes execution where it left 
off.</p>
<p>Tasks run to completion unless they are preempted by a higher priority task. The 
developer must insure that tasks eventually "sleep"; otherwise lower priority 
tasks will never get a chance to run (actually, any task lower in priority than 
the task that never sleeps). A task will be put to sleep in the following cases: 
it puts itself to sleep using <code>os_time_delay()</code>, it waits on an event queue 
which is empty or attempts to obtain a mutex or a semaphore that is currently 
owned by another task.</p>
<p>Note that other sections of the manual describe these OS features in more 
detail.</p>
<h2 id="description">Description<a class="headerlink" href="#description" title="Permanent link">&para;</a></h2>
<p>In order to create a task two data structures need to be defined: the task 
object (struct os_task) and its associated stack. Determining the stack size can 
be a bit tricky; generally developers should not declare large local variables 
on the stack so that task stacks can be of limited size. However, all 
applications are different and the developer must choose the stack size 
accordingly. NOTE: be careful when declaring your stack! The stack is in units 
of <code>os_stack_t</code> sized elements (generally 32-bits). Looking at the example given 
below and assuming <code>os_stack_t</code> is defined to be a 32-bit unsigned value, 
"my_task_stack" will use 256 bytes. </p>
<p>A task must also have an associated "task function". This is the function that 
will be called when the task is first run. This task function should never 
return!</p>
<p>In order to inform the Mynewt OS of the new task and to have it added to the 
scheduler, the <code>os_task_init()</code> function is called. Once <code>os_task_init()</code> is 
called, the task is made ready to run and is added to the active task list. Note 
that a task can be initialized (started) before or after the os has started 
(i.e. before <code>os_start()</code> is called) but must be initialized after the os has 
been initialized (i.e. 'os_init' has been called). In most of the examples and 
current Mynewt projects, the os is initialized, tasks are initialized, and the 
the os is started. Once the os has started, the highest priority task will be 
the first task set to run.</p>
<p>Information about a task can be obtained using the <code>os_task_info_get_next()</code> 
API. Developers can walk the list of tasks to obtain information on all created 
tasks. This information is of type <code>os_task_info</code> and is described below.</p>
<p>The following is a very simple example showing a single application task. This 
task simply toggles an LED at a one second interval.</p>
<pre><code class="c">/* Create a simple &quot;project&quot; with a task that blinks a LED every second */

/* Define task stack and task object */
#define MY_TASK_PRI         (OS_TASK_PRI_HIGHEST) 
#define MY_STACK_SIZE       (64) 
struct os_task my_task; 
os_stack_t my_task_stack[MY_STACK_SIZE]; 

/* This is the task function */
void my_task_func(void *arg) {
    /* Set the led pin as an output */
    hal_gpio_init_out(LED_BLINK_PIN, 1);

    /* The task is a forever loop that does not return */
    while (1) {
        /* Wait one second */ 
        os_time_delay(1000);

        /* Toggle the LED */ 
        hal_gpio_toggle(LED_BLINK_PIN);
    }
}

/* This is the main function for the project */
int main(void) {
    int rc;

    /* Initialize OS */
    os_init();

    /* Initialize the task */
    os_task_init(&amp;my_task, &quot;my_task&quot;, my_task_func, NULL, MY_TASK_PRIO, 
                 OS_WAIT_FOREVER, my_task_stack, MY_STACK_SIZE);

    /* Start the OS */
    os_start();

    /* os start should never return. If it does, this should be an error */
    assert(0);

    return rc;
}
</code></pre>

<h2 id="data-structures">Data structures<a class="headerlink" href="#data-structures" title="Permanent link">&para;</a></h2>
<pre><code class="c">/* The highest and lowest task priorities */
#define OS_TASK_PRI_HIGHEST         (0)
#define OS_TASK_PRI_LOWEST          (0xff)

/* Task states */
typedef enum os_task_state {
    OS_TASK_READY = 1, 
    OS_TASK_SLEEP = 2
} os_task_state_t;

/* Task flags */
#define OS_TASK_FLAG_NO_TIMEOUT     (0x0001U)
#define OS_TASK_FLAG_SEM_WAIT       (0x0002U)
#define OS_TASK_FLAG_MUTEX_WAIT     (0x0004U)

typedef void (*os_task_func_t)(void *);

#define OS_TASK_MAX_NAME_LEN (32)
</code></pre>

<p><br></p>
<pre><code class="c">struct os_task {
    os_stack_t *t_stackptr;
    os_stack_t *t_stacktop;

    uint16_t t_stacksize;
    uint16_t t_flags;

    uint8_t t_taskid;
    uint8_t t_prio;
    uint8_t t_state;
    uint8_t t_pad;

    char *t_name;
    os_task_func_t t_func;
    void *t_arg;

    void *t_obj;

    struct os_sanity_check t_sanity_check; 

    os_time_t t_next_wakeup;
    os_time_t t_run_time;
    uint32_t t_ctx_sw_cnt;

    /* Global list of all tasks, irrespective of run or sleep lists */
    STAILQ_ENTRY(os_task) t_os_task_list;

    /* Used to chain task to either the run or sleep list */ 
    TAILQ_ENTRY(os_task) t_os_list;

    /* Used to chain task to an object such as a semaphore or mutex */
    SLIST_ENTRY(os_task) t_obj_list;
};
</code></pre>

<table>
<thead>
<tr>
<th><strong>Element</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>t_stackptr</td>
<td>Current stack pointer</td>
</tr>
<tr>
<td>t_stacktop</td>
<td>The address of the top of the task stack. The stack grows downward</td>
</tr>
<tr>
<td>t_stacksize</td>
<td>The size of the stack, in units of os_stack_t (not bytes!)</td>
</tr>
<tr>
<td>t_flags</td>
<td>Task flags (see flag definitions)</td>
</tr>
<tr>
<td>t_taskid</td>
<td>A numeric id assigned to each task</td>
</tr>
<tr>
<td>t_prio</td>
<td>The priority of the task. The lower the number, the higher the priority</td>
</tr>
<tr>
<td>t_state</td>
<td>The task state (see state definitions)</td>
</tr>
<tr>
<td>t_pad</td>
<td>padding (for alignment)</td>
</tr>
<tr>
<td>t_name</td>
<td>Name of task</td>
</tr>
<tr>
<td>t_func</td>
<td>Pointer to task function</td>
</tr>
<tr>
<td>t_obj</td>
<td>Generic object used by mutexes and semaphores when the task is waiting on a mutex or semaphore</td>
</tr>
<tr>
<td>t_sanity_check</td>
<td>Sanity task data structure</td>
</tr>
<tr>
<td>t_next_wakeup</td>
<td>OS time when task is next scheduled to wake up</td>
</tr>
<tr>
<td>t_run_time</td>
<td>The amount of os time ticks this task has been running</td>
</tr>
<tr>
<td>t_ctx_sw_cnt</td>
<td>The number of times that this task has been run</td>
</tr>
<tr>
<td>t_os_task_list</td>
<td>List pointer for global task list. All tasks are placed on this list</td>
</tr>
<tr>
<td>t_os_list</td>
<td>List pointer used by either the active task list or the sleeping task list</td>
</tr>
<tr>
<td>t_obj_list</td>
<td>List pointer for tasks waiting on a semaphore or mutex</td>
</tr>
</tbody>
</table>
<p><br></p>
<pre><code class="c">struct os_task_info {
    uint8_t oti_prio;
    uint8_t oti_taskid;
    uint8_t oti_state;
    uint8_t oti_flags;
    uint16_t oti_stkusage;
    uint16_t oti_stksize;
    uint32_t oti_cswcnt;
    uint32_t oti_runtime;
    os_time_t oti_last_checkin;
    os_time_t oti_next_checkin;

    char oti_name[OS_TASK_MAX_NAME_LEN];
};
</code></pre>

<table>
<thead>
<tr>
<th><strong>Element</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>oti_prio</td>
<td>Task priority</td>
</tr>
<tr>
<td>oti_taskid</td>
<td>Task id</td>
</tr>
<tr>
<td>oti_state</td>
<td>Task state</td>
</tr>
<tr>
<td>oti_flags</td>
<td>Task flags</td>
</tr>
<tr>
<td>oti_stkusage</td>
<td>Amount of stack used by the task (in os_stack_t units)</td>
</tr>
<tr>
<td>oti_stksize</td>
<td>The size of the stack (in os_stack_t units)</td>
</tr>
<tr>
<td>oti_cswcnt</td>
<td>The context switch count</td>
</tr>
<tr>
<td>oti_runtime</td>
<td>The amount of time that the task has run (in os time ticks)</td>
</tr>
<tr>
<td>oti_last_checkin</td>
<td>The time (os time) at which this task last checked in to the sanity task</td>
</tr>
<tr>
<td>oti_next_checkin</td>
<td>The time (os time) at which this task last checked in to the sanity task</td>
</tr>
<tr>
<td>oti_name</td>
<td>Name of the task</td>
</tr>
</tbody>
</table>
<p><br></p>
<h2 id="list-of-functions">List of Functions<a class="headerlink" href="#list-of-functions" title="Permanent link">&para;</a></h2>
<p>The functions available in task are:</p>
<ul>
<li><a href="../os_task_init/">os_task_init</a></li>
<li><a href="../os_task_count/">os_task_count</a></li>
<li><a href="../os_task_info_get_next/">os_task_info_get_next</a></li>
</ul>
                        
                        <div class="row">
                            <footer>
    <div class="row">
        <div class="col-md-12">
            
                <p class="copyright">Copyright &copy; 2015 The Apache Software Foundation, Licensed under the Apache License, Version 2.0 Apache and the Apache feather logo are trademarks of The Apache Software Foundation.<br>The Apache Software Foundation Apache Incubator</p>
            
        </div>
    </div>
    <div class="copyright-logos">
        <div class="row">
            <div class="col-xs-6 text-right">
                <img src="/img/apache-feather.png" alt="Apache" title="Apache">
            </div>
            <div class="col-xs-6 text-left">
                <img src="/img/apache-logo.png" alt="Apache Incubator" title="Apache Incubator">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
        </div>
    </div>
</footer>
                        </div>
                    </div>
                </div>
            
            
        </div>

        <script src="../../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../../js/highlight.pack.js"></script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../js/custom.js"></script>

    </body>
</html>