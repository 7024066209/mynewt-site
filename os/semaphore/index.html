<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://mynewt.incubator.apache.org/os/semaphore/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Semaphores - Mynewt Testing</title>

        <link href="../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../css/custom.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900,300,100' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'mynewt.incubator.apache.org');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Semaphores">


        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="logo-container">
        <img src="http://mynewt.incubator.apache.org/img/logo.svg">
    </div>
    <div class="container-fluid">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="http://mynewt.incubator.apache.org/">Home</a>
                </li>
                <li>
                    <a href="http://mynewt.incubator.apache.org/documentation/">Docs</a>
                </li>
                <li>
                    <a href="http://mynewt.incubator.apache.org/download/">Download</a>
                </li>
                <li>
                    <a href="http://mynewt.incubator.apache.org/community/">Community</a>
                </li>
                <li>
                    <a href="http://mynewt.incubator.apache.org/events/">Events</a>
                </li>
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
    </div>
</div>

        <div class="container-fluid">
            
                <div class="row sm-extra-padding">
                    <div class="col-md-3 bg-grey sidebar-container"><div class="bs-sidebar hidden-print" role="complementary">    
    <div class="sidebar-top">
        <img class="hidden-xs hidden-sm logo-small" src="http://mynewt.incubator.apache.org/img/logo.svg" alt="MyNewt" title="MyNewt">
        <div class="small" role="search">
            <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" placeholder="Search documentation" />
                    <button class="search-button" type="submit"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>
    <ul class="nav bs-sidenav">
        
            
        
            
        
            
        
            
        
            
        
            
                <li class="main"><a href="../../get_started/newt_concepts/">Chapter 1 - Get Started</a></li>
                
            
        
            
                <li class="main"><a href="../../get_acclimated/vocabulary/">Chapter 2 - Get Acclimated</a></li>
                
            
        
            
                <li class="main"><a href="../../newt/newt_ops/">Chapter 3 - Newt Tool</a></li>
                
            
        
            
                <li class="main"><a href="../mynewt_os/">Chapter 4 - Mynewt OS</a></li>
                
                    <ul class="current-toc">
                        
                            <li class="toctree-l2"><a href="../mynewt_os/">Overview</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../context_switch/">Scheduler/Context Switching</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../time/">Time</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../task/">Tasks</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../event_queue/">Event Queues</a></li>
                            
                        
                            <li class="toctree-l2"><a href="./">Semaphores</a></li>
                            
                                
                                    
                                        <li class="toctree-l3"><a href="#description">Description</a></li>
                                    
                                        <li class="toctree-l3"><a href="#data-structures">Data structures</a></li>
                                    
                                        <li class="toctree-l3"><a href="#list-of-functions">List of Functions</a></li>
                                    
                                        <li class="toctree-l3"><a href="#function-reference">Function Reference</a></li>
                                    
                                        <li class="toctree-l3"><a href="#os_sem_init"> os_sem_init</a></li>
                                    
                                        <li class="toctree-l3"><a href="#os_sem_release"> os_sem_release </a></li>
                                    
                                        <li class="toctree-l3"><a href="#os_sem_pend"> os_sem_pend </a></li>
                                    
                                        <li class="toctree-l3"><a href="#os_sem_delete"> os_sem_delete </a></li>
                                    
                                
                            
                        
                            <li class="toctree-l2"><a href="../mutex/">Mutexes</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../memory_pool/">Memory Pools</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../heap/">Heap</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../mbufs/">Mbufs</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../sanity/">Sanity</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../callout/">Callout Functions</a></li>
                            
                        
                            <li class="toctree-l2"><a href="../port_os/">Porting to other Platforms</a></li>
                            
                        
                    </ul>
                
            
        
            
                <li class="main"><a href="../../modules/console/">Chapter 5 - Modules</a></li>
                
            
        
            
                <li class="main"><a href="../../newtmgr/overview/">Chapter 6 - Newt Manager</a></li>
                
            
        
            
                <li class="main"><a href="../../packaging/dist/">Chapter 7 - Packaging it</a></li>
                
            
        
    </ul>
</div></div>
                    
                    <div class="show-sidebar-container">
                        <button class="show-sidebar">Docs Menu</button>
                    </div>
                    
                    <div class="col-md-9 documentation-viewer" role="main">
                        <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Chapter 4 - Mynewt OS &raquo;</li>
        
      
    
    <li>Semaphores</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
                        
                            <h1 id="semaphore">Semaphore<a class="headerlink" href="#semaphore" title="Permanent link">&para;</a></h1>
<p>A semaphore is a structure used for gaining exclusive access (much like a mutex), synchronizing task operations and/or use in a "producer/consumer" roles. Semaphores like the ones used by the myNewt OS are called "counting" semaphores as they are allowed to have more than one token (explained below).</p>
<h2 id="description">Description<a class="headerlink" href="#description" title="Permanent link">&para;</a></h2>
<p>A semaphore is a fairly simple construct consisting of a queue for waiting tasks and the number of tokens currently owned by the semaphore. A semaphore can be obtained as long as there are tokens in the semaphore. Any task can add tokens to the semaphore and any task can request the semaphore, thereby removing tokens. When creating the semaphore, the initial number of tokens can be set as well.</p>
<p>When used for exclusive access to a shared resource the semaphore only needs a single token. In this case, a single task "creates" the semaphore by calling <em>os_sem_init</em> with a value of one (1) for the token. When a task desires exclusive access to the shared resource it requests the semaphore by calling <em>os_sem_pend</em>. If there is a token the requesting task will acquire the semaphore and continue operation. If no tokens are available the task will be put to sleep until there is a token. A common "problem" with using a semaphore for exclusive access is called <em>priority inversion</em>. Consider the following scenario: a high and low priority task both share a resource which is locked using a semaphore. If the low priority task obtains the semaphore and then the high priority task requests the semaphore, the high priority task is now blocked until the low priority task releases the semaphore. Now suppose that there are tasks between the low priority task and the high priority task that want to run. These tasks will preempt the low priority task which owns the semaphore. Thus, the high priority task is blocked waiting for the low priority task to finish using the semaphore but the low priority task cannot run since other tasks are running. Thus, the high priority tasks is "inverted" in priority; in effect running at a much lower priority as normally it would preempt the other (lower priority) tasks. If this is an issue a mutex should be used instead of a semaphore.</p>
<p>Semaphores can also be used for task synchronization. A simple example of this would be the following. A task creates a semaphore and initializes it with no tokens. The task then waits on the semaphore, and since there are no tokens, the task is put to sleep. When other tasks want to wake up the sleeping task they simply add a token by calling <em>os_sem_release</em>. This will cause the sleeping task to wake up (instantly if no other higher priority tasks want to run).</p>
<p>The other common use of a counting semaphore is in what is commonly called a "producer/consumer" relationship. The producer adds tokens (by calling <em>os_sem_release</em>) and the consumer consumes them by calling <em>os_sem_pend</em>. In this relationship, the producer has work for the consumer to do. Each token added to the semaphore will cause the consumer to do whatever work is required. A simple example could be the following: every time a button is pressed there is some work to do (ring a bell). Each button press causes the producer to add a token. Each token consumed rings the bell. There will exactly the same number of bell rings as there are button presses. In other words, each call to <em>os_sem_pend</em> subtracts exactly one token and each call to <em>os_sem_release</em> adds exactly one token.</p>
<h2 id="data-structures">Data structures<a class="headerlink" href="#data-structures" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">struct os_sem
{
    SLIST_HEAD(, os_task) sem_head;     /* chain of waiting tasks */
    uint16_t    _pad;
    uint16_t    sem_tokens;             /* # of tokens */
};
</code></pre>

<table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>sem_head</td>
<td>Queue head for list of tasks waiting on semaphore</td>
</tr>
<tr>
<td>_pad</td>
<td>Padding for alignment</td>
</tr>
<tr>
<td>sem_tokens</td>
<td>Current number of tokens</td>
</tr>
</tbody>
</table>
<h2 id="list-of-functions">List of Functions<a class="headerlink" href="#list-of-functions" title="Permanent link">&para;</a></h2>
<p><List all the functions here. Note how the anchors work. You put the text you want to show up as a link within [] and the relevant #heading within (). Note that the words of the heading need to be connected with a dash for the anchor to work. Hence the word "function" and the function name is connected with a dash, not underscore! And the header has to have at least 2 words for the anchor to work - that's how it is.></p>
<p>The functions available in this OS feature are:</p>
<ul>
<li><a href="#os_sem_init">os_sem_init</a></li>
<li><a href="#os_sem_release">os_sem_release</a></li>
<li><a href="#os_sem_pend">os_sem_pend</a></li>
<li><a href="#os_sem_delete">os_sem_delete</a></li>
</ul>
<h2 id="function-reference">Function Reference<a class="headerlink" href="#function-reference" title="Permanent link">&para;</a></h2>
<hr />
<h2 id="os_sem_init"><font color="F2853F" style="font-size:24pt"> os_sem_init</font><a class="headerlink" href="#os_sem_init" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">os_error_t os_sem_init(struct os_sem *sem, uint16_t tokens)    
</code></pre>

<p>Initialize a semaphore with a given number of tokens. Should be called before the semaphore is used.</p>
<h4 id="arguments">Arguments<a class="headerlink" href="#arguments" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>*sem</td>
<td>Pointer to semaphore</td>
</tr>
<tr>
<td>tokens</td>
<td>Initial number of tokens allocated to semaphore</td>
</tr>
</tbody>
</table>
<h4 id="returned-values">Returned values<a class="headerlink" href="#returned-values" title="Permanent link">&para;</a></h4>
<p>OS_INVALID_PARM: returned when *sem is NULL on entry.</p>
<p>OS_OK: semaphore initialized successfully.</p>
<h4 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">&para;</a></h4>
<p><Any special feature/special benefit that we want to tout. 
Does it need to be used with some other specific functions?
Any caveats to be careful about (e.g. high memory requirements).></p>
<h4 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h4>
<p>The following example shows how to initialize a semaphore used for exclusive access.</p>
<pre><code class="no-highlight">struct os_mutex g_os_sem;
os_error_t err;

err = os_sem_init(&amp;g_os_sem, 1);
assert(err == OS_OK);
</code></pre>

<hr />
<h2 id="os_sem_release"><font color="#F2853F" style="font-size:24pt"> os_sem_release </font><a class="headerlink" href="#os_sem_release" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">os_error_t os_sem_release(struct os_sem *sem)
</code></pre>

<p>Release a semaphore that you are holding. This adds a token to the semaphore.</p>
<h4 id="arguments_1">Arguments<a class="headerlink" href="#arguments_1" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>*sem</td>
<td>Pointer to semaphore</td>
</tr>
</tbody>
</table>
<h4 id="returned-values_1">Returned values<a class="headerlink" href="#returned-values_1" title="Permanent link">&para;</a></h4>
<p>OS_NOT_STARTED: Called before os has been started.</p>
<p>OS_INVALID_PARM: returned when *sem is NULL on entry.</p>
<p>OS_OK: semaphore released successfully.</p>
<h4 id="notes_1">Notes<a class="headerlink" href="#notes_1" title="Permanent link">&para;</a></h4>
<h4 id="example_1">Example<a class="headerlink" href="#example_1" title="Permanent link">&para;</a></h4>
<pre><code class="no-highlight">struct os_sem g_os_sem;
os_error_t err;

err = os_sem_pend(&amp;g_os_sem, OS_TIMEOUT_NEVER);
assert(err == OS_OK);

/* Perform operations requiring semaphore lock */

err = os_sem_release(&amp;g_os_sem);
assert(err == OS_OK);
</code></pre>

<hr />
<h2 id="os_sem_pend"><font color="#F2853F" style="font-size:24pt"> os_sem_pend </font><a class="headerlink" href="#os_sem_pend" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">os_error_t os_sem_pend(struct os_sem *sem, uint32_t timeout)
</code></pre>

<p>Wait for a semaphore for a given amount of time.</p>
<h4 id="arguments_2">Arguments<a class="headerlink" href="#arguments_2" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>*sem</td>
<td>Pointer to semaphore</td>
</tr>
<tr>
<td>timeout</td>
<td>Amount of time, in os ticks, to wait for semaphore. A value of 0 means no wait. A value of 0xFFFFFFFF means wait forever.</td>
</tr>
</tbody>
</table>
<h4 id="returned-values_2">Returned values<a class="headerlink" href="#returned-values_2" title="Permanent link">&para;</a></h4>
<p>OS_INVALID_PARM: returned when *sem is NULL on entry.</p>
<p>OS_OK: semaphore acquired successfully.</p>
<p>OS_TIMEOUT: the semaphore was not available within the timeout specified.</p>
<p>OS_NOT_STARTED: Attempt to release a semaphore before os started.</p>
<h4 id="notes_2">Notes<a class="headerlink" href="#notes_2" title="Permanent link">&para;</a></h4>
<p>If a timeout of 0 is used and the function returns OS_TIMEOUT, the semaphore was not available and was not acquired. No release of the semaphore should occur and the calling task does not own the semaphore.</p>
<h4 id="example_2">Example<a class="headerlink" href="#example_2" title="Permanent link">&para;</a></h4>
<pre><code class="no-highlight">struct os_sem g_os_sem;
os_error_t err;

err = os_sem_pend(&amp;g_os_sem, OS_TIMEOUT_NEVER);
assert(err == OS_OK);

/* Perform operations requiring semaphore lock */

err = os_sem_release(&amp;g_os_sem);
assert(err == OS_OK);

</code></pre>

<hr />
<h2 id="os_sem_delete"><font color="#F2853F" style="font-size:24pt"> os_sem_delete </font><a class="headerlink" href="#os_sem_delete" title="Permanent link">&para;</a></h2>
<pre><code class="no-highlight">os_error_t os_sem_delete(struct os_sem *sem)
</code></pre>

<p>Delete a semaphore</p>
<h4 id="arguments_3">Arguments<a class="headerlink" href="#arguments_3" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>*sem</td>
<td>Pointer to semaphore</td>
</tr>
</tbody>
</table>
<h4 id="returned-values_3">Returned values<a class="headerlink" href="#returned-values_3" title="Permanent link">&para;</a></h4>
<p>OS_INVALID_PARM: returned when *sem is NULL on entry.</p>
<p>OS_OK: semaphore deleted successfully.</p>
<p>OS_NOT_STARTED: Attempt to release a semaphore before os started.</p>
<h4 id="notes_3">Notes<a class="headerlink" href="#notes_3" title="Permanent link">&para;</a></h4>
<p>Care must be taken when deleting a semaphore as deleting a semaphore used by other tasks could causes unexpected/unwanted behavior.</p>
<h4 id="example_3">Example<a class="headerlink" href="#example_3" title="Permanent link">&para;</a></h4>
<pre><code class="no-highlight">struct os_sem g_os_sem;
os_error_t err;

err = os_sem_delete(&amp;g_os_sem);
assert(err == OS_OK);
</code></pre>

<hr />
                        
                    </div>
                </div>
            
            <div class="row">    
                <footer>
    <div class="row">
        <div class="col-md-12">
            
                <p class="copyright">Copyright &copy; 2015 The Apache Software Foundation, Licensed under the Apache License, Version 2.0 Apache and the Apache feather logo are trademarks of The Apache Software Foundation.<br>The Apache Software Foundation Apache Incubator</p>
            
        </div>
    </div>
    <div class="copyright-logos">
        <div class="row">
            <div class="col-xs-6 text-right">
                <img src="http://mynewt.incubator.apache.org/img/apache-feather.png" alt="Apache" title="Apache">
            </div>
            <div class="col-xs-6 text-left">
                <img src="http://mynewt.incubator.apache.org/img/apache-logo.png" alt="Apache Incubator" title="Apache Incubator">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
        </div>
    </div>
</footer>
            </div>
        </div>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../js/custom.js"></script>

    </body>
</html>