<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://mynewt.incubator.apache.org/os/get_started/project1/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">

	<title>Blinky, The First Project - Apache Mynewt</title>

        <link href="../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <link href="../../../css/base.css" rel="stylesheet">
        <link href="../../../css/custom.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900,300,100' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'mynewt.incubator.apache.org');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Blinky, The First Project">


        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="logo-container">
        <img src="/img/logo.svg">
    </div>
    <div class="container-fluid">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/documentation/">Docs</a>
                </li>
                <li>
                    <a href="/download/">Download</a>
                </li>
                <li>
                    <a href="/community/">Community</a>
                </li>
                <li>
                    <a href="/events/">Events</a>
                </li>
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
    </div>
</div>

        <div class="container-fluid">
            
                <div class="row sm-extra-padding">
                    <div class="col-md-3 bg-grey sidebar-container"><div class="bs-sidebar hidden-print" role="complementary">
    <div class="sidebar-top">
        <img class="hidden-xs hidden-sm logo-small" src="/img/logo.svg" alt="MyNewt" title="MyNewt">
        <div class="small" role="search">
            <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" placeholder="Search documentation" />
                    <button class="search-button" type="submit"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>
    <ul class="nav bs-sidenav">
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  <li><a href="
  ../introduction/
">Apache Mynewt Manual</a>
    
      <ul class="current-toc">
          
              
  
    <li>
      <a href="../introduction/">Introduction</a>
    </li>
  

          
              
  
  <li><a href="
  ./
">Get Started</a>
    
      <ul class="current-toc">
          
              
  
    <li class="active">
      Blinky, The First Project
    </li>
  

          
              
  
    <li>
      <a href="../vocabulary/">Understanding Newt Terms</a>
    </li>
  

          
      </ul>
    
  </li>

          
              
  
  <li><a href="
  ../../get_acclimated/project2/
">Tutorials</a>
    
  </li>

          
              
  
  <li><a href="
  
  
  
  
  ../../core_os/mynewt_os/


">Manual</a>
    
  </li>

          
      </ul>
    
  </li>

        
      
        
          
  
  <li><a href="
  
  
  ../../../newt/newt_ops/

">Newt Tool Manual</a>
    
  </li>

        
      
        
          
  
  <li><a href="
  ../../../newtmgr/overview/
">Newt Manager Manual</a>
    
  </li>

        
      
    </ul>
</div></div>
                    
                    <div class="show-sidebar-container">
                        <button class="show-sidebar">Docs Menu</button>
                    </div>
                    
                    <div class="col-md-9 documentation-viewer" role="main">
                        <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Apache Mynewt Manual &raquo;</li>
        
      
        
          <li>Get Started &raquo;</li>
        
      
    
    <li>Blinky, The First Project</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
                        
                            <h2 id="blinky-the-first-project">Blinky, the First Project<a class="headerlink" href="#blinky-the-first-project" title="Permanent link">&para;</a></h2>
<h3 id="objective">Objective<a class="headerlink" href="#objective" title="Permanent link">&para;</a></h3>
<p>To use available packages from the default application repository for Mynewt to make an LED on a target board blink. We call it <em>Project Blinky</em>. The goals of this tutorial are threefold:</p>
<ol>
<li>Set up the environment on your computer to use Mynewt OS and newt tool. </li>
<li>Download packages for building and testing the project <a href="#building-test-code-on-simulator">on a simulated target</a>.</li>
<li>Download packages and use tools to create a runtime image for a board to make its LED blink. You have two choices here:<ul>
<li><a href="#using-sram-to-make-led-blink">Download an image to SRAM</a>, or </li>
<li><a href="#using-flash-to-make-led-blink">Download it to flash</a>.</li>
</ul>
</li>
</ol>
<p><strong> Time Requirement</strong>: Allow yourself a couple of hours for this project if you are relatively new to embedded systems and playing with development boards. Those jumpers can be pesky!</p>
<h3 id="what-you-need">What you need<a class="headerlink" href="#what-you-need" title="Permanent link">&para;</a></h3>
<ol>
<li>STM32-E407 development board from Olimex. You can order it from <a href="http://www.mouser.com/ProductDetail/Olimex-Ltd/STM32-E407/?qs=UN6GZl1KCcit6Ye0xmPO4A%3D%3D">http://www.mouser.com</a>, <a href="http://www.digikey.com/product-detail/en/STM32-E407/1188-1093-ND/3726951">http://www.digikey.com</a>, and other places.</li>
<li>ARM-USB-TINY-H connector with JTAG interface for debugging ARM microcontrollers (comes with the ribbon cable to hook up to the board)</li>
<li>USB A-B type cable to connect the debugger to your personal computer</li>
<li>Personal Computer</li>
</ol>
<p>The instructions assume the user is using a Bourne-compatible shell (e.g. bash or zsh) on your computer. The given instructions have been tested with the following releases of operating systems:</p>
<ul>
<li>Mac: OS X Yosemite Version 10.10.5</li>
<li>Linux: Ubuntu 14.10 (Utopic Unicorn)</li>
</ul>
<h3 id="access-to-the-apache-repo">Access to the Apache repo<a class="headerlink" href="#access-to-the-apache-repo" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Get an account on Apache. You do not need a committer account to view the website or clone the repository. You only need a committer account to push changes to it.</p>
</li>
<li>
<p>The latest codebase for the Mynewt OS is on the master branch at https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva.git</p>
</li>
<li>
<p>The latest codebase for the Newt tool is on the master branch at https://git-wip-us.apache.org/repos/asf/incubator-mynewt-newt.git . You do not need to download source code and build the newt tool for this project. You will simply use the available executable instead.</p>
</li>
</ul>
<p>The following shows how to clone a Mynewt OS code repository:</p>
<ul>
<li>Non Committers</li>
</ul>
<pre><code class="no-highlight">        $ git clone http://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva.git
</code></pre>

<ul>
<li>Committers</li>
</ul>
<pre><code class="no-highlight">        $ git clone https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva.git
</code></pre>

<h3 id="setting-up-toolchain-if-you-have-a-mac">Setting up toolchain if you have a Mac<a class="headerlink" href="#setting-up-toolchain-if-you-have-a-mac" title="Permanent link">&para;</a></h3>
<ul>
<li>You have to install gcc/libc that can produce 32-bit executables. Use homebrew to install gcc.</li>
</ul>
<pre><code class="no-highlight">        $ brew install gcc
        ...
        ...
        ==&gt; Summary
        🍺  /usr/local/Cellar/gcc/5.2.0: 1353 files, 248M
</code></pre>

<ul>
<li>ARM maintains a pre-built GNU toolchain with a GCC source branch targeted at Embedded ARM Processors namely Cortex-R/Cortex-M processor families. Install the PX4 Toolchain and check the version installed. Make sure that the symbolic link installed by Homebrew points to the correct version of the debugger. If not, you can either change the symbolic link using the "ln -f -s" command or just go ahead and try with the version it points to!</li>
</ul>
<pre><code class="no-highlight">        $ brew tap PX4/homebrew-px4
        $ brew update
        $ brew install gcc-arm-none-eabi-49
        $ arm-none-eabi-gcc --version  
        arm-none-eabi-gcc (GNU Tools for ARM Embedded Processors) 4.9.3 20150529 (release) [ARM/embedded-4_9-branch revision 224288]
        Copyright (C) 2014 Free Software Foundation, Inc.
        This is free software; see the source for copying conditions.  There is NO
        warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
        $ ls -al /usr/local/bin/arm-none-eabi-gdb
        lrwxr-xr-x  1 aditihilbert  admin  69 Sep 22 17:16 /usr/local/bin/arm-none-eabi-gdb -&gt; /usr/local/Cellar/gcc-arm-none-eabi-49/20150609/bin/arm-none-eabi-gdb
</code></pre>

<p>Note: If no version is specified, brew will install the latest version available. MynewtOS will eventually work with multiple versions available including the latest releases. However, at present we have tested only with this version and recommend it for getting started. </p>
<ul>
<li>You have to install OpenOCD (Open On-Chip Debugger) which is an open-source software that will allow you to interface with the JTAG debug connector/adaptor for the Olimex board. It lets you program, debug, and test embedded target devices which, in this case, is the Olimex board. Use brew to install it. Brew adds a simlink /usr/local/bin/openocd to the openocd directory in the Cellar. For more on OpenOCD go to <a href="http://openocd.org">http://openocd.org</a>.</li>
</ul>
<pre><code class="no-highlight">        $ brew install open-ocd
        $ which openocd
        /usr/local/bin/openocd
        $ ls -l $(which openocd)
        lrwxr-xr-x  1 &lt;user&gt;  admin  36 Sep 17 16:22 /usr/local/bin/openocd -&gt; ../Cellar/open-ocd/0.9.0/bin/openocd
</code></pre>

<ul>
<li>Proceed to the <a href="#building-test-code-on-simulator">Building test code on simulator</a> section.</li>
</ul>
<h3 id="setting-up-toolchain-if-you-have-linux">Setting up toolchain if you have Linux<a class="headerlink" href="#setting-up-toolchain-if-you-have-linux" title="Permanent link">&para;</a></h3>
<ul>
<li>You have to install gcc / libc that can produce 32-bit executables. You can install these as follows: </li>
</ul>
<pre><code class="no-highlight">        $ sudo apt-get install gcc-multilib libc6-i386
</code></pre>

<ul>
<li>For the LED project on the Olimex hardware, you have to install gcc for AM 4.9.3.  This package can be installed with apt-get as documented below. The steps are explained in depth at <a href="https://launchpad.net/~terry.guo/+archive/ubuntu/gcc-arm-embedded">https://launchpad.net/~terry.guo/+archive/ubuntu/gcc-arm-embedded</a>.</li>
</ul>
<pre><code class="no-highlight">        $ sudo apt-get remove binutils-arm-none-eabi gcc-arm-none-eabi 
        $ sudo add-apt-repository ppa:terry.guo/gcc-arm-embedded 
        $ sudo apt-get update 
        $ sudo apt-get install gcc-arm-none-eabi
</code></pre>

<ul>
<li>
<p>And finally, you have to install OpenOCD (Open On-Chip Debugger) which is an open-source software that will allow you to interface with the JTAG debug connector/adaptor for the Olimex board. It lets you program, debug, and test embedded target devices which, in this case, is the Olimex board. You have to acquire OpenOCD 0.8.0. </p>
<p>If you are running Ubuntu 15.x, then you are in luck and you can simply run: </p>
</li>
</ul>
<pre><code class="no-highlight">        $ sudo apt-get install openocd 
</code></pre>

<p>Other versions of Ubuntu may not have the correct version of openocd available.  In this case, you should download the openocd 0.8.0 package from <a href="https://launchpad.net/ubuntu/vivid/+source/openocd">https://launchpad.net/ubuntu/vivid/+source/openocd</a>. The direct link to the amd64 build is <a href="http://launchpadlibrarian.net/188260097/openocd_0.8.0-4_amd64.deb">http://launchpadlibrarian.net/188260097/openocd_0.8.0-4_amd64.deb</a>. </p>
<ul>
<li>Proceed to the <a href="#building-test-code-on-simulator">Building test code on simulator</a> section.</li>
</ul>
<h3 id="download-newt-tool">Download newt tool<a class="headerlink" href="#download-newt-tool" title="Permanent link">&para;</a></h3>
<p>Insert the loaction of the newt tool executable.</p>
<h3 id="try-building-test-code-on-simulator">Try building test code on simulator<a class="headerlink" href="#try-building-test-code-on-simulator" title="Permanent link">&para;</a></h3>
<ol>
<li>Clone the larva repository from the Apache git repository into a local directory named <code>larva</code>.</li>
</ol>
<pre><code class="no-highlight">        $ cd ~/dev 
        $ git clone https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva.git larva
        $ ls
        go  larva
        $ ls larva
        DISCLAIMER  NOTICE      app.yml     compiler    hw      net     project     sys
        LICENSE     README.md   autotargets fs  libs    pkg-list.yml    scripts
</code></pre>

<p>2.  Create a target using the newt tool. </p>
<pre><code class="no-highlight">        $ cd larva
        $ newt target create sim_test
        Creating target sim_test
        Target sim_test sucessfully created!
        $ newt target show
        sim_test
            name: sim_test
            arch: sim
</code></pre>

<p>3. Now continue to populate and build out the sim project.</p>
<pre><code class="no-highlight">        $ newt target set sim_test project=test
        Target sim_test successfully set project to test
        $ newt target set sim_test compiler_def=debug
        Target sim_test successfully set compiler_def to debug
        $ newt target set sim_test bsp=hw/bsp/native
        Target sim_test successfully set bsp to hw/bsp/native
        $ newt target set sim_test compiler=sim
        Target sim_test successfully set compiler to sim
        $ newt target show sim_test
        sim_test
            arch=sim
            bsp=hw/bsp/native
            compiler=sim
            compiler_def=debug
            name=sim_test
            project=test
</code></pre>

<p>4. Configure newt to use the gnu build tools native to OS X or linux. In order for sim to work properly, it needs to be using 32-bit gcc (gcc-5). Replace 
~/dev/larva/compiler/sim/compiler.yml with the compiler/sim/osx-compiler.yml or linux-compiler.yml file, depending on the system. On a Windows machine follow the instruction for the Linux machine as you are running commands in a Linux VM.</p>
<p>For a Mac OS X environment:</p>
<pre><code class="no-highlight">        $ cp compiler/sim/osx-compiler.yml compiler/sim/compiler.yml 
</code></pre>

<p>For a Linux machine:</p>
<pre><code class="no-highlight">        $ cp compiler/sim/linux-compiler.yml compiler/sim/compiler.yml
</code></pre>

<p>5. Next, build the packages for the sim project using the newt tool. You can specify the VERBOSE option if you want to see the gory details. </p>
<pre><code class="no-highlight">        $ newt target build sim_test
        Building target sim_test (project = test)
        ...
        ...
        Successfully run!
</code></pre>

<p>You can specify the VERBOSE option if you want to see the gory details.</p>
<pre><code class="no-highlight">        $newt -l VERBOSE target build sim_test
        2015/09/29 09:46:12 [INFO] Building project test
        2015/09/29 09:46:12 [INFO] Loading Package /Users/aditihilbert/dev/larva/libs//bootutil...
        2015/09/29 09:46:12 [INFO] Loading Package /Users/aditihilbert/dev/larva/libs//cmsis-core...
        2015/09/29 09:46:12 [INFO] Loading Package /Users/aditihilbert/dev/larva/libs//ffs..
        ...
        Successfully run!
</code></pre>

<p>6. Try running the test suite executable inside this project and enjoy your first successful test!</p>
<pre><code class="no-highlight">        $ project/test/bin/sim_test/test.elf
        [pass] os_mempool_test_suite/os_mempool_test_case
        [pass] os_mutex_test_suite/os_mutex_test_basic
        [pass] os_mutex_test_suite/os_mutex_test_case_1
        ...
        ...
        [pass] cbmem_test_suite/cbmem_test_case_3
</code></pre>

<h3 id="using-sram-to-make-led-blink">Using SRAM to make LED blink<a class="headerlink" href="#using-sram-to-make-led-blink" title="Permanent link">&para;</a></h3>
<p>You are here because you want to build an image to be run from internal SRAM on the Olimex board.</p>
<h4 id="preparing-the-software">Preparing the Software<a class="headerlink" href="#preparing-the-software" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Make sure the PATH environment variable includes the $HOME/dev/go/bin directory. </p>
</li>
<li>
<p>If you have cloned the larva repository for the simulator test in the previous section you can skip this step. Otherwise, you have to create a repository for the project. Go to ~/dev and clone the larva repository from the apache git repository into a local directory named <code>larva</code>.</p>
</li>
</ul>
<pre><code class="no-highlight">        $ cd ~/dev 
        $ git clone https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva.git larva
        $ ls
        go  larva
        $ ls larva
        DISCLAIMER  NOTICE      app.yml     compiler    hw      net     project     sys
        LICENSE     README.md   autotargets fs  libs    pkg-list.yml    scripts
</code></pre>

<ul>
<li>
<p>You now have to go to the ~dev/larva directory and build out a second project inside larva (the first one being the sim project). The project name is "blinky", in keeping with the objective. Starting with the target name, you have to specify the different aspects of the project to pull the appropriate packages and build the right bundle or list for the board. In this case that means setting the architecture (arch), compiler, board support package (bsp), project, and compiler mode.</p>
<p>Remember to prefix each command with "newtvm" if you are executing the newt command in a Linux virtual machine on your Windows box!</p>
</li>
</ul>
<pre><code class="no-highlight">        $ newt target create blinky
        Creating target blinky
        Target blinky sucessfully created!
        $ newt target set blinky arch=cortex_m4
        Target blinky successfully set arch to arm
        $ newt target set blinky compiler=arm-none-eabi-m4
        Target blinky successfully set compiler to arm-none-eabi-m4
        $ newt target set blinky project=blinky
        Target blinky successfully set project to blinky
        $ newt target set blinky compiler_def=debug
        Target blinky successfully set compiler_def to debug
        $ newt target set blinky bsp=hw/bsp/olimex_stm32-e407_devboard
        Target blinky successfully set bsp to hw/bsp/olimex_stm32-e407_devboard
        $ newt target show blinky
        blinky
            arch=cortex_m4
            bsp=hw/bsp/olimex_stm32-e407_devboard
            compiler=arm-none-eabi-m4
            compiler_def=debug
            name=blinky
            project=blinky
</code></pre>

<ul>
<li>
<p>Now you have to build the image. The linker script within the <code>hw/bsp/olimex_stm32-e407_devboard</code> package builds an image for flash memory by default. Since you want an image for the SRAM, you need to switch that script with <code>run_from_sram.ld</code> in order to get the package to produce an image for SRAM. <font color="red"> We are working on making it easier to specify where the executable will be run from for a particular project and automatically choose the correct linker scripts and generate the appropriate image. It will be specified as a project identity e.g. bootloader, RAM, flash (default) and the target will build accordingly. </font>. </p>
<p>Once the target is built, you can find the executable "blinky.elf" in the project directory at ~/dev/larva/project/blinky/bin/blinky. It's a good idea to take a little time to understand the directory structure.</p>
</li>
</ul>
<pre><code class="no-highlight">        $ cd ~/dev/larva/hw/bsp/olimex_stm32-e407_devboard
        $ diff olimex_stm32-e407_devboard.ld run_from_sram.ld
        (some diff will be displayed)
        $ cp run_from_sram.ld olimex_stm32-e407_devboard.ld
        $ cd ~/dev/larva/project/blinky/
        $ newt target build blinky
        Building target blinky (project = blinky)
        Compiling case.c
        Compiling suite.c
        ...
        Successfully run!
        $ ls bin/blinky
        blinky.elf  blinky.elf.bin  blinky.elf.cmd  blinky.elf.lst  blinky.elf.map
</code></pre>

<ul>
<li>
<p>Check that you have all the scripts needed to get OpenOCD up and talking with the project's specific hardware. Depending on your system (Ubuntu, Windows) you may already have the scripts in your <code>/usr/share/openocd/scripts/</code> directory as they may have been part of the openocd download. If yes, you are all set and can proceed to preparing the hardware.</p>
<p>Otherwise check the <code>~/dev/larva/hw/bsp/olimex_stm32-e407_devboard</code> directory for a file named <code>f407.cfg</code>. That is the config we will use to talk to this specific hardware using OpenOCD. You are all set if you see it.</p>
</li>
</ul>
<pre><code class="no-highlight">        $ ls ~/dev/larva/hw/bsp/olimex_stm32-e407_devboard
        bin     include     olimex_stm32-e407_devboard_download.sh  run_from_loader.ld
        boot-olimex_stm32-e407_devboard.ld  olimex_stm32-e407_devboard.ld   pkg.yml     run_from_sram.ld
        f407.cfg        olimex_stm32-e407_devboard_debug.sh run_from_flash.ld           src
</code></pre>

<h4 id="preparing-the-hardware-to-boot-from-embedded-sram">Preparing the hardware to boot from embedded SRAM<a class="headerlink" href="#preparing-the-hardware-to-boot-from-embedded-sram" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Locate the boot jumpers on the board.
<img alt="Alt Layout - Top View" src="../pics/topview.png" />
<img alt="Alt Layout - Bottom View" src="../pics/bottomview.png" /></p>
</li>
<li>
<p>B1_1/B1_0 and B0_1/B0_0 are PTH jumpers which can be moved relatively easy. Note that the markings on the board may not always be accurate. Always refer to the manual for the correct positioning of jumpers in case of doubt. The two jumpers must always be moved together – they are responsible for the boot mode if bootloader is present. The board can search for bootloader on three places – User Flash Memory, System Memory or the Embedded SRAM. We will configure it to boot from SRAM by jumpering B0_1 and B1_1.</p>
</li>
<li>
<p>Connect USB-OTG#2 in the picture above to a USB port on your computer (or a powered USB hub to make sure there is enough power available to the board). </p>
</li>
<li>
<p>The red PWR LED should be lit. </p>
</li>
<li>
<p>Connect the JTAG connector to the SWD/JTAG interface on the board. The other end of the cable should be connected to the USB port or hub of your computer.</p>
</li>
</ul>
<h4 id="lets-go">Let's Go!<a class="headerlink" href="#lets-go" title="Permanent link">&para;</a></h4>
<ul>
<li>Make sure you are in the blinky project directory with the blinky.elf executable. Run the debug command in the newt tool. You should see some status messages are shown below. There is an inbuilt <code>-c "reset halt"</code> flag that tells it to halt after opening the session.</li>
</ul>
<pre><code class="no-highlight">        $ cd ~/dev/larva/project/blinky/bin/blinky
        $ newt target debug blinky
        Debugging with /Users/aditihilbert/dev/larva/hw/bsp/olimex_stm32-e407_devboard/olimex_stm32-e407_devboard_debug.sh blinky
        Debugging /Users/aditihilbert/dev/larva/project/blinky/bin/blinky/blinky.elf
        GNU gdb (GNU Tools for ARM Embedded Processors) 7.8.0.20150604-cvs
        Copyright (C) 2014 Free Software Foundation, Inc.
        License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
        ...
        (info)
        ...
        target state: halted
        target halted due to debug-request, current mode: Thread 
        xPSR: 0x01000000 pc: 0x20000250 msp: 0x10010000
        Info : accepting 'gdb' connection from 3333
        Info : device id = 0x10036413
        Info : flash size = 1024kbytes
        Reset_Handler () at startup_STM32F40x.s:199
        199     ldr    r1, =__etext
</code></pre>

<p>Check the value of the msp (main service pointer) register. If it is not 0x10010000 as indicated above, you will have to manually set it after you open the gdp tool and load the image on it. </p>
<pre><code class="no-highlight">        (gdb) set $msp=0x10010000
</code></pre>

<p>Now load the image and type "c" or "continue" from the GNU debugger. </p>
<pre><code class="no-highlight">        (gdb) load ~/dev/larva/project/blinky/bin/blinky/blinky.elf         
        Loading section .text, size 0x4294 lma 0x20000000
        Loading section .ARM.extab, size 0x24 lma 0x20004294
        Loading section .ARM.exidx, size 0xd8 lma 0x200042b8
        Loading section .data, size 0x874 lma 0x20004390
        Start address 0x20000250, load size 19460
        Transfer rate: 81 KB/sec, 2432 bytes/write.
        (gdb) c
        Continuing.
</code></pre>

<ul>
<li>Voilà! The board's LED should be blinking at 1 Hz.</li>
</ul>
<h3 id="using-flash-to-make-led-blink">Using flash to make LED blink<a class="headerlink" href="#using-flash-to-make-led-blink" title="Permanent link">&para;</a></h3>
<p>You are here because you want to build an image to be run from flash memory on the Olimex board.</p>
<ul>
<li>Configure the board to boot from flash by moving the two jumpers together to B0_0 and B1_0. Refer to the pictures of the board under the section titled <a href="#preparing-the-hardware-to-boot-from-embedded-sram">"Preparing the hardware to boot from embedded SRAM"</a>.</li>
</ul>
<p>You will have to reset the board once the image is uploaded to it.</p>
<ul>
<li>If you skipped the first option for the project <a href="#using-sram-to-make-led-blink">(downloading an image to SRAM)</a>, then skip this step. Otherwise, continue with this step. </li>
</ul>
<p>By default, the linker script (<code>olimex_stm32-e407_devboard.ld</code>) is configured to run from bootloader and flash. However, if you first ran the image from SRAM you had changed <code>olimex_stm32-e407_devboard.ld</code> to match <code>run_from_sram.ld</code>. You will therefore return to defaults with <code>olimex_stm32-e407_devboard.ld</code> linker script matching the contents of 'run_from_loader.ld'. Return to the project directory.</p>
<pre><code class="no-highlight">        $ cd ~/dev/larva/hw/bsp/olimex_stm32-e407_devboard
        $ diff olimex_stm32-e407_devboard.ld run_from_sram.ld
        $ diff olimex_stm32-e407_devboard.ld run_from_loader.ld
        (some diff will be displayed)
        $ cp run_from_loader.ld olimex_stm32-e407_devboard.ld
        $ cd ~/dev/larva/project/blinky/bin/blinky
</code></pre>

<ul>
<li>In order to run the image from flash, you need to build the bootloader as well. The bootloader does the initial bring up of the Olimex board and then transfers control to the image stored at a location in flash known to it. The bootloader in turn requires the bin2image tool to check the image header for version information, CRC checks etc. So, we will need to build these two additional targets (bootloader and bin2img).</li>
</ul>
<p>Let's first create bin2img:</p>
<pre><code class="no-highlight">        $ newt target create bin2img
        Creating target bin2img
        Target bin2img successfully created!
        $ newt target set bin2img arch=sim
        Target bin2img successfully set arch to sim
        $ newt target set bin2img compiler=sim
        Target bin2img successfully set compiler to sim
        $ newt target set bin2img project=bin2img
        Target bin2img successfully set project to bin2img
        $ newt target set bin2img compiler_def=debug
        Target bin2img successfully set compiler_def to debug
        $ newt target set bin2img bsp=hw/bsp/native
        Target bin2img successfully set bsp to hw/bsp/native
        $ newt target show bin2img
        bin2img
                arch=sim
                bsp=hw/bsp/native
                compiler=sim
                compiler_def=debug
                name=bin2img
                project=bin2img
</code></pre>

<p>And then let's create boot_olimex:</p>
<pre><code class="no-highlight">        $ newt target create boot_olimex
        Creating target boot_olimex
        Target boot_olimex successfully created!
        $ newt target set boot_olimex arch=cortex_m4
        Target boot_olimex successfully set arch to cortex_m4
        $ newt target set boot_olimex compiler=arm-none-eabi-m4
        Target boot_olimex successfully set compiler to arm-none-eabi-m4
        $ newt target set boot_olimex project=boot
        Target boot_olimex successfully set project to boot
        $ newt target set boot_olimex compiler_def=optimized
        Target boot_olimex successfully set compiler_def to optimized
        $ newt target set boot_olimex bsp=hw/bsp/olimex_stm32-e407_devboard
        Target boot_olimex successfully set bsp to hw/bsp/olimex_stm32-e407_devboard
        $ newt target show boot_olimex
        boot_olimex
                arch=cortex_m4
                bsp=hw/bsp/olimex_stm32-e407_devboard
                compiler=arm-none-eabi-m4
                compiler_def=optimized
                name=boot_olimex
                project=boot
</code></pre>

<ul>
<li>Let's build all the three targets now.</li>
</ul>
<pre><code class="no-highlight">        $ newt target build bin2img
        Building target bin2img (project = bin2img)
        Building project bin2img
        ...
        Successfully run!
        $ newt target build boot_olimex
        Building target boot_olimex (project = boot)
        Building project boot
        ...
        Successfully run!
        $ newt target build blinky
        Building target blinky (project = blinky)
        Building project blinky
        Successfully run!
</code></pre>

<ul>
<li>Go to the project directory and download the bootloader and the image to flash ... in a flash! </li>
</ul>
<pre><code class="no-highlight">        $ cd ~/dev/larva/project/blinky/bin/blinky
        $ newt target download boot_olimex
        Downloading with ~/dev/larva/hw/bsp/olimex_stm32-e407_devboard/olimex_stm32-e407_devboard_download.sh
        $ newt target download blinky
        Downloading with ~/dev/larva/hw/bsp/olimex_stm32-e407_devboard/olimex_stm32-e407_devboard_download.sh
</code></pre>

<ul>
<li>
<p>The LED should be blinking!</p>
</li>
<li>
<p>But wait...let's double check that it is indeed booting from flash and making the LED blink from the image in flash. Pull the USB cable off the Olimex JTAG adaptor. The debug connection to the JTAG port is now severed. Next power off the Olimex board by pulling out the USB cable from the board. Wait for a couple of seconds and plug the USB cable back to the board. </p>
</li>
</ul>
<p>The LED light will start blinking again. Success!</p>
<p>Note #1: If you want to download the image to flash and a gdb session opened up, use <code>newt target debug blinky</code> instead of <code>newt target download blinky</code>.</p>
<pre><code class="no-highlight">        $ newt target debug blinky
        Debugging with ~/dev/larva/hw/bsp/olimex_stm32-e407_devboard/olimex_stm32-e407_devboard_debug.sh blinky
        Debugging ~/dev/larva/project/blinky/bin/blinky/blinky.elf
        GNU gdb (GNU Tools for ARM Embedded Processors) 7.8.0.20150604-cvs
        Copyright (C) 2014 Free Software Foundation, Inc.
        License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
        ...
        (info)
        ...
        target state: halted
        target halted due to debug-request, current mode: Thread 
        xPSR: 0x01000000 pc: 0x08000250 msp: 0x10010000
        Info : accepting 'gdb' connection from 3333
        Info : device id = 0x10036413
        Info : flash size = 1024kbytes
        Reset_Handler () at startup_STM32F40x.s:199
        199     ldr    r1, =__etext
        (gdb)
</code></pre>

<p>Note #2: If you want to erase the flash and load the image again you may use the following commands from within gdb. <code>flash erase_sector 0 0 x</code> tells it to erase sectors 0 through x. When you ask it to display (in hex notation) the contents of the sector starting at location 'lma' you should therefore see all f's. The memory location 0x8000000 is the start or origin of the flash memory contents and is specified in the olimex_stm32-e407_devboard.ld linker script. The flash memory locations is specific to the processor.</p>
<pre><code class="no-highlight">        (gdb) monitor flash erase_sector 0 0 4
        erased sectors 0 through 4 on flash bank 0 in 2.296712s
        (gdb) monitor mdw 0x08000000 16
        0x08000000: ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff 
        (0x08000020: ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff 
        (0x08000000: ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff 
        (0x08000020: ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff         
        (gdb) monitor flash info 0
</code></pre>
                        
                    </div>
                </div>
            
            <div class="row">    
                <footer>
    <div class="row">
        <div class="col-md-12">
            
                <p class="copyright">Copyright &copy; 2015 The Apache Software Foundation, Licensed under the Apache License, Version 2.0 Apache and the Apache feather logo are trademarks of The Apache Software Foundation.<br>The Apache Software Foundation Apache Incubator</p>
            
        </div>
    </div>
    <div class="copyright-logos">
        <div class="row">
            <div class="col-xs-6 text-right">
                <img src="/img/apache-feather.png" alt="Apache" title="Apache">
            </div>
            <div class="col-xs-6 text-left">
                <img src="/img/apache-logo.png" alt="Apache Incubator" title="Apache Incubator">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <small class="footnote">
                MyNewt is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
            </small>
        </div>
    </div>
</footer>
            </div>
        </div>

        <script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script>
        <script src="../../../js/base.js"></script>
        <script src="../../../js/custom.js"></script>

    </body>
</html>