## Blinky on STM32F303 board

### Objective

Download a generic firmware skeleton ("bootstrap image") that applies to any hardware and then throw in additional applicable pkgs to generate a build for a specific board, namely the STM32F303VC MCU from STMicroelectronics.

#### Hardware needed

* Discovery kit with STM32F303VC MCU
* Laptop running Mac OS


#### Step by Step Instructions to build image

* The first step is to download the generic skeleton of the project. The pkgs constituting the skeleton are not hardware architecture specific. The skeleton is maintained as an app in a separate repository on Apache. You know it is an app because there is an app.yml file. 

```no-highlight
        [user:~/dev]$ newt app create test_project
        Downloading app skeleton from https://git-wip-us.apache.org/repos/asf/incubator-mynewt-tadpole.git... ok!
        app test_project successfully created in ~/dev/go/test_project
    
        [user:~/dev]$ cd test_project/
        [user:~/dev/test_project]$ ls
        README.md	compiler	hw		libs	app.yml
```

* Next, the pkg-list named larva is added from the app (also named larva) from another repository on Apache. This step simply downloads the pkg-list description file and does not actually install the pkgs that constitute the pkg-list. The pkg-list description file (`pkg-list.yml`) will be used to check dependencies during the pkg install to ensure completeness. It serves as a reference for all the pkgs in the pkg-list that one can choose from and install.
```no-highlight
        [user:~/dev/test_project]$ newt app add-pkg-list larva https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva.git
        Downloading pkg-list.yml from https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva.git/master... ok!
        Verifying pkg-list.yml format...
        ok!
        pkg-list larva successfully installed to app.
```

* The next step is to install relevant pkgs from the larvan app from git server on Apache. The instructions assume that you know what application or project you are interested in (the blinky application, in this case), what hardware you are using (STM32F3DISCOVERY board, in this case) and hence, what board support package you need. 

```no-highlight

        [user:~/dev/test_project]$ newt pkg install project/blinky          
        Downloading larva from https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva/master... ok!
        Installing project/blinky
        Installing libs/console/full
        Installing libs/shell
        Installation was a success!
    
        [user:~/dev/test_project]$ newt pkg install hw/bsp/stm32f3discovery
        Downloading larva from https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva/master... ok!
        Installing hw/bsp/stm32f3discovery
        Installing hw/mcu/stm/stm32f3xx
        Installing libs/cmsis-core
        Installing compiler/arm-none-eabi-m4
        Installation was a success!
```

* It's time to create a targets for the project and define the target attributes. STM32F3 BSP expects bootloader, so create targets for both blinky and bootloader.
```no-highlight
        [user:~/dev/test_project]$ newt target create blink_f3disc
        Creating target blink_f3disc
        Target blink_f3disc successfully created!

        [user:~/dev/test_project]$ newt target set blink_f3disc project=blinky
        Target blink_f3disc successfully set project to blinky

        [user:~/dev/test_project]$ newt target set blink_f3disc bsp=hw/bsp/stm32f3discovery
        Target blink_f3disc successfully set bsp to hw/bsp/stm32f3discovery

        [user:~/dev/test_project]$ newt target set blink_f3disc compiler_def=debug
        Target blink_f3disc successfully set compiler_def to debug

        [user:~/dev/test_project]$ newt target set blink_f3disc compiler=arm-none-eabi-m4
        Target blink_f3disc successfully set compiler to arm-none-eabi-m4
        
        [user:~/dev/test_project]$ newt target set blink_f3disc arch=cortex_m4
        Target blink_f3disc successfully set arch to cortex_m4
        
        [user:~/dev/test_project]$ newt target create boot_f3disc
        Creating target boot_f3disc
        Target boot_f3disc successfully created!

        [user:~/dev/test_project]$ newt target set boot_f3disc project=boot
        Target blink_f3disc successfully set project to blinky

        [user:~/dev/test_project]$ newt target set boot_f3disc bsp=hw/bsp/stm32f3discovery
        Target boot_f3disc successfully set bsp to hw/bsp/stm32f3discovery

        [user:~/dev/test_project]$ newt target set boot_f3disc compiler_def=optimized
        Target boot_f3disc successfully set compiler_def to debug

        [user:~/dev/test_project]$ newt target set boot_f3disc compiler=arm-none-eabi-m4
        Target boot_f3disc successfully set compiler to arm-none-eabi-m4
        
        [user:~/dev/test_project]$ newt target set boot_f3disc arch=cortex_m4
        Target boot_f3disc successfully set arch to cortex_m4

        [user:~/dev/test_project]$ newt target show blink_f3disc
        blink_f3disc
	        arch=cortex_m4
	        bsp=hw/bsp/stm32f3discovery
	        compiler=arm-none-eabi-m4
	        compiler_def=debug
	        name=blink_f3disc
	        project=blinky

        [user:~/dev/test_project]$ newt target show boot_f3disc
        boot_f3disc
	        arch=cortex_m4
	        bsp=hw/bsp/stm32f3discovery
	        compiler=arm-none-eabi-m4
	        compiler_def=debug
	        name=blink_f3disc
	        project=boot

```

* STM32F3 blinky project is too large to operate with newlib libc. You need to modify project/blinky/pkg.yml, and switch over to using baselibc.

```no-highlight
        [user:~/dev/test_project]$ cat project/blinky/pkg.yml 
        #
        # Licensed to the Apache Software Foundation (ASF) under one
        # or more contributor license agreements.  See the NOTICE file
        # distributed with this work for additional information
        # regarding copyright ownership.  The ASF licenses this file
        # to you under the Apache License, Version 2.0 (the
        # "License"); you may not use this file except in compliance
        # with the License.  You may obtain a copy of the License at
        #
        #  http://www.apache.org/licenses/LICENSE-2.0
        #
        # Unless required by applicable law or agreed to in writing,
        # software distributed under the License is distributed on an
        # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        # KIND, either express or implied.  See the License for the
        # specific language governing permissions and limitations
        # under the License.
        #

        pkg.name: project/blinky
        pkg.vers: 0.8.0
        pkg.description: Basic example application which blinks an LED.
        pkg.author: Marko Kiiskila <marko@runtime.io>
        pkg.homepage: http://mynewt.apache.org/os/get_acclimated/project2/
        pkg.repository: https://git-wip-us.apache.org/repos/asf/incubator-mynewt-larva
        pkg.keywords:

        pkg.deps:
            - libs/console/full
            - libs/newtmgr
            - libs/os
            - libs/shell
            - sys/config
            - sys/log
            - sys/stats
            - libs/baselibc
```

* Next, you get to build the targets and generate an executable that can then be uploaded to the board. The STM32F3DISCOVERY board includes an ST-LINK/V2 embedded debug tool interface that will be used to program/debug the board. To program the MCU on the board, simply plug in the two jumpers on CN4, as shown in the picture in red. If you want to learn more about the board you will find the User Manual at [http://www.st.com/st-web-ui/static/active/jp/resource/technical/document/user_manual/DM00063382.pdf](http://www.st.com/st-web-ui/static/active/jp/resource/technical/document/user_manual/DM00063382.pdf)

* ![STMdiscovery](pics/STM32f3discovery_connector.png)

```no-highlight  
        [user:~/dev/test_project]$ newt target build boot_f3disc
        Building target boot_f3 (project = boot)
        Compiling asprintf.c
        Compiling atoi.c
        Compiling atol.c
        Compiling atoll.c
        Compiling bsearch.c
        Compiling bzero.c
        Compiling calloc.c
        Compiling fgets.c
        Compiling inline.c
        Compiling jrand48.c
        Compiling lrand48.c
        Compiling malloc.c
        Compiling memccpy.c
        Compiling memchr.c
        Compiling memcmp.c
        Compiling memcpy.c
        Compiling memfile.c
        Compiling memmem.c
        Compiling memmove.c
        Compiling memrchr.c
        Compiling memset.c
        Compiling memswap.c
        Compiling mrand48.c
        Compiling mynewt.c
        Compiling nrand48.c
        Compiling qsort.c
        Compiling realloc.c
        Compiling sprintf.c
        Compiling srand48.c
        Compiling sscanf.c
        Compiling strcasecmp.c
        Compiling strcat.c
        Compiling strchr.c
        Compiling strcmp.c
        Compiling strcpy.c
        Compiling strcspn.c
        Compiling strdup.c
        Compiling strlcat.c
        Compiling strlcpy.c
        Compiling strlen.c
        Compiling strncasecmp.c
        Compiling strncat.c
        Compiling strncmp.c
        Compiling strncpy.c
        Compiling strndup.c
        Compiling strnlen.c
        Compiling strntoimax.c
        Compiling strntoumax.c
        Compiling strpbrk.c
        Compiling strrchr.c
        Compiling strsep.c
        Compiling strspn.c
        Compiling strstr.c
        Compiling strtoimax.c
        Compiling strtok.c
        Compiling strtok_r.c
        Compiling strtol.c
        Compiling strtoll.c
        Compiling strtoul.c
        Compiling strtoull.c
        Compiling strtoumax.c
        Compiling tinyprintf.c
        Compiling vasprintf.c
        Compiling vprintf.c
        Compiling vsprintf.c
        Compiling vsscanf.c
        Archiving libbaselibc.a
        Compiling fs_cli.c
        Compiling fs_dirent.c
        Compiling fs_file.c
        Compiling fs_mkdir.c
        Compiling fs_mount.c
        Compiling fsutil.c
        Archiving libfs.a
        Compiling case.c
        Compiling suite.c
        Compiling testutil.c
        Compiling testutil_arch_arm.c
        Archiving libtestutil.a
        Compiling os.c
        Compiling os_callout.c
        Compiling os_eventq.c
        Compiling os_heap.c
        Compiling os_mbuf.c
        Compiling os_mempool.c
        Compiling os_mutex.c
        Compiling os_sanity.c
        Compiling os_sched.c
        Compiling os_sem.c
        Compiling os_task.c
        Compiling os_time.c
        Compiling os_arch_arm.c
        Compiling os_fault.c
        Assembling HAL_CM4.s
        Assembling SVC_Table.s
        Archiving libos.a
        Compiling flash_map.c
        Compiling hal_flash.c
        Archiving libhal.a
        Compiling base64.c
        Compiling cbmem.c
        Compiling datetime.c
        Compiling tpq.c
        Archiving libutil.a
        Compiling log.c
        Compiling log_cbmem.c
        Compiling log_console.c
        Compiling log_nmgr.c
        Compiling log_shell.c
        Archiving liblog.a
        Compiling crc16.c
        Compiling nffs.c
        Compiling nffs_area.c
        Compiling nffs_block.c
        Compiling nffs_cache.c
        Compiling nffs_config.c
        Compiling nffs_crc.c
        Compiling nffs_dir.c
        Compiling nffs_file.c
        Compiling nffs_flash.c
        Compiling nffs_format.c
        Compiling nffs_gc.c
        Compiling nffs_hash.c
        Compiling nffs_inode.c
        Compiling nffs_misc.c
        Compiling nffs_path.c
        Compiling nffs_restore.c
        Compiling nffs_write.c
        Archiving libnffs.a
        Compiling aes.c
        Compiling aesni.c
        Compiling arc4.c
        Compiling asn1parse.c
        Compiling asn1write.c
        Compiling base64.c
        Compiling bignum.c
        Compiling blowfish.c
        Compiling camellia.c
        Compiling ccm.c
        Compiling certs.c
        Compiling cipher.c
        Compiling cipher_wrap.c
        Compiling ctr_drbg.c
        Compiling debug.c
        Compiling des.c
        Compiling dhm.c
        Compiling ecdh.c
        Compiling ecdsa.c
        Compiling ecjpake.c
        Compiling ecp.c
        Compiling ecp_curves.c
        Compiling entropy.c
        Compiling entropy_poll.c
        Compiling error.c
        Compiling gcm.c
        Compiling havege.c
        Compiling hmac_drbg.c
        Compiling md.c
        Compiling md2.c
        Compiling md4.c
        Compiling md5.c
        Compiling md_wrap.c
        Compiling memory_buffer_alloc.c
        Compiling net.c
        Compiling oid.c
        Compiling padlock.c
        Compiling pem.c
        Compiling pk.c
        Compiling pk_wrap.c
        Compiling pkcs11.c
        Compiling pkcs12.c
        Compiling pkcs5.c
        Compiling pkparse.c
        Compiling pkwrite.c
        Compiling platform.c
        Compiling ripemd160.c
        Compiling rsa.c
        Compiling sha1.c
        Compiling sha256.c
        Compiling sha512.c
        Compiling ssl_cache.c
        Compiling ssl_ciphersuites.c
        Compiling ssl_cli.c
        Compiling ssl_cookie.c
        Compiling ssl_srv.c
        Compiling ssl_ticket.c
        Compiling ssl_tls.c
        Compiling threading.c
        Compiling timing.c
        Compiling version.c
        Compiling version_features.c
        Compiling x509.c
        Compiling x509_create.c
        Compiling x509_crl.c
        Compiling x509_crt.c
        Compiling x509_csr.c
        Compiling x509write_crt.c
        Compiling x509write_csr.c
        Compiling xtea.c
        Archiving libmbedtls.a
        Compiling bootutil_misc.c
        Compiling image_validate.c
        Compiling loader.c
        Archiving libbootutil.a
        Compiling cmsis_nvic.c
        Archiving libcmsis-core.a
        Compiling hal_flash.c
        Compiling hal_gpio.c
        Compiling hal_system.c
        Compiling hal_system_start.c
        Compiling hal_uart.c
        Compiling stm32f30x_adc.c
        Compiling stm32f30x_can.c
        Compiling stm32f30x_comp.c
        Compiling stm32f30x_crc.c
        Compiling stm32f30x_dac.c
        Compiling stm32f30x_dbgmcu.c
        Compiling stm32f30x_dma.c
        Compiling stm32f30x_exti.c
        Compiling stm32f30x_flash.c
        Compiling stm32f30x_fmc.c
        Compiling stm32f30x_gpio.c
        Compiling stm32f30x_hrtim.c
        Compiling stm32f30x_i2c.c
        Compiling stm32f30x_iwdg.c
        Compiling stm32f30x_misc.c
        Compiling stm32f30x_opamp.c
        Compiling stm32f30x_pwr.c
        Compiling stm32f30x_rcc.c
        Compiling stm32f30x_rtc.c
        Compiling stm32f30x_spi.c
        Compiling stm32f30x_syscfg.c
        Compiling stm32f30x_tim.c
        Compiling stm32f30x_usart.c
        Compiling stm32f30x_wwdg.c
        Archiving libstm32f3xx.a
        Compiling hal_bsp.c
        Compiling libc_stubs.c
        Compiling os_bsp.c
        Compiling sbrk.c
        Compiling system_stm32f30x.c
        Assembling startup_stm32f303xc.s
        Archiving libstm32f3discovery.a
        Compiling boot.c
        Building project boot
        Linking boot.elf
        Successfully run!

        [user:~/dev/test_project]$ newt target build blink_f3disc
        Building target blink_f3disc (project = blinky)
        Compiling asprintf.c
        Compiling atoi.c
        Compiling atol.c
        Compiling atoll.c
        Compiling bsearch.c
        Compiling bzero.c
        Compiling calloc.c
        Compiling fgets.c
        Compiling inline.c
        Compiling jrand48.c
        Compiling lrand48.c
        Compiling malloc.c
        Compiling memccpy.c
        Compiling memchr.c
        Compiling memcmp.c
        Compiling memcpy.c
        Compiling memfile.c
        Compiling memmem.c
        Compiling memmove.c
        Compiling memrchr.c
        Compiling memset.c
        Compiling memswap.c
        Compiling mrand48.c
        Compiling mynewt.c
        Compiling nrand48.c
        Compiling qsort.c
        Compiling realloc.c
        Compiling sprintf.c
        Compiling srand48.c
        Compiling sscanf.c
        Compiling strcasecmp.c
        Compiling strcat.c
        Compiling strchr.c
        Compiling strcmp.c
        Compiling strcpy.c
        Compiling strcspn.c
        Compiling strdup.c
        Compiling strlcat.c
        Compiling strlcpy.c
        Compiling strlen.c
        Compiling strncasecmp.c
        Compiling strncat.c
        Compiling strncmp.c
        Compiling strncpy.c
        Compiling strndup.c
        Compiling strnlen.c
        Compiling strntoimax.c
        Compiling strntoumax.c
        Compiling strpbrk.c
        Compiling strrchr.c
        Compiling strsep.c
        Compiling strspn.c
        Compiling strstr.c
        Compiling strtoimax.c
        Compiling strtok.c
        Compiling strtok_r.c
        Compiling strtol.c
        Compiling strtoll.c
        Compiling strtoul.c
        Compiling strtoull.c
        Compiling strtoumax.c
        Compiling tinyprintf.c
        Compiling vasprintf.c
        Compiling vprintf.c
        Compiling vsprintf.c
        Compiling vsscanf.c
        Archiving libbaselibc.a
        Compiling case.c
        Compiling suite.c
        Compiling testutil.c
        Compiling testutil_arch_arm.c
        Archiving libtestutil.a
        Compiling base64.c
        Compiling cbmem.c
        Compiling datetime.c
        Compiling tpq.c
        Archiving libutil.a
        Compiling shell.c
        Compiling shell_os.c
        Archiving libshell.a
        Compiling os.c
        Compiling os_callout.c
        Compiling os_eventq.c
        Compiling os_heap.c
        Compiling os_mbuf.c
        Compiling os_mempool.c
        Compiling os_mutex.c
        Compiling os_sanity.c
        Compiling os_sched.c
        Compiling os_sem.c
        Compiling os_task.c
        Compiling os_time.c
        Compiling os_arch_arm.c
        Compiling os_fault.c
        Assembling HAL_CM4.s
        Assembling SVC_Table.s
        Archiving libos.a
        Compiling flash_map.c
        Compiling hal_flash.c
        Archiving libhal.a
        Compiling cons_fmt.c
        Compiling cons_tty.c
        Archiving libfull.a
        Compiling json_decode.c
        Compiling json_encode.c
        Archiving libjson.a
        Compiling newtmgr.c
        Compiling newtmgr_os.c
        Archiving libnewtmgr.a
        Compiling config.c
        Compiling config_cli.c
        Compiling config_nmgr.c
        Archiving libconfig.a
        Compiling log.c
        Compiling log_cbmem.c
        Compiling log_console.c
        Compiling log_nmgr.c
        Compiling log_shell.c
        Archiving liblog.a
        Compiling stats.c
        Compiling stats_nmgr.c
        Compiling stats_shell.c
        Archiving libstats.a
        Compiling cmsis_nvic.c
        Archiving libcmsis-core.a
        Compiling hal_flash.c
        Compiling hal_gpio.c
        Compiling hal_system.c
        Compiling hal_system_start.c
        Compiling hal_uart.c
        Compiling stm32f30x_adc.c
        Compiling stm32f30x_can.c
        Compiling stm32f30x_comp.c
        Compiling stm32f30x_crc.c
        Compiling stm32f30x_dac.c
        Compiling stm32f30x_dbgmcu.c
        Compiling stm32f30x_dma.c
        Compiling stm32f30x_exti.c
        Compiling stm32f30x_flash.c
        Compiling stm32f30x_fmc.c
        Compiling stm32f30x_gpio.c
        Compiling stm32f30x_hrtim.c
        Compiling stm32f30x_i2c.c
        Compiling stm32f30x_iwdg.c
        Compiling stm32f30x_misc.c
        Compiling stm32f30x_opamp.c
        Compiling stm32f30x_pwr.c
        Compiling stm32f30x_rcc.c
        Compiling stm32f30x_rtc.c
        Compiling stm32f30x_spi.c
        Compiling stm32f30x_syscfg.c
        Compiling stm32f30x_tim.c
        Compiling stm32f30x_usart.c
        Compiling stm32f30x_wwdg.c
        Archiving libstm32f3xx.a
        Compiling hal_bsp.c
        Compiling libc_stubs.c
        Compiling os_bsp.c
        Compiling sbrk.c
        Compiling system_stm32f30x.c
        Assembling startup_stm32f303xc.s
        Archiving libstm32f3discovery.a
        Compiling main.c
        Building project blinky
        Linking blinky.elf
        Successfully run!

        [user:~/dev/test_project]$ newt target build boot_f3disc
        Building target boot_f3disc (project = boot)
        Building project boot
        Successfully run!

        [user:~/dev/test_project]$ newt target create-image blink_f3disc 0.0.1
        Building target blink_f3disc (project = blinky)
        Building project blinky

```

* Finally, you have to download the image on to the board. You will see a blue light start to blink.
```no-highlight
        [user:~/dev/test_project]$ newt target download boot_f3disc
        Downloading with /Users/user/dev/test_project/hw/bsp/stm32f3discovery/stm32f3discovery_download.sh

        [user:~/dev/test_project]$ newt target download blink_f3disc
        Downloading with /Users/user/dev/test_project/hw/bsp/stm32f3discovery/stm32f3discovery_download.sh
```
 
