<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <!-- This is broken by doc revisioning.
        <link rel="canonical" href="http://mynewt.apache.org/os/tutorials/unit_test/"> -->
        <link rel="shortcut icon" href="../../../img/favicon.ico">

	    <title>Write a Test Suite for a Package - Apache Mynewt</title>

        <link href="../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <link href="../../../css/base.css" rel="stylesheet">
        <link href="../../../css/custom.css" rel="stylesheet">
        <link href="../../../css/v2.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'auto');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Write a Test Suite for a Package">


        <div class="container">
    <div class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
                <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.0.0</a> released (March 22, 2017)
            </div>
        </div>
    </div>
</div>

        






<nav id="navbar" class="navbar navbar-inverse affix-top" data-spy="affix" data-offset-top="150" role="navigation">
    <div class="container">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li 
  class=""
>
                    <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                </li>
                <li 
  class="important"
>
                    <a href="/quick-start/">Quick Start</a>
                </li>
                <li 
  class=""
>
                    <a href="/about/">About</a>
                </li>
                <li 
  class=""
>
                    <a href="/talks/">Talks</a>
                </li>
                <li 
  class="active"
>
                    <a href="/latest/os/introduction">Documentation</a>
                </li>
                <li 
  class=""
>
                    <a href="/download/">Download</a>
                </li>
                <li 
  class=""
>
                    <a href="/community/">Community</a>
                </li>
                <li 
  class=""
>
                    <a href="/events/">Events</a>
                </li>
            </ul>

        </div>
    </div>
</nav>

        

        <div class="container">
            
                <div class="row">
                    <div class="col-md-3 v2-sidebar sidebar-container"><div id="docSidebar" class="hidden-print" role="complementary">
    <div class="top">
        <div role="search">
            <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" class="form-control" placeholder="Search documentation" />
                </div>
            </form>
        </div>
    </div>
    <ul class="toc-nav">
      <li class="doc-version">
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
    
    <option
      value="/develop/os/introduction"
      selected="selected"
    >
      Version: develop (latest)
    </option>
    
    <option
      value="/v0_9_0/os/introduction"
      
    >
      Version: 0.9.0
    </option>
    
    <option
      value="/v1_0_0/os/introduction"
      
    >
      Version: 1.0.0
    </option>
    
</select>
</li>
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  
    <li ><a href="../../introduction/">Mynewt Documentation</a>
  
  
    <ul>
          
              
          
              
                
  
  
    <li ><a href="../../get_started/get_started/">Basic Setup</a>
  
  
    </li>

              
          
              
                
    <li >
      <a href="../../get_started/vocabulary/">Concepts</a>
    </li>

              
          
              
                
  
  
    <li ><a href="../tutorials/">Tutorials</a>
  
  
    <ul>
          
              
          
              
                
  
  
    <li ><a href="../blinky/">Project Blinky</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../repo/add_repos/">Work with repositories</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../project-slinky/">Project Slinky for Remote Comms</a>
  
  
    </li>

              
          
              
                
    <li >
      <a href="../ota_upgrade_nrf52/">Upgrade an Image Over-The-Air</a>
    </li>

              
          
              
                
    <li >
      <a href="../ibeacon/">BLE iBeacon</a>
    </li>

              
          
              
                
    <li >
      <a href="../eddystone/">BLE Eddystone</a>
    </li>

              
          
              
                
    <li >
      <a href="../add_newtmgr/">Enable Newt Manager in any app</a>
    </li>

              
          
              
                
    <li >
      <a href="../add_shell/">Enable the OS Shell and Console</a>
    </li>

              
          
              
                
    <li >
      <a href="../codesize/">How to Reduce Application Code Size</a>
    </li>

              
          
              
                
    <li >
      <a href="../tasks_lesson/">Tasks and Priority Management</a>
    </li>

              
          
              
                
    <li >
      <a href="../wi-fi_on_arduino/">Enable Wi-Fi on Arduino MKR1000</a>
    </li>

              
          
              
                
    <li class="active">
      <a href="./">Write a Test Suite for a Package</a>
    </li>

              
          
              
                
    <li >
      <a href="../event_queue/">Events and Event Queues</a>
    </li>

              
          
              
                
    <li >
      <a href="../bletiny_project/">BLE app to check stats via console</a>
    </li>

              
          
              
                
  
  
    <li ><a href="../bleprph/bleprph-intro/">BLE peripheral project</a>
  
  
    </li>

              
          
              
                
    <li >
      <a href="../blehci_project/">BLE HCI interface</a>
    </li>

              
          
              
                
  
  
    <li><a href="
  ../air_quality_sensor/
">Air-quality Sensor project</a>
  
  
    </li>

              
          
              
                
    <li >
      <a href="../nrf52_adc/">Add an Analog Sensor</a>
    </li>

              
          
    </ul>
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../os_user_guide/">OS User Guide</a>
  
  
    </li>

              
          
              
                
  
  
    <li><a href="
  ../../../network/ble/ble_intro/
">BLE User Guide</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../newt/newt_intro/">Newt Tool Guide</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../newtmgr/overview/">Newt Manager Guide</a>
  
  
    </li>

              
          
    </ul>
  
    </li>

        
      
        
          
  
  
    <li><a href="
  ../../../faq/go_env/
">Appendix</a>
  
  
    </li>

        
      
    </ul>
</div></div>

                    <div class="col-md-9" role="main">
                        <div class="doc-header">
                            <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="/latest/os/introduction">Docs</a></li>
    
    
        
          <li>&raquo; <a href="../../introduction/">Mynewt Documentation</a></li>
        
      
        
          <li>&raquo; <a href="../tutorials/">Tutorials</a></li>
        
      
      
        <li>&raquo; Write a Test Suite for a Package</li>
      
    
    
      <li class="wy-breadcrumbs-aside">
        
          <a href="https://github.com/apache/incubator-mynewt-site/blob/develop/docs/os/tutorials/unit_test.md"
            class="icon icon-github"> Edit on GitHub</a>
        
      </li>
    
  </ul>
</div>
                        </div>
                        
                        
                            <h1 id="write-a-test-suite-for-a-package">Write a Test Suite for a Package</h1>
<p>This document guides the reader through creating a test suite for a Mynewt package.</p>
<h2 id="introduction">Introduction</h2>
<p>Writing a test suite involves using the
<a href="../../modules/testutil/testutil/"><code>test/testutil</code></a> package.  The testutil
library provides the functionality needed to define test suites and test cases.</p>
<h2 id="choose-your-package-under-test">Choose Your Package Under Test</h2>
<p>Choose the package you want to write a test suite for.  In this tutorial, we
will use the <code>time/datetime</code> in the apache-mynewt-core repo.  Throughout this
tutorial, we will be inside the apache-mynewt-core repo directory, unlike most
tutorials which operate from the top-level project directory.</p>
<h2 id="create-a-test-package">Create A Test Package</h2>
<p>Typically, a library has only one test package.  The convention is name the
test package by appending <code>/test</code> to the host library name.  For example, the
test package for <code>encoding/json</code> is <code>encoding/json/test</code>.  The directory
structure of the json package is shown below:</p>
<pre class="codehilite"><code class="language-c">encoding/json
├── include
│   └── json
│       └── json.h
├── pkg.yml
├── src
│   ├── json_decode.c
│   └── json_encode.c
└── test
    ├── pkg.yml
    └── src
        ├── test_json.c
        ├── test_json.h
        ├── test_json_utils.c
        └── testcases
            ├── json_simple_decode.c
            └── json_simple_encode.c</code></pre>


<p>The top-level <code>test</code> directory contains the json test package.  To create a
test package for the datetime package, we need to create a similar package
called <code>time/datetime/test</code>.</p>
<pre class="codehilite"><code>$ newt pkg new time/datetime/test -t unittest
Download package template for package type pkg.
Package successfuly installed into /home/me/mynewt-core/time/datetime/test.</code></pre>


<p>We now have a test package inside <code>time/datetime</code>:</p>
<pre class="codehilite"><code>time/datetime
├── include
│   └── datetime
│       └── datetime.h
├── pkg.yml
├── src
│   └── datetime.c
└── test
    ├── README.md
    ├── pkg.yml
    ├── src
    │   └── main.c
    └── syscfg.yml</code></pre>


<p>There is one modification we need to make to the new package before we can
start writing unit test code.  A test package needs access to the code it will
be testing, so we need to add a dependency on
<code>@apache-mynewt-core/time/datetime</code> to our <code>pkg.yml</code> file:</p>
<pre class="codehilite"><code>pkg.name: &quot;time/datetime/test&quot;
pkg.type: unittest
pkg.description: &quot;Description of your package&quot;
pkg.author: &quot;You &lt;you@you.org&gt;&quot;
pkg.homepage: &quot;http://your-url.org/&quot;
pkg.keywords:

pkg.deps:
    - '@apache-mynewt-core/test/testutil'
    - '@apache-mynewt-core/time/datetime'

pkg.deps.SELFTEST:
    - '@apache-mynewt-core/sys/console/stub'</code></pre>


<p>While we have the <code>pkg.yml</code> file open, let's take a look at what newt filled in automatically:</p>
<ul>
<li><code>pkg.type: unittest</code> designates this as a test package.  A <em>test package</em> is
  special in that it can be built and executed using the <code>newt test</code> command.</li>
<li>A test package always depends on <code>@apache-mynewt-core/test/testutil</code>.  The
  testutil library provides the tools necessary for verifying package behavior, </li>
<li>The <code>SELFTEST</code> suffix indicates that a setting should only be applied when the <code>newt test</code> command is used.</li>
</ul>
<p>Regarding the conditional dependency on <code>sys/console/stub</code>, the datetime
package requires some form of console to function.  In a regular application,
the console dependency would be supplied by a higher order package.  Because
<code>newt test</code> runs the test package without an application present, the test
package needs to supply all unresolved dependencies itself when run in
self-test mode.</p>
<h2 id="create-your-test-suite-code">Create Your Test Suite Code</h2>
<p>We will be adding a <em>test suite</em> to the <code>main.c</code> file.  The test suite will be empty for now.  We also need to invoke the test suite from <code>main()</code>.</p>
<p>Our <code>main.c</code> file now looks like this:</p>
<pre class="codehilite"><code class="language-c">#include &quot;sysinit/sysinit.h&quot;
#include &quot;testutil/testutil.h&quot;

TEST_SUITE(test_datetime_suite) {
    /* Empty for now; add test cases later. */
}

#if MYNEWT_VAL(SELFTEST)
int
main(int argc, char **argv)
{
    /* Initialize all packages. */
    sysinit();

    test_datetime_suite();

    /* Indicate whether all test cases passed. */
    return tu_any_failed;
}
#endif</code></pre>


<h2 id="try-it-out">Try It Out</h2>
<p>We now have a working test suite with no tests.  Let's make sure we get a passing result when we run <code>newt test</code>:</p>
<pre class="codehilite"><code>$ newt test time/datetime
&lt;build output&gt;
Executing test: /home/me/mynewt-core/bin/targets/unittest/time_datetime_test/app/time/datetime/test/time_datetime_test.elf
Passed tests: [time/datetime/test]
All tests passed</code></pre>


<h2 id="create-a-test">Create a Test</h2>
<p>To create a test within your test suite, there are two things to do.</p>
<ol>
<li>Implement the test case function using the <code>testutil</code> macros.</li>
<li>Call the test case function from within the test suite.</li>
</ol>
<p>For this tutorial we will create a test case to verify the <code>datetime_parse()</code>
function.  The <code>datetime_parse()</code> function is declared as follows:</p>
<pre class="codehilite"><code class="language-c">/**
 * Parses an RFC 3339 datetime string.  Some examples of valid datetime strings
 * are:
 * 2016-03-02T22:44:00                  UTC time (implicit)
 * 2016-03-02T22:44:00Z                 UTC time (explicit)
 * 2016-03-02T22:44:00-08:00            PST timezone
 * 2016-03-02T22:44:00.1                fractional seconds
 * 2016-03-02T22:44:00.101+05:30        fractional seconds with timezone
 *
 * On success, the two output parameters are filled in (tv and tz).
 *
 * @return                      0 on success;
 *                              nonzero on parse error.
 */
int
datetime_parse(const char *input, struct os_timeval *tv, struct os_timezone *tz)</code></pre>


<p>Our test case should make sure this function rejects invalid input, and that it
parses valid input correctly.  The updated <code>main.c</code> file looks like this:</p>
<pre class="codehilite"><code class="language-c">#include &quot;sysinit/sysinit.h&quot;
#include &quot;testutil/testutil.h&quot;
#include &quot;os/os_time.h&quot;
#include &quot;datetime/datetime.h&quot;

TEST_SUITE(test_datetime_suite)
{
    test_datetime_parse_simple();
}

TEST_CASE(test_datetime_parse_simple)
{
    struct os_timezone tz;
    struct os_timeval tv;
    int rc;

    /*** Valid input. */

    /* No timezone; UTC implied. */
    rc = datetime_parse(&quot;2017-06-28T22:37:59&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT_FATAL(rc == 0);
    TEST_ASSERT(tv.tv_sec == 1498689479);
    TEST_ASSERT(tv.tv_usec == 0);
    TEST_ASSERT(tz.tz_minuteswest == 0);
    TEST_ASSERT(tz.tz_dsttime == 0);

    /* PDT timezone. */
    rc = datetime_parse(&quot;2013-12-05T02:43:07-07:00&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT_FATAL(rc == 0);
    TEST_ASSERT(tv.tv_sec == 1386236587);
    TEST_ASSERT(tv.tv_usec == 0);
    TEST_ASSERT(tz.tz_minuteswest == 420);
    TEST_ASSERT(tz.tz_dsttime == 0);

    /*** Invalid input. */

    /* Nonsense. */
    rc = datetime_parse(&quot;abc&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT(rc != 0);

    /* Date-only. */
    rc = datetime_parse(&quot;2017-01-02&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT(rc != 0);

    /* Zero month. */
    rc = datetime_parse(&quot;2017-00-28T22:37:59&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT(rc != 0);

    /* 13 month. */
    rc = datetime_parse(&quot;2017-13-28T22:37:59&quot;, &amp;tv, &amp;tz);
    TEST_ASSERT(rc != 0);
}

#if MYNEWT_VAL(SELFTEST)
int
main(int argc, char **argv)
{
    /* Initialize all packages. */
    sysinit();

    test_datetime_suite();

    /* Indicate whether all test cases passed. */
    return tu_any_failed;
}
#endif</code></pre>


<p>Take a few minutes to review the above code.  Then keep reading for some
specifics.</p>
<h3 id="asserting">Asserting</h3>
<p>The <code>test/testutil</code> package provides two tools for verifying the correctness of a package:</p>
<ul>
<li><code>TEST_ASSERT</code></li>
<li><code>TEST_ASSERT_FATAL</code></li>
</ul>
<p>Both of these macros check if the supplied condition is true.  They differ in
how they behave when the condition is not true.  On failure, <code>TEST_ASSERT</code>
reports the error and proceeds with the remainder of the test case.
<code>TEST_ASSERT_FATAL</code>, on the other hand, aborts the test case on failure.</p>
<p>The general rule is to only use <code>TEST_ASSERT_FATAL</code> when subsequent assertions
depend on the condition being checked.  For example, when <code>datetime_parse()</code> is
expected to succeed, the return code is checked with <code>TEST_ASSERT_FATAL</code>.  If
<code>datetime_parse()</code> unexpectedly failed, the contents of the <code>tv</code> and <code>tz</code>
objects would be indeterminate, so it is desirable to abort the test instead of
checking them and reporting spurious failures.</p>
<h3 id="scaling-up">Scaling Up</h3>
<p>The above example is small and self contained, so it is reasonable to put
everything in a single C file.  A typical package will need a lot more test
code, and it helps to follow some conventions to maintain organization.  Let's
take a look at a more realistic example.  Here is the directory structure of
the <code>fs/nffs/test</code> package:</p>
<pre class="codehilite"><code>fs/nffs/test
├── pkg.yml
└── src
    ├── nffs_test.c
    ├── nffs_test.h
    ├── nffs_test_debug.c
    ├── nffs_test_priv.h
    ├── nffs_test_system_01.c
    ├── nffs_test_utils.c
    ├── nffs_test_utils.h
    └── testcases
        ├── append_test.c
        ├── cache_large_file_test.c
        ├── corrupt_block_test.c
        ├── corrupt_scratch_test.c
        ├── gc_on_oom_test.c
        ├── gc_test.c
        ├── incomplete_block_test.c
        ├── large_system_test.c
        ├── large_unlink_test.c
        ├── large_write_test.c
        ├── long_filename_test.c
        ├── lost_found_test.c
        ├── many_children_test.c
        ├── mkdir_test.c
        ├── open_test.c
        ├── overwrite_many_test.c
        ├── overwrite_one_test.c
        ├── overwrite_three_test.c
        ├── overwrite_two_test.c
        ├── read_test.c
        ├── readdir_test.c
        ├── rename_test.c
        ├── split_file_test.c
        ├── truncate_test.c
        ├── unlink_test.c
        └── wear_level_test.c</code></pre>


<p>The <code>fs/nffs/test</code> package follows these conventions:</p>
<ol>
<li>A maximum of one test case per C file.</li>
<li>Each test case file goes in the <code>testcases</code> subdirectory.</li>
<li>Test suites and utility functions go directly in the <code>src</code> directory.</li>
</ol>
<p>Test packages contributed to the Mynewt project should follow these conventions.</p>
<h2 id="congratulations">Congratulations</h2>
<p>Now you can begin the work of validating your packages.</p>
                        
                        <div class="row">
                            



<ul class="nav nav-pills" style="margin-bottom: 10px">
    <li>
    
    <a href=../wi-fi_on_arduino/>
        <span class="fa fa-arrow-left"></span>
        Previous: Enable Wi-Fi on Arduino MKR1000
    </a>
    
    </li>
    <li class="pull-right">
    
    <a href=../event_queue/>
        Next: Events and Event Queues
        <span class="fa fa-arrow-right"></span>
    </a>
    
    </li>
</ul>
                        </div>
                        <footer class="row">
    <div class="col-xs-12">
        
            <p class="copyright">Apache Mynewt is available under Apache License, version 2.0.</p>
        
    </div>
    <div class="col-xs-12">
        <div class="logos">
            <img src="/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
            <small class="footnote">
            Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt project logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and other countries.
            </small>
             <a href="https://join.slack.com/mynewt/shared_invite/MTkwMTg1ODM1NTg5LTE0OTYxNzQ4NzQtZTU1YmNhYjhkMg"><img src="https://www.countit.com/images/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" /></a>
        </div>
    </div>
</footer>
                    </div>
                </div>
            
            
        </div>

        <script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script>
        <script src="../../../js/base.js"></script>
        <script src="../../../js/custom.js"></script>

    </body>
</html>